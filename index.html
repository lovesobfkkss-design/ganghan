<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>í•™ì› ì—…ë¬´ ì²´í¬ë¦¬ìŠ¤íŠ¸ + ë‹¨ì–´ì‹œí—˜ ìŠ¤ì¼€ì¤„ëŸ¬</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .notification-badge {
      position: fixed; top: 20px; right: 20px;
      background: #ef4444; color: white; width: 50px; height: 50px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-weight: bold; font-size: 18px; cursor: pointer;
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4); z-index: 999; animation: pulse 2s infinite;
    }
    @keyframes pulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.1)} }
    .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; z-index:1100; }
    .modal-card { position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:#fff; width:96%; max-width:720px; border-radius:16px; box-shadow:0 20px 60px rgba(0,0,0,.2); padding:20px; display:none; z-index:1110; }

    /* ë‹¨ì–´ ìŠ¤ì¼€ì¤„ëŸ¬ ë‚´ë¶€ ë²„íŠ¼/ì…ë ¥ í”„ë¦¬ì…‹ */
    .btn{padding:.5rem .8rem;border-radius:.4rem;border:1px solid #e5e7eb;background:#0ea5e9;color:#fff}
    .btn-secondary{background:#f8fafc;color:#0f172a}
    .input{border:1px solid #e5e7eb;border-radius:.4rem;padding:.45rem .6rem}
    .pill{padding:.15rem .5rem;border-radius:9999px;background:#f1f5f9;font-size:.75rem}
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
  <!-- ì•Œë¦¼ ë°°ì§€ / íŒ¨ë„ -->
  <div id="notificationBadge" class="notification-badge" onclick="toggleNotification()" style="display:none;">
    <span id="notificationCount">0</span>
  </div>
  <div id="notificationPanel" style="display:none; position: fixed; top: 80px; right: 20px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); max-width: 420px; z-index: 1000;">
    <div style="display:flex; justify-content:space-between; margin-bottom: 15px;">
      <div style="font-weight:bold; font-size:1.25rem;">ğŸ”” ì•Œë¦¼</div>
      <button onclick="toggleNotification()" style="font-size:1.5rem; color:#6b7280; cursor:pointer; border:none; background:none;">âœ•</button>
    </div>
    <div id="notificationContent" class="text-sm leading-6"></div>
  </div>

  <!-- ì„¤ì • ëª¨ë‹¬ -->
  <div id="settingsBackdrop" class="modal-backdrop"></div>
  <div id="settingsModal" class="modal-card">
    <div class="flex items-center justify-between mb-3">
      <h3 class="text-xl font-bold">âš™ï¸ ê¸°ë³¸ ì²´í¬ë¦¬ìŠ¤íŠ¸ ì„¤ì •</h3>
      <button onclick="closeSettings()" class="text-gray-500 text-2xl leading-none">âœ•</button>
    </div>
    <p class="text-sm text-gray-600 mb-2">ì•„ë˜ í•­ëª©ë“¤ì€ <b>ë§¤ì¼ ìµœì´ˆ ë¡œë“œ ì‹œ ìë™ ìƒì„±</b>ë©ë‹ˆë‹¤. (ì¤„ë°”ê¿ˆ ê¸°ì¤€)</p>
    <textarea id="defaultTasksInput" class="w-full h-40 border rounded-lg p-3 mb-3" placeholder="ì˜ˆ)\nì²­ì†Œ ìƒíƒœ í™•ì¸\në‹¨ì–´ ë§Œë“¤ê¸°\nì˜¤ë‹¤ë¹„ ë³´ë‚´ê¸°\nìˆ™ì œ í™•ì¸"></textarea>
    <div class="flex items-center justify-between mb-1">
      <div class="text-sm text-gray-500">ë³€ê²½ í›„ <b>ì €ì¥</b>ì„ ëˆ„ë¥´ë©´ ë‹¤ìŒ ë‚ ì§œë¶€í„° ìƒˆ ëª©ë¡ì´ ì‹œë“œë©ë‹ˆë‹¤.</div>
      <div class="flex gap-2">
        <button onclick="resetToRecommended()" class="px-3 py-2 rounded bg-gray-100">ì¶”ì²œ ê¸°ë³¸ê°’</button>
        <button onclick="saveDefaultTasks()" class="px-4 py-2 rounded bg-indigo-600 text-white hover:bg-indigo-700">ì €ì¥</button>
      </div>
    </div>
  </div>

  <div class="max-w-5xl mx-auto">
    <!-- ë‚ ì§œ í—¤ë” -->
    <div class="bg-white rounded-2xl shadow-xl p-4 mb-4">
      <div class="flex items-center justify-between">
        <button onclick="changeDate(-1)" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">â† ì „ë‚ </button>
        <div class="text-center">
          <div class="text-xl font-bold" id="currentDate">ë¡œë”©ì¤‘...</div>
          <div id="dateInfo" class="text-sm font-bold text-green-600">ì˜¤ëŠ˜</div>
        </div>
        <div class="flex gap-2">
          <button onclick="openSettings()" class="px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-800">âš™ï¸ ì„¤ì •</button>
          <button onclick="goToToday()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">ì˜¤ëŠ˜</button>
          <button onclick="changeDate(1)" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">ë‹¤ìŒë‚  â†’</button>
        </div>
      </div>
    </div>

    <!-- ë©”ì¸ ì¹´ë“œ -->
    <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
      <div class="flex items-center justify-between mb-4">
        <div>
          <h1 class="text-3xl font-bold text-gray-800">í•™ì› ì—…ë¬´ ì²´í¬ë¦¬ìŠ¤íŠ¸</h1>
          <p class="text-xs text-green-600 mt-1">âœ… ì „ì²´ ì¡°êµ ê³µìœ  ëª¨ë“œ (ì‹¤ì‹œê°„ ë™ê¸°í™”)</p>
        </div>
        <div class="text-right">
          <div class="text-4xl font-bold text-indigo-600" id="completedCount">0/0</div>
          <div class="text-sm text-gray-600">ì™„ë£Œ</div>
        </div>
      </div>

      <div class="w-full bg-gray-200 rounded-full h-3 mb-6">
        <div id="progressBar" class="bg-indigo-600 h-3 rounded-full transition-all duration-300" style="width:0%"></div>
      </div>

      <div class="mb-4 grid grid-cols-1 md:grid-cols-3 gap-2">
        <input type="text" id="newTaskInput" placeholder="ìƒˆ ì²´í¬ë¦¬ìŠ¤íŠ¸ í•­ëª© ì¶”ê°€" class="border rounded-lg px-3 py-2">
        <input type="text" id="newTaskNoteInput" placeholder="(ì„ íƒ) ë©”ëª¨/ë‚´ìš©" class="border rounded-lg px-3 py-2">
        <button onclick="addNewTask()" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">+ ì¶”ê°€</button>
      </div>

      <div id="dailyTasksList" class="space-y-3">
        <div class="text-center text-gray-500 py-4">ë¡œë”©ì¤‘...</div>
      </div>
    </div>

    <!-- êµ­ì–´ ì½”ì¹­ -->
    <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">ğŸ“š êµ­ì–´ ì½”ì¹­ (<span id="koreanCount">0</span>ëª…)</h2>
      <div class="grid grid-cols-1 md:grid-cols-4 gap-2 mb-4">
        <input type="text" id="koreanName" placeholder="í•™ìƒ ì´ë¦„" class="border rounded-lg px-3 py-2">
        <input type="text" id="koreanScore" placeholder="ì ìˆ˜" class="border rounded-lg px-3 py-2">
        <select id="koreanAttendance" class="border rounded-lg px-3 py-2">
          <option>ì¶œì„</option><option>ê²°ì„</option><option>ì§€ê°</option>
        </select>
        <input type="text" id="koreanWrong" placeholder="í‹€ë¦° ë¬¸ì œ" class="border rounded-lg px-3 py-2">
      </div>
      <button onclick="addKorean()" class="w-full bg-indigo-600 text-white rounded-lg py-2 mb-4 hover:bg-indigo-700">+ í•™ìƒ ì¶”ê°€</button>
      <div id="koreanList" class="space-y-2"></div>
    </div>

    <!-- ì—­ì‚¬/ê³¼í•™ ê´€ë¦¬ë°˜ -->
    <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">ğŸ§­ ì—­ì‚¬/ê³¼í•™ ê´€ë¦¬ë°˜ (<span id="hsMgmtCount">0</span>ëª…)</h2>
      <div class="grid grid-cols-1 md:grid-cols-4 gap-2 mb-4">
        <select id="hsSubject" class="border rounded-lg px-3 py-2">
          <option value="ì—­ì‚¬">ì—­ì‚¬</option>
          <option value="ê³¼í•™">ê³¼í•™</option>
        </select>
        <input type="text" id="hsName" placeholder="í•™ìƒ ì´ë¦„" class="border rounded-lg px-3 py-2">
        <input type="text" id="hsScore" placeholder="ì ìˆ˜" class="border rounded-lg px-3 py-2">
        <input type="text" id="hsRange" placeholder="í•™ìŠµ ë²”ìœ„/ë©”ëª¨" class="border rounded-lg px-3 py-2">
      </div>
      <button onclick="addHsMgmt()" class="w-full bg-indigo-600 text-white rounded-lg py-2 mb-4 hover:bg-indigo-700">+ í•™ìƒ ì¶”ê°€</button>
      <div id="hsMgmtList" class="space-y-2"></div>
    </div>

    <!-- íƒ€ì´í•‘ -->
    <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">âŒ¨ï¸ íƒ€ì´í•‘ ì—…ë¬´ (<span id="typingCount">0</span>ê°œ)</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-4">
        <input type="text" id="typingTask" placeholder="ì—…ë¬´ ë‚´ìš©" class="border rounded-lg px-3 py-2">
        <input type="text" id="typingProgress" placeholder="ì™„ë£Œ ë²”ìœ„" class="border rounded-lg px-3 py-2">
      </div>
      <button onclick="addTyping()" class="w-full bg-indigo-600 text-white rounded-lg py-2 mb-4 hover:bg-indigo-700">+ ì—…ë¬´ ì¶”ê°€</button>
      <div id="typingList" class="space-y-2"></div>
    </div>

    <!-- ì¬ì‹œí—˜ (ë‹¨ì–´ì¥/ë²”ìœ„ í¬í•¨) -->
    <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">
        ğŸ“ ì¬ì‹œí—˜ ê´€ë¦¬ (<span id="retestCount">0</span>ëª…)
        <span id="todayRetestBadge" class="bg-red-500 text-white text-sm px-3 py-1 rounded-full ml-2" style="display:none;">ì˜¤ëŠ˜ 0ëª…</span>
      </h2>
      <div class="grid grid-cols-1 md:grid-cols-6 gap-2 mb-4">
        <input type="text" id="retestName" placeholder="í•™ìƒ ì´ë¦„" class="border rounded-lg px-3 py-2">
        <input type="text" id="retestSubject" placeholder="ê³¼ëª©" class="border rounded-lg px-3 py-2">
        <input type="text" id="retestVocabBook" placeholder="ë‹¨ì–´ì¥" class="border rounded-lg px-3 py-2">
        <input type="text" id="retestVocabRange" placeholder="ë‹¨ì–´ ë²”ìœ„ (ì˜ˆ: Day 11~15)" class="border rounded-lg px-3 py-2">
        <input type="date" id="retestDate" class="border rounded-lg px-3 py-2">
        <input type="time" id="retestTime" class="border rounded-lg px-3 py-2">
      </div>
      <button onclick="addRetest()" class="w-full bg-red-600 text-white rounded-lg py-2 mb-4 hover:bg-red-700">+ ì¬ì‹œí—˜ í•™ìƒ ì¶”ê°€</button>
      <div id="retestList"></div>
    </div>

    <!-- í´ë˜ìŠ¤ì¹´ë“œ í…ŒìŠ¤íŠ¸ -->
    <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">ğŸƒ í´ë˜ìŠ¤ì¹´ë“œ í…ŒìŠ¤íŠ¸</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mb-2">
        <textarea id="ccRosterInput" placeholder="ëª…ë‹¨: ì‰¼í‘œ(,) ë˜ëŠ” ì¤„ë°”ê¿ˆìœ¼ë¡œ í•™ìƒ ì—¬ëŸ¬ ëª… ì…ë ¥" class="border rounded-lg px-3 py-2 h-24"></textarea>
        <textarea id="ccDoneInput" placeholder="ì™„ë£Œì: ì‰¼í‘œ(,) ë˜ëŠ” ì¤„ë°”ê¿ˆìœ¼ë¡œ ì…ë ¥" class="border rounded-lg px-3 py-2 h-24"></textarea>
        <div class="flex flex-col gap-2">
          <button onclick="ccApplyRoster()" class="w-full bg-indigo-600 text-white rounded-lg py-2 hover:bg-indigo-700">ëª…ë‹¨ ì ìš©/ë®ì–´ì“°ê¸°</button>
          <button onclick="ccApplyDone()" class="w-full bg-green-600 text-white rounded-lg py-2 hover:bg-green-700">ì™„ë£Œì ì ìš©</button>
          <button onclick="ccClearAll()" class="w-full bg-gray-200 text-gray-700 rounded-lg py-2 hover:bg-gray-300">ì´ˆê¸°í™”</button>
        </div>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <h3 class="font-bold mb-2">ì „ì²´ ëª…ë‹¨ (<span id="ccRosterCount">0</span>)</h3>
          <div id="ccRosterList" class="space-y-1"></div>
        </div>
        <div>
          <h3 class="font-bold mb-2 text-red-600">ë¯¸ì‘ì‹œì ëª©ë¡ (<span id="ccPendingCount">0</span>)</h3>
          <div id="ccPendingList" class="space-y-1"></div>
        </div>
      </div>
    </div>

    <!-- ëˆ„ì  ë‹¨ì–´ í…ŒìŠ¤íŠ¸ -->
    <div class="bg-white rounded-2xl shadow-xl p-6 mb-10">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">ğŸ§  ëˆ„ì  ë‹¨ì–´ í…ŒìŠ¤íŠ¸</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mb-2">
        <textarea id="vaRosterInput" placeholder="ëª…ë‹¨: ì‰¼í‘œ(,) ë˜ëŠ” ì¤„ë°”ê¿ˆìœ¼ë¡œ í•™ìƒ ì—¬ëŸ¬ ëª… ì…ë ¥" class="border rounded-lg px-3 py-2 h-24"></textarea>
        <textarea id="vaDoneInput" placeholder="ì™„ë£Œì: ì‰¼í‘œ(,) ë˜ëŠ” ì¤„ë°”ê¿ˆìœ¼ë¡œ ì…ë ¥" class="border rounded-lg px-3 py-2 h-24"></textarea>
        <div class="flex flex-col gap-2">
          <button onclick="vaApplyRoster()" class="w-full bg-indigo-600 text-white rounded-lg py-2 hover:bg-indigo-700">ëª…ë‹¨ ì ìš©/ë®ì–´ì“°ê¸°</button>
          <button onclick="vaApplyDone()" class="w-full bg-green-600 text-white rounded-lg py-2 hover:bg-green-700">ì™„ë£Œì ì ìš©</button>
          <button onclick="vaClearAll()" class="w-full bg-gray-200 text-gray-700 rounded-lg py-2 hover:bg-gray-300">ì´ˆê¸°í™”</button>
        </div>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <h3 class="font-bold mb-2">ì „ì²´ ëª…ë‹¨ (<span id="vaRosterCount">0</span>)</h3>
          <div id="vaRosterList" class="space-y-1"></div>
        </div>
        <div>
          <h3 class="font-bold mb-2 text-red-600">ë¯¸ì‘ì‹œì ëª©ë¡ (<span id="vaPendingCount">0</span>)</h3>
          <div id="vaPendingList" class="space-y-1"></div>
        </div>
      </div>
    </div>

    <!-- ğŸŒŸ ë‹¨ì–´ì‹œí—˜ ìŠ¤ì¼€ì¤„ëŸ¬ (ê²¹ì¹¨ ì˜µì…˜ í¬í•¨) -->
    <div class="bg-white rounded-2xl shadow-xl p-6 mb-10">
      <div class="flex items-center justify-between">
        <h2 class="text-2xl font-bold text-gray-800">ğŸ“˜ ë‹¨ì–´ì‹œí—˜ ìŠ¤ì¼€ì¤„ëŸ¬</h2>
        <div class="flex gap-2">
          <button id="vocabTabToday" class="btn" onclick="vocabSwitchTab('today')">ì˜¤ëŠ˜</button>
          <button id="vocabTabUpcoming" class="btn btn-secondary" onclick="vocabSwitchTab('upcoming')">ë‹¤ê°€ì˜¤ëŠ”</button>
          <button id="vocabTabRules" class="btn btn-secondary" onclick="vocabSwitchTab('rules')">í•™ìƒ&ê·œì¹™</button>
          <button id="vocabTabBooks" class="btn btn-secondary" onclick="vocabSwitchTab('books')">êµì¬</button>
          <button id="vocabTabHelp" class="btn btn-secondary" onclick="vocabSwitchTab('help')">ì‚¬ìš©ë²•</button>
          <button class="btn btn-secondary ml-2" onclick="vocabExport()">ë‚´ë³´ë‚´ê¸°</button>
          <label class="btn btn-secondary cursor-pointer">
            ë¶ˆëŸ¬ì˜¤ê¸°<input id="vocabImportFile" type="file" accept="application/json" class="hidden" onchange="vocabImport(event)"/>
          </label>
        </div>
      </div>

      <!-- TODAY -->
      <section id="vocabViewToday" class="mt-4 space-y-3">
        <div class="text-sm text-slate-600">ë³´ê¸° ë‚ ì§œ: <b id="vocabViewDateLabel">-</b> (ìƒë‹¨ ë‚ ì§œ ì´ë™ê³¼ ì—°ë™)</div>
        <div id="vocabTodayList" class="grid gap-3"></div>
        <div id="vocabTodayEmpty" class="text-slate-500">í•´ë‹¹ ë‚ ì§œì˜ ë‹¨ì–´ì‹œí—˜ì´ ì—†ìŠµë‹ˆë‹¤.</div>
      </section>

      <!-- UPCOMING -->
      <section id="vocabViewUpcoming" class="mt-4 space-y-3 hidden">
        <div class="text-sm text-slate-600">ì˜¤ëŠ˜ í¬í•¨ 2ì£¼ ì¼ì •</div>
        <div id="vocabUpcomingList" class="grid gap-3"></div>
      </section>

      <!-- RULES -->
      <section id="vocabViewRules" class="mt-4 space-y-4 hidden">
        <div class="p-4 border rounded-xl">
          <h3 class="font-semibold mb-2">ìƒˆ ê·œì¹™ ì¶”ê°€</h3>
          <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-3">
            <div>
              <label class="text-sm">í•™ìƒ ì´ë¦„</label>
              <input id="vrName" class="input w-full" placeholder="ì˜ˆ: ì •ìˆ˜ë¹ˆ"/>
            </div>
            <div>
              <label class="text-sm">ë‹´ë‹¹ ì„ ìƒë‹˜</label>
              <input id="vrTeacher" class="input w-full" placeholder="ì˜ˆ: ê°•ë¯¼ì±„"/>
            </div>
            <div>
              <label class="text-sm">êµì¬</label>
              <select id="vrBook" class="input w-full"></select>
            </div>
            <div>
              <label class="text-sm">ì‹œì‘ ë²”ìœ„</label>
              <input id="vrStartRange" class="input w-full" placeholder="ì˜ˆ: 1-3"/>
            </div>
            <div>
              <label class="text-sm">ë‹¨ìœ„(íšŒì°¨ë‹¹ ê³¼ ìˆ˜)</label>
              <input id="vrUnit" type="number" class="input w-full" value="3"/>
            </div>
            <div>
              <label class="text-sm">ê²¹ì¹˜ëŠ” ê³¼ ìˆ˜</label>
              <input id="vrOverlap" type="number" class="input w-full" value="1"/>
            </div>
            <div>
              <label class="text-sm">ê²¹ì¹˜ëŠ” ë°©ì‹</label>
              <select id="vrOverlapMode" class="input w-full">
                <option value="end">ë ê³¼ ê²¹ì¹˜ê¸° (ì˜ˆ: 1â€“3 â†’ 3â€“5)</option>
                <option value="front">ì•ì—ì„œ ê²¹ì¹˜ê¸° (ì˜ˆ: 1â€“3 â†’ 2â€“4)</option>
              </select>
            </div>
            <div>
              <label class="text-sm">ì‹œí—˜ ìš”ì¼</label>
              <div class="flex flex-wrap gap-2 mt-1">
                <label class="pill"><input type="checkbox" class="vr-dow" value="1"/> ì›”</label>
                <label class="pill"><input type="checkbox" class="vr-dow" value="2"/> í™”</label>
                <label class="pill"><input type="checkbox" class="vr-dow" value="3"/> ìˆ˜</label>
                <label class="pill"><input type="checkbox" class="vr-dow" value="4"/> ëª©</label>
                <label class="pill"><input type="checkbox" class="vr-dow" value="5"/> ê¸ˆ</label>
                <label class="pill"><input type="checkbox" class="vr-dow" value="6"/> í† </label>
                <label class="pill"><input type="checkbox" class="vr-dow" value="0"/> ì¼</label>
              </div>
              <p class="text-xs text-slate-500 mt-1">ì˜ˆ) ì›”/ê¸ˆ â†’ ì›”(1), ê¸ˆ(5) ì²´í¬</p>
            </div>
            <div>
              <label class="text-sm">ì‹œì‘ ë‚ ì§œ</label>
              <input id="vrStartDate" type="date" class="input w-full"/>
            </div>
            <div>
              <label class="text-sm">ë§ˆì§€ë§‰ ê³¼</label>
              <input id="vrMaxUnit" type="number" class="input w-full" value="50"/>
            </div>
            <div>
              <label class="text-sm">ìƒì„± íšŒì°¨(ìµœëŒ€)</label>
              <input id="vrOcc" type="number" class="input w-full" value="40"/>
            </div>
          </div>
          <div class="mt-3 flex gap-2">
            <button class="btn" onclick="vocabAddRule()">ê·œì¹™ ì¶”ê°€ & ì¼ì • ìƒì„±</button>
            <button class="btn btn-secondary" onclick="vocabSeedDemo()">ì˜ˆì‹œ ê·œì¹™</button>
          </div>
        </div>

        <div class="p-4 border rounded-xl">
          <h3 class="font-semibold">ë“±ë¡ëœ ê·œì¹™</h3>
          <div id="vocabRulesList" class="mt-2 grid gap-2"></div>
        </div>
      </section>

      <!-- BOOKS -->
      <section id="vocabViewBooks" class="mt-4 space-y-4 hidden">
        <div class="p-4 border rounded-xl">
          <h3 class="font-semibold mb-2">êµì¬ ì¶”ê°€</h3>
          <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-3">
            <div>
              <label class="text-sm">êµì¬ëª…</label>
              <input id="vbName" class="input w-full" placeholder="ì˜ˆ: ê³ êµê¸°ë³¸"/>
            </div>
            <div>
              <label class="text-sm">ì´ ê³¼ ìˆ˜</label>
              <input id="vbCount" type="number" class="input w-full" placeholder="ì˜ˆ: 60"/>
            </div>
            <div>
              <label class="text-sm">ë¼ë²¨ ì ‘ë‘ì–´</label>
              <input id="vbPrefix" class="input w-full" placeholder="ì˜ˆ: Lesson"/>
            </div>
          </div>
          <div class="mt-3">
            <button class="btn" onclick="vocabAddBook()">êµì¬ ì¶”ê°€</button>
          </div>
        </div>

        <div class="p-4 border rounded-xl">
          <h3 class="font-semibold">êµì¬ ëª©ë¡</h3>
          <div id="vocabBooksList" class="mt-2 grid gap-2"></div>
        </div>
      </section>

      <!-- HELP -->
      <section id="vocabViewHelp" class="mt-4 hidden">
        <div class="p-4 border rounded-xl text-sm text-slate-700 space-y-2">
          <p><b>ì“°ëŠ” ë²•(ì•„ì£¼ ì‰¬ì›€)</b></p>
          <ol class="list-decimal pl-5 space-y-1">
            <li>ì•„ë˜ <b>êµì¬</b> íƒ­ì—ì„œ êµì¬ëª…ê³¼ ì´ ê³¼ ìˆ˜ë¥¼ ë“±ë¡í•©ë‹ˆë‹¤. (ì˜ˆ: ê³ êµê¸°ë³¸, 60ê³¼)</li>
            <li><b>í•™ìƒ&ê·œì¹™</b> íƒ­ì—ì„œ í•™ìƒ/ì„ ìƒ/êµì¬, ì‹œì‘ë²”ìœ„(ì˜ˆ: 1-3), ë‹¨ìœ„(3), ê²¹ì¹¨(1), <b>ê²¹ì¹˜ëŠ” ë°©ì‹</b>(ë/ì•)ê³¼ <b>ìš”ì¼</b>(ì›”/ê¸ˆ) ì„ íƒ â†’ <b>ê·œì¹™ ì¶”ê°€</b>.</li>
            <li>ìƒë‹¨ ë‚ ì§œ ì´ë™ê³¼ ì—°ë™ë˜ì–´, í•´ë‹¹ ë‚ ì§œê°€ ë˜ë©´ <b>ì˜¤ëŠ˜</b> íƒ­ì— ìë™ìœ¼ë¡œ ë²”ìœ„ì™€ êµì¬ê°€ ëœ¹ë‹ˆë‹¤.</li>
            <li>ì•Œë¦¼(ğŸ””)ì—ëŠ” <b>ì˜¤ëŠ˜ ë‹¨ì–´ì‹œí—˜</b>ë„ ì¡íˆë©°, JSON <b>ë‚´ë³´ë‚´ê¸°/ë¶ˆëŸ¬ì˜¤ê¸°</b> ì§€ì›.</li>
          </ol>
          <p class="text-xs text-slate-500">â€» â€œë ê³¼ ê²¹ì¹˜ê¸°â€ = 1â€“3 â†’ 3â€“5 â†’ 5â€“7 â€¦ / â€œì•ì—ì„œ ê²¹ì¹˜ê¸°â€ = 1â€“3 â†’ 2â€“4 â†’ 3â€“5 â€¦</p>
        </div>
      </section>
    </div>

    <!-- ì•ˆë‚´ -->
    <div class="bg-amber-50 border-2 border-amber-200 rounded-xl p-4">
      <h3 class="font-bold text-amber-800 mb-2">ğŸ“¢ ì‚¬ìš© ì•ˆë‚´</h3>
      <ul class="text-sm text-amber-700 space-y-1">
        <li>â€¢ ë§¤ì¼ ìë™ìœ¼ë¡œ <b>ì„¤ì •í•œ ê¸°ë³¸ ì²´í¬ë¦¬ìŠ¤íŠ¸</b>ê°€ ìƒì„±ë©ë‹ˆë‹¤.</li>
        <li>â€¢ í•­ëª©ì˜ <b>ë©”ëª¨</b> ë²„íŠ¼ìœ¼ë¡œ ë‚´ìš©ì„ ì¶”ê°€/ìˆ˜ì •í•˜ì„¸ìš”.</li>
        <li>â€¢ ì˜¤ë¥¸ìª½ ìœ„ ë¹¨ê°„ ì›: ë¯¸ì™„ë£Œ ì²´í¬ë¦¬ìŠ¤íŠ¸/ì˜¤ëŠ˜ ì¬ì‹œí—˜/ë¯¸ì™„ë£Œ íƒ€ì´í•‘/<b>ì˜¤ëŠ˜ ë‹¨ì–´ì‹œí—˜</b> ì•Œë¦¼</li>
        <li>â€¢ ì „ë‚ /ë‹¤ìŒë‚  ë²„íŠ¼ìœ¼ë¡œ ê³¼ê±° ê¸°ë¡ í™•ì¸</li>
      </ul>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <script>
    /* ===================== ê³µí†µ ìœ í‹¸ ===================== */
    function todayYMD() {
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    }
    function ymdOf(dateObj) {
      const y = dateObj.getFullYear();
      const m = String(dateObj.getMonth()+1).padStart(2,'0');
      const d = String(dateObj.getDate()).padStart(2,'0');
      return `${y}-${m}-${d}`;
    }
    function escapeHTML(s='') {
      return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }
    function formatDateKorean(dateStr) {
      const d = new Date(dateStr + 'T00:00:00');
      const days = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
      return `${d.getMonth()+1}ì›” ${d.getDate()}ì¼ (${days[d.getDay()]})`;
    }
    const parseList = (text) =>
      text.split(/[\n,]/).map(s=>s.trim()).filter(Boolean);
    const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));
    function addDays(dateStr, n){
      const d = new Date(dateStr + 'T00:00:00');
      d.setDate(d.getDate()+n);
      return ymdOf(d);
    }

    /* ===================== ìƒíƒœ ===================== */
    let currentViewDate = todayYMD();

    let defaultDaily = [];    // ì„¤ì • ê¸°ë³¸ ì²´í¬ë¦¬ìŠ¤íŠ¸
    let dailyTasks = {};      // {id: {label, checked, note}}
    let koreanCoaching = {};
    let hsMgmt = {};
    let typingTasks = {};
    let retestStudents = {};  // {id, name, subject, vocabBook, vocabRange, date, time}

    // í´ë˜ìŠ¤ì¹´ë“œ/ëˆ„ì ë‹¨ì–´
    let ccState = { roster:{}, done:{} };
    let vaState = { roster:{}, done:{} };

    /* ========= ğŸŒŸ ë‹¨ì–´ ìŠ¤ì¼€ì¤„ëŸ¬ ìƒíƒœ(Firebase ì €ì¥) ========= */
    const vocab = {
      books: {},   // bookId -> {name, units:[...]}
      rules: {},   // ruleId -> {student, teacher, bookId, startRange, unitSize, overlap, overlapMode, weekdays[], startDate, maxUnit, occurrences}
      events: {}   // eventId -> {ruleId, student, teacher, bookId, date, rangeStart, rangeEnd, done}
    };

    /* ===================== Firebase ===================== */
    const firebaseConfig = {
      apiKey: "AIzaSyCEPzrduTPO9_07SV3-2prXgWI-zQRsUA8",
      authDomain: "ganghanlucy.firebaseapp.com",
      databaseURL: "https://ganghanlucy-default-rtdb.firebaseio.com",
      projectId: "ganghanlucy",
      storageBucket: "ganghanlucy.appspot.com",
      messagingSenderId: "977455723921",
      appId: "1:977455723921:web:244babb9aee6a4d1061630"
    };
    try { firebase.initializeApp(firebaseConfig); } catch (e) { console.error('Firebase ì´ˆê¸°í™” ì‹¤íŒ¨:', e); }
    const db = firebase.database();

    /* ===== ë¦¬ìŠ¤ë„ˆ ref ===== */
    let dailyRef=null, koreanRef=null, hsRef=null, typingRef=null, ccRef=null, vaRef=null, retestRef=null, settingsRef=null;
    // ë‹¨ì–´ ìŠ¤ì¼€ì¤„ëŸ¬ ref
    let vbRef=null, vrRef=null, veRef=null;

    /* ===================== ë‚ ì§œ í‘œì‹œ ===================== */
    function updateDateDisplay() {
      const date = new Date(currentViewDate + 'T00:00:00');
      document.getElementById('currentDate').textContent = date.toLocaleDateString('ko-KR');
      const today = todayYMD();
      const infoEl = document.getElementById('dateInfo');
      if (currentViewDate === today) {
        infoEl.textContent = 'ì˜¤ëŠ˜';
        infoEl.className = 'text-sm font-bold text-green-600';
      } else if (currentViewDate < today) {
        infoEl.textContent = 'ê³¼ê±° ê¸°ë¡';
        infoEl.className = 'text-sm font-bold text-orange-600';
      } else {
        infoEl.textContent = 'ë¯¸ë˜';
        infoEl.className = 'text-sm font-bold text-blue-600';
      }
      // ë‹¨ì–´ ìŠ¤ì¼€ì¤„ëŸ¬ ë‚ ì§œ ë¼ë²¨
      const lbl = document.getElementById('vocabViewDateLabel');
      if(lbl) lbl.textContent = `${formatDateKorean(currentViewDate)} (${currentViewDate})`;
    }

    /* ===================== ê¸°ë³¸ ì‹œë“œ ===================== */
    async function seedDefaultDaily(date) {
      const ref = db.ref('daily/' + date);
      const payload = {};
      const baseLabels = defaultDaily.length ? defaultDaily : ['ì²­ì†Œ ìƒíƒœ í™•ì¸','ë‹¨ì–´ ë§Œë“¤ê¸°','ì˜¤ë‹¤ë¹„ ë³´ë‚´ê¸°','ìˆ™ì œ í™•ì¸'];
      baseLabels.forEach(label => {
        const key = ref.push().key;
        payload[key] = { label, checked: false, note: '' };
      });
      try { await ref.update(payload); } catch (err) { console.error('ì‹œë“œ ë°ì´í„° ìƒì„± ì‹¤íŒ¨:', err); }
    }

    /* ===================== ì„¤ì • ëª¨ë‹¬ ===================== */
    function openSettings() {
      document.getElementById('settingsBackdrop').style.display='block';
      document.getElementById('settingsModal').style.display='block';
      document.getElementById('defaultTasksInput').value = defaultDaily.length
        ? defaultDaily.join('\n')
        : 'ì²­ì†Œ ìƒíƒœ í™•ì¸\në‹¨ì–´ ë§Œë“¤ê¸°\nì˜¤ë‹¤ë¹„ ë³´ë‚´ê¸°\nìˆ™ì œ í™•ì¸';
    }
    function closeSettings() {
      document.getElementById('settingsBackdrop').style.display='none';
      document.getElementById('settingsModal').style.display='none';
    }
    function resetToRecommended() {
      document.getElementById('defaultTasksInput').value = 'ì²­ì†Œ ìƒíƒœ í™•ì¸\në‹¨ì–´ ë§Œë“¤ê¸°\nì˜¤ë‹¤ë¹„ ë³´ë‚´ê¸°\nìˆ™ì œ í™•ì¸';
    }
    function saveDefaultTasks() {
      const arr = parseList(document.getElementById('defaultTasksInput').value);
      db.ref('settings/defaultDailyTasks').set(arr)
        .then(()=>{ alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. ë‚´ì¼ë¶€í„° ìƒˆ ëª©ë¡ìœ¼ë¡œ ìë™ ìƒì„±ë©ë‹ˆë‹¤.'); })
        .catch(err=>{ console.error(err); alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'); });
      closeSettings();
    }

    /* ===================== ë Œë”ëŸ¬ (ì²´í¬ë¦¬ìŠ¤íŠ¸ ë“±) ===================== */
    function renderDailyTasks() {
      const listEl = document.getElementById('dailyTasksList');
      const entries = Object.entries(dailyTasks);
      const completed = entries.filter(([_, t]) => t.checked).length;
      const total = entries.length;

      document.getElementById('completedCount').textContent = `${completed}/${total || 0}`;
      document.getElementById('progressBar').style.width = total > 0 ? ((completed / total) * 100) + '%' : '0%';

      if (!entries.length) {
        listEl.innerHTML = `<div class="text-center text-gray-500 py-4">í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
      } else {
        listEl.innerHTML = entries.map(([id, task]) => {
          const checkedCls = task.checked ? 'bg-green-50 border-2 border-green-500' : 'bg-gray-50 border-2 border-gray-200 hover:border-indigo-300';
          const labelCls = task.checked ? 'text-gray-500 line-through' : 'text-gray-800 font-medium';
          const note = task.note || '';
          return `
            <div class="w-full p-4 rounded-xl transition-all ${checkedCls}">
              <div class="flex items-center gap-3">
                <button title="ì™„ë£Œ í† ê¸€" onclick="toggleTask('${id}')" class="w-7 h-7 rounded-full flex items-center justify-center ${task.checked ? 'bg-green-500 text-white' : 'bg-white border-2 border-gray-300'}">${task.checked ? 'âœ“' : ''}</button>
                <span class="flex-1 text-left text-lg ${labelCls}">${escapeHTML(task.label)}</span>
                <button onclick="openNoteEditor('${id}')" class="px-2 py-1 text-sm rounded bg-yellow-100 border border-yellow-300 hover:bg-yellow-200">ë©”ëª¨</button>
                <button onclick="deleteTask('${id}')" class="text-red-500 hover:text-red-700 text-xl" aria-label="ì‚­ì œ">âœ•</button>
              </div>
              ${note ? `<div class="mt-2 text-sm text-gray-700 bg-white border rounded p-2">${escapeHTML(note)}</div>` : ``}
            </div>
          `;
        }).join('');
      }
    }

    function renderKorean() {
      const entries = Object.entries(koreanCoaching);
      document.getElementById('koreanCount').textContent = entries.length;
      document.getElementById('koreanList').innerHTML = entries.map(([id, s]) => `
        <div class="bg-indigo-50 rounded-lg p-4 flex justify-between items-center">
          <div class="flex-1">
            <div class="font-bold text-lg">${escapeHTML(s.name)}</div>
            <div class="text-sm text-gray-600">ì ìˆ˜: ${escapeHTML(s.score||'')} | ${escapeHTML(s.attendance||'')} | í‹€ë¦° ë¬¸ì œ: ${escapeHTML(s.wrong||'')}</div>
          </div>
          <button onclick="deleteKorean('${id}')" class="text-red-500 hover:text-red-700 ml-4 text-xl">âœ•</button>
        </div>
      `).join('') || `<div class="text-gray-500">ë“±ë¡ëœ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
    }

    function renderHsMgmt() {
      const entries = Object.entries(hsMgmt);
      document.getElementById('hsMgmtCount').textContent = entries.length;
      document.getElementById('hsMgmtList').innerHTML = entries.map(([id, s]) => `
        <div class="bg-purple-50 rounded-lg p-4 flex justify-between items-center">
          <div class="flex-1">
            <div class="font-bold text-lg">${escapeHTML(s.name)} <span class="text-sm text-purple-700">(${escapeHTML(s.subject)})</span></div>
            <div class="text-sm text-gray-600">ì ìˆ˜: ${escapeHTML(s.score||'')} | ë²”ìœ„: ${escapeHTML(s.range||'')}</div>
          </div>
          <button onclick="deleteHsMgmt('${id}')" class="text-red-500 hover:text-red-700 ml-4 text-xl">âœ•</button>
        </div>
      `).join('') || `<div class="text-gray-500">ë“±ë¡ëœ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
    }

    function renderTyping() {
      const entries = Object.entries(typingTasks);
      document.getElementById('typingCount').textContent = entries.length;
      document.getElementById('typingList').innerHTML = entries.map(([id, t]) => `
        <div class="bg-green-50 rounded-lg p-4 flex justify-between items-center">
          <div class="flex-1">
            <div class="font-bold ${t.completed ? 'line-through text-gray-500':''}">${escapeHTML(t.task)}</div>
            <div class="text-sm text-gray-600">ì™„ë£Œ: ${escapeHTML(t.progress||'')}</div>
          </div>
          <div class="flex gap-2">
            <button onclick="toggleTypingComplete('${id}')"
                    class="px-3 py-1 rounded ${t.completed ? 'bg-gray-300' : 'bg-green-500 text-white'} text-sm">
              ${t.completed ? 'ì¬ê°œ' : 'ì™„ë£Œ'}
            </button>
            <button onclick="deleteTyping('${id}')" class="text-red-500 hover:text-red-700 text-xl">âœ•</button>
          </div>
        </div>
      `).join('') || `<div class="text-gray-500">ë“±ë¡ëœ ì—…ë¬´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
    }

    function renderRetest() {
      const today = todayYMD();
      const all = Object.values(retestStudents || {});
      const todayRetests = all.filter(s => s.date === today);
      const upcomingRetests = all.filter(s => s.date > today).sort((a,b)=>a.date.localeCompare(b.date));
      const pastRetests = all.filter(s => s.date < today).sort((a,b)=>b.date.localeCompare(a.date));

      document.getElementById('retestCount').textContent = all.length;
      const badge = document.getElementById('todayRetestBadge');
      badge.style.display = todayRetests.length ? 'inline-block' : 'none';
      badge.textContent = `ì˜¤ëŠ˜ ${todayRetests.length}ëª…`;

      const card = (s, tone='') => `
        <div class="${tone==='today'?'bg-red-100 border-2 border-red-400':'bg-orange-50'} rounded-lg p-4 flex justify-between items-center">
          <div class="flex-1">
            <div class="font-bold text-lg ${tone==='today'?'text-red-800':''}">${escapeHTML(s.name)}</div>
            <div class="text-sm ${tone==='today'?'text-red-700':'text-gray-600'}">
              ${escapeHTML(s.subject||'')}
              ${s.vocabBook ? ` | ë‹¨ì–´ì¥: ${escapeHTML(s.vocabBook)}` : ``}
              ${s.vocabRange ? ` | ë²”ìœ„: ${escapeHTML(s.vocabRange)}` : ``}
              | ${formatDateKorean(s.date)} ${s.time? `| ${escapeHTML(s.time)}`:''}
            </div>
          </div>
          <button onclick="deleteRetest('${s.id}')" class="text-red-600 hover:text-red-800 ml-4 text-xl">âœ•</button>
        </div>`;

      let html = '';
      if (todayRetests.length) {
        html += `<div class="mb-4"><h3 class="font-bold text-red-600 mb-2">ğŸ”´ ì˜¤ëŠ˜ ì¬ì‹œí—˜</h3>
          <div class="space-y-2">${todayRetests.map(s => card(s,'today')).join('')}</div></div>`;
      }
      if (upcomingRetests.length) {
        html += `<div class="mb-4"><h3 class="font-bold text-orange-600 mb-2">ğŸ“… ì˜ˆì •ëœ ì¬ì‹œí—˜</h3>
          <div class="space-y-2">${upcomingRetests.map(s => card(s)).join('')}</div></div>`;
      }
      if (pastRetests.length) {
        html += `<div><h3 class="font-bold text-gray-500 mb-2">âœ… ì™„ë£Œëœ ì¬ì‹œí—˜</h3>
          <div class="space-y-2">
            ${pastRetests.map(s => `
              <div class="bg-gray-100 rounded-lg p-4 flex justify-between items-center opacity-70">
                <div class="flex-1">
                  <div class="font-bold">${escapeHTML(s.name)}</div>
                  <div class="text-sm text-gray-600">
                    ${escapeHTML(s.subject||'')}
                    ${s.vocabBook ? ` | ë‹¨ì–´ì¥: ${escapeHTML(s.vocabBook)}` : ``}
                    ${s.vocabRange ? ` | ë²”ìœ„: ${escapeHTML(s.vocabRange)}` : ``}
                    | ${formatDateKorean(s.date)} ${s.time? `| ${escapeHTML(s.time)}`:''}
                  </div>
                </div>
                <button onclick="deleteRetest('${s.id}')" class="text-red-500 hover:text-red-700 ml-4 text-xl">âœ•</button>
              </div>`).join('')}
          </div></div>`;
      }
      document.getElementById('retestList').innerHTML = html || `<div class="text-gray-500">ì¬ì‹œí—˜ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
    }

    function renderNamePills(containerId, names) {
      const el = document.getElementById(containerId);
      el.innerHTML = names.length
        ? names.map(n => `<span class="inline-block px-2 py-1 rounded-full text-sm bg-gray-100 border">${escapeHTML(n)}</span>`).join(' ')
        : `<div class="text-gray-500">ì—†ìŒ</div>`;
    }
    function diffPending(rosterMap, doneMap) {
      const all = Object.keys(rosterMap||{});
      return all.filter(n => !doneMap || !doneMap[n]);
    }
    function renderClasscard() {
      const roster = Object.keys(ccState.roster||{});
      const pending = diffPending(ccState.roster, ccState.done);
      document.getElementById('ccRosterCount').textContent = roster.length;
      document.getElementById('ccPendingCount').textContent = pending.length;
      renderNamePills('ccRosterList', roster);
      renderNamePills('ccPendingList', pending);
    }
    function renderVocabAccum() {
      const roster = Object.keys(vaState.roster||{});
      const pending = diffPending(vaState.roster, vaState.done);
      document.getElementById('vaRosterCount').textContent = roster.length;
      document.getElementById('vaPendingCount').textContent = pending.length;
      renderNamePills('vaRosterList', roster);
      renderNamePills('vaPendingList', pending);
    }

    /* ===================== ì•Œë¦¼ (ë‹¨ì–´ì‹œí—˜ í¬í•¨ í™•ì¥) ===================== */
    function updateNotificationPanel() {
      const today = todayYMD();
      const incompleteTasks = Object.values(dailyTasks).filter(t => !t.checked).map(t => `â€¢ ${escapeHTML(t.label)}`);
      const todayRetests = Object.values(retestStudents||{}).filter(s => s.date === today).map(s => `â€¢ ${escapeHTML(s.name)} (${escapeHTML(s.subject||'')}${s.time? ' '+escapeHTML(s.time):''})`);
      const incompleteTyping = Object.values(typingTasks).filter(t => !t.completed).map(t => `â€¢ ${escapeHTML(t.task)}`);
      const todayVocabEvents = Object.values(vocab.events||{}).filter(e => e.date === today).map(e => `â€¢ ${escapeHTML(e.student)} (${e.rangeStart}â€“${e.rangeEnd})`);

      const sections = [];
      if (incompleteTasks.length) sections.push(`<h4 class="font-semibold mb-1">ë¯¸ì™„ë£Œ ì²´í¬ë¦¬ìŠ¤íŠ¸</h4><div class="mb-2">${incompleteTasks.join('<br>')}</div>`);
      if (todayRetests.length) sections.push(`<h4 class="font-semibold mb-1">ì˜¤ëŠ˜ ì¬ì‹œí—˜</h4><div class="mb-2">${todayRetests.join('<br>')}</div>`);
      if (todayVocabEvents.length) sections.push(`<h4 class="font-semibold mb-1">ì˜¤ëŠ˜ ë‹¨ì–´ì‹œí—˜</h4><div class="mb-2">${todayVocabEvents.join('<br>')}</div>`);
      if (incompleteTyping.length) sections.push(`<h4 class="font-semibold mb-1">íƒ€ì´í•‘ ì—…ë¬´</h4><div>${incompleteTyping.join('<br>')}</div>`);

      document.getElementById('notificationContent').innerHTML = sections.join('<hr class="my-3">') || 'ì•Œë¦¼ ì—†ìŒ';
    }
    function checkNotifications() {
      const today = todayYMD();
      if (currentViewDate !== today) {
        document.getElementById('notificationBadge').style.display = 'none';
        return;
      }
      const incompleteTasks = Object.values(dailyTasks).filter(t => !t.checked).length;
      const todayRetests = Object.values(retestStudents||{}).filter(s => s.date === today).length;
      const incompleteTyping = Object.values(typingTasks).filter(t => !t.completed).length;
      const todayVocabEvents = Object.values(vocab.events||{}).filter(e => e.date === today).length;

      const total = incompleteTasks + todayRetests + incompleteTyping + todayVocabEvents;

      if (total > 0) {
        document.getElementById('notificationBadge').style.display = 'flex';
        document.getElementById('notificationCount').textContent = total;
      } else {
        document.getElementById('notificationBadge').style.display = 'none';
      }
      updateNotificationPanel();
    }

    /* ===================== CRUD (ì²´í¬ë¦¬ìŠ¤íŠ¸ ë“±) ===================== */
    // daily
    function addNewTask() {
      const input = document.getElementById('newTaskInput');
      const noteInput = document.getElementById('newTaskNoteInput');
      const label = input.value.trim();
      const note = (noteInput.value||'').trim();
      if (!label) return;
      const ref = db.ref('daily/' + currentViewDate);
      const key = ref.push().key;
      ref.child(key).set({ label, checked: false, note }).catch(err => console.error('íƒœìŠ¤í¬ ì¶”ê°€ ì‹¤íŒ¨:', err));
      input.value = '';
      noteInput.value = '';
    }
    function toggleTask(id) {
      const cur = dailyTasks[id]; if (!cur) return;
      db.ref(`daily/${currentViewDate}/${id}/checked`).set(!cur.checked).catch(err => console.error('íƒœìŠ¤í¬ í† ê¸€ ì‹¤íŒ¨:', err));
    }
    function deleteTask(id) {
      db.ref(`daily/${currentViewDate}/${id}`).remove().catch(err => console.error('íƒœìŠ¤í¬ ì‚­ì œ ì‹¤íŒ¨:', err));
    }
    function openNoteEditor(id) {
      const cur = dailyTasks[id]; if (!cur) return;
      const newNote = prompt('ë©”ëª¨/ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”:', cur.note || '');
      if (newNote === null) return;
      db.ref(`daily/${currentViewDate}/${id}/note`).set(newNote).catch(err => console.error('ë©”ëª¨ ì €ì¥ ì‹¤íŒ¨:', err));
    }

    // korean
    function addKorean() {
      const name = document.getElementById('koreanName').value.trim();
      const score = document.getElementById('koreanScore').value.trim();
      const attendance = document.getElementById('koreanAttendance').value;
      const wrong = document.getElementById('koreanWrong').value.trim();
      if (!name) return;
      const ref = db.ref('korean/' + currentViewDate);
      const key = ref.push().key;
      ref.child(key).set({ name, score, attendance, wrong }).catch(err => console.error('êµ­ì–´ í•™ìƒ ì¶”ê°€ ì‹¤íŒ¨:', err));
      document.getElementById('koreanName').value = '';
      document.getElementById('koreanScore').value = '';
      document.getElementById('koreanWrong').value = '';
    }
    function deleteKorean(id) {
      db.ref(`korean/${currentViewDate}/${id}`).remove().catch(err => console.error('êµ­ì–´ í•™ìƒ ì‚­ì œ ì‹¤íŒ¨:', err));
    }

    // ì—­ì‚¬/ê³¼í•™
    function addHsMgmt() {
      const subject = document.getElementById('hsSubject').value;
      const name = document.getElementById('hsName').value.trim();
      const score = document.getElementById('hsScore').value.trim();
      const range = document.getElementById('hsRange').value.trim();
      if (!name) return;
      const ref = db.ref('hsMgmt/' + currentViewDate);
      const key = ref.push().key;
      ref.child(key).set({ subject, name, score, range }).catch(err => console.error('ì—­ì‚¬/ê³¼í•™ ì¶”ê°€ ì‹¤íŒ¨:', err));
      document.getElementById('hsName').value = '';
      document.getElementById('hsScore').value = '';
      document.getElementById('hsRange').value = '';
    }
    function deleteHsMgmt(id) {
      db.ref(`hsMgmt/${currentViewDate}/${id}`).remove().catch(err => console.error('ì—­ì‚¬/ê³¼í•™ ì‚­ì œ ì‹¤íŒ¨:', err));
    }

    // typing
    function addTyping() {
      const task = document.getElementById('typingTask').value.trim();
      const progress = document.getElementById('typingProgress').value.trim();
      if (!task) return;
      const ref = db.ref('typing/' + currentViewDate);
      const key = ref.push().key;
      ref.child(key).set({ task, progress, completed: false }).catch(err => console.error('íƒ€ì´í•‘ ì—…ë¬´ ì¶”ê°€ ì‹¤íŒ¨:', err));
      document.getElementById('typingTask').value = '';
      document.getElementById('typingProgress').value = '';
    }
    function toggleTypingComplete(id) {
      const cur = typingTasks[id]; if (!cur) return;
      db.ref(`typing/${currentViewDate}/${id}/completed`).set(!cur.completed).catch(err => console.error('íƒ€ì´í•‘ ì™„ë£Œ í† ê¸€ ì‹¤íŒ¨:', err));
    }
    function deleteTyping(id) {
      db.ref(`typing/${currentViewDate}/${id}`).remove().catch(err => console.error('íƒ€ì´í•‘ ì‚­ì œ ì‹¤íŒ¨:', err));
    }

    // ì¬ì‹œí—˜(ì „ì—­)
    function addRetest() {
      const name = document.getElementById('retestName').value.trim();
      const subject = document.getElementById('retestSubject').value.trim();
      const vocabBook = document.getElementById('retestVocabBook').value.trim();
      const vocabRange = document.getElementById('retestVocabRange').value.trim();
      const date = document.getElementById('retestDate').value;
      const time = document.getElementById('retestTime').value;
      if (!name || !date) return;
      const ref = db.ref('retest');
      const key = ref.push().key;
      const item = { id: key, name, subject, vocabBook, vocabRange, date, time };
      ref.child(key).set(item).catch(err => console.error('ì¬ì‹œí—˜ ì¶”ê°€ ì‹¤íŒ¨:', err));
      document.getElementById('retestName').value = '';
      document.getElementById('retestSubject').value = '';
      document.getElementById('retestVocabBook').value = '';
      document.getElementById('retestVocabRange').value = '';
      document.getElementById('retestDate').value = '';
      document.getElementById('retestTime').value = '';
    }
    function deleteRetest(id) {
      db.ref(`retest/${id}`).remove().catch(err => console.error('ì¬ì‹œí—˜ ì‚­ì œ ì‹¤íŒ¨:', err));
    }

    // í´ë˜ìŠ¤ì¹´ë“œ
    function ccApplyRoster() {
      const names = parseList(document.getElementById('ccRosterInput').value);
      const map = {}; names.forEach(n => map[n]=true);
      db.ref(`classcard/${currentViewDate}/roster`).set(map);
    }
    function ccApplyDone() {
      const names = parseList(document.getElementById('ccDoneInput').value);
      const map = {}; names.forEach(n => map[n]=true);
      db.ref(`classcard/${currentViewDate}/done`).set(map);
    }
    function ccClearAll() {
      db.ref(`classcard/${currentViewDate}`).set({ roster:{}, done:{} });
    }

    // ëˆ„ì  ë‹¨ì–´
    function vaApplyRoster() {
      const names = parseList(document.getElementById('vaRosterInput').value);
      const map = {}; names.forEach(n => map[n]=true);
      db.ref(`vocabAccum/${currentViewDate}/roster`).set(map);
    }
    function vaApplyDone() {
      const names = parseList(document.getElementById('vaDoneInput').value);
      const map = {}; names.forEach(n => map[n]=true);
      db.ref(`vocabAccum/${currentViewDate}/done`).set(map);
    }
    function vaClearAll() {
      db.ref(`vocabAccum/${currentViewDate}`).set({ roster:{}, done:{} });
    }

    /* ===================== ë¦¬ìŠ¤ë„ˆ ê´€ë¦¬ ===================== */
    function detachListeners() {
      try { if (dailyRef)  { dailyRef.off();  dailyRef=null; } } catch(e){}
      try { if (koreanRef) { koreanRef.off(); koreanRef=null; } } catch(e){}
      try { if (hsRef)     { hsRef.off();     hsRef=null; } } catch(e){}
      try { if (typingRef) { typingRef.off(); typingRef=null; } } catch(e){}
      try { if (ccRef)     { ccRef.off();     ccRef=null; } } catch(e){}
      try { if (vaRef)     { vaRef.off();     vaRef=null; } } catch(e){}
      // retestRef, settingsRef, vocab refsëŠ” ì „ì—­ ìœ ì§€
    }

    function attachListenersForDate() {
      // daily
      dailyRef = db.ref('daily/' + currentViewDate);
      dailyRef.on('value', async snap => {
        if (!snap.exists()) {
          await seedDefaultDaily(currentViewDate);
          dailyTasks = {};
        } else {
          dailyTasks = snap.val() || {};
        }
        renderDailyTasks(); checkNotifications();
      }, err => {
        console.error('ì¼ì¼ íƒœìŠ¤í¬ ë¡œë“œ ì‹¤íŒ¨:', err);
        dailyTasks = {};
        renderDailyTasks();
      });

      // korean
      koreanRef = db.ref('korean/' + currentViewDate);
      koreanRef.on('value', snap => {
        koreanCoaching = snap.val() || {};
        renderKorean(); checkNotifications();
      }, err => {
        console.error('êµ­ì–´ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', err);
        koreanCoaching = {};
        renderKorean();
      });

      // ì—­ì‚¬/ê³¼í•™ ê´€ë¦¬ë°˜
      hsRef = db.ref('hsMgmt/' + currentViewDate);
      hsRef.on('value', snap => {
        hsMgmt = snap.val() || {};
        renderHsMgmt(); checkNotifications();
      }, err => {
        console.error('ì—­ì‚¬/ê³¼í•™ ë¡œë“œ ì‹¤íŒ¨:', err);
        hsMgmt = {};
        renderHsMgmt();
      });

      // typing
      typingRef = db.ref('typing/' + currentViewDate);
      typingRef.on('value', snap => {
        typingTasks = snap.val() || {};
        renderTyping(); checkNotifications();
      }, err => {
        console.error('íƒ€ì´í•‘ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', err);
        typingTasks = {};
        renderTyping();
      });

      // í´ë˜ìŠ¤ì¹´ë“œ
      ccRef = db.ref('classcard/' + currentViewDate);
      ccRef.on('value', snap => {
        const val = snap.val();
        ccState = val ? { roster: val.roster || {}, done: val.done || {} } : { roster:{}, done:{} };
        renderClasscard(); checkNotifications();
      }, err => {
        console.error('í´ë˜ìŠ¤ì¹´ë“œ ë¡œë“œ ì‹¤íŒ¨:', err);
        ccState = { roster:{}, done:{} };
        renderClasscard();
      });

      // ëˆ„ì ë‹¨ì–´
      vaRef = db.ref('vocabAccum/' + currentViewDate);
      vaRef.on('value', snap => {
        const val = snap.val();
        vaState = val ? { roster: val.roster || {}, done: val.done || {} } : { roster:{}, done:{} };
        renderVocabAccum(); checkNotifications();
      }, err => {
        console.error('ëˆ„ì ë‹¨ì–´ ë¡œë“œ ì‹¤íŒ¨:', err);
        vaState = { roster:{}, done:{} };
        renderVocabAccum();
      });

      // ğŸŒŸ ë‹¨ì–´ ìŠ¤ì¼€ì¤„ëŸ¬: ì´ë²¤íŠ¸ëŠ” ë‚ ì§œ ê¸°ë°˜ ë Œë”ì— ì‚¬ìš©
      // (eventsëŠ” ì „ì—­ ë¦¬ìŠ¤ë„ˆì—ì„œ ì´ë¯¸ ê°€ì ¸ì˜¤ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” ë Œë”ë§Œ)
      vocabRenderAll();
    }

    function attachGlobalListenersOnce() {
      if (!retestRef) {
        retestRef = db.ref('retest');
        retestRef.on('value', snap => {
          retestStudents = snap.val() || {};
          renderRetest(); checkNotifications();
        }, err => {
          console.error('ì¬ì‹œí—˜ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', err);
          retestStudents = {};
          renderRetest();
        });
      }
      if (!settingsRef) {
        settingsRef = db.ref('settings/defaultDailyTasks');
        settingsRef.on('value', snap => {
          defaultDaily = (snap.val() || []).filter(Boolean);
        }, err => {
          console.error('ì„¤ì • ë¡œë“œ ì‹¤íŒ¨:', err);
          defaultDaily = [];
        });
      }
      // ğŸŒŸ ë‹¨ì–´ ìŠ¤ì¼€ì¤„ëŸ¬ ì „ì—­ ë¦¬ìŠ¤ë„ˆ
      if(!vbRef){
        vbRef = db.ref('vocab/books');
        vbRef.on('value', snap=>{
          vocab.books = snap.val() || {};
          vocabRenderBooks(); vocabPopulateBookSelect(); vocabRenderToday(); vocabRenderUpcoming();
        });
      }
      if(!vrRef){
        vrRef = db.ref('vocab/rules');
        vrRef.on('value', snap=>{
          vocab.rules = snap.val() || {};
          vocabRenderRules();
        });
      }
      if(!veRef){
        veRef = db.ref('vocab/events');
        veRef.on('value', snap=>{
          vocab.events = snap.val() || {};
          vocabRenderToday(); vocabRenderUpcoming(); checkNotifications();
        });
      }
    }

    /* ===================== ë‚ ì§œ ì´ë™/ì´ˆê¸°í™” ===================== */
    function changeDate(dir) {
      const d = new Date(currentViewDate + 'T00:00:00');
      d.setDate(d.getDate() + dir);
      currentViewDate = ymdOf(d);
      updateDateDisplay();
      detachListeners();
      attachListenersForDate();
    }
    function goToToday() {
      currentViewDate = todayYMD();
      updateDateDisplay();
      detachListeners();
      attachListenersForDate();
    }
    function toggleNotification() {
      const panel = document.getElementById('notificationPanel');
      panel.style.display = (panel.style.display === 'none' || !panel.style.display) ? 'block' : 'none';
    }

    /* ===========================================================
       ğŸŒŸ ë‹¨ì–´ì‹œí—˜ ìŠ¤ì¼€ì¤„ëŸ¬ ë¡œì§ (Firebase /vocab/*)
       =========================================================== */
    // ---- íƒ­ ì „í™˜
    function vocabSwitchTab(name){
      const tabs = ['today','upcoming','rules','books','help'];
      tabs.forEach(t=>{
        document.getElementById('vocabView'+t.charAt(0).toUpperCase()+t.slice(1)).classList.toggle('hidden', t!==name);
        document.getElementById('vocabTab'+t.charAt(0).toUpperCase()+t.slice(1)).classList.toggle('btn', t===name);
        document.getElementById('vocabTab'+t.charAt(0).toUpperCase()+t.slice(1)).classList.toggle('btn-secondary', t!==name);
      });
      if(name==='today') vocabRenderToday();
      if(name==='upcoming') vocabRenderUpcoming();
      if(name==='rules') vocabRenderRules();
      if(name==='books') { vocabRenderBooks(); vocabPopulateBookSelect(); }
    }

    // ---- ê³µí†µ íŒŒì„œ
    function vocabParseRange(txt){
      const m = (txt||'').match(/^\s*(\d+)\s*-\s*(\d+)\s*$/);
      if(!m) return null;
      return {start: parseInt(m[1],10), end: parseInt(m[2],10)};
    }
    function vocabNearestOnOrAfter(ymd, weekdays){
      const d = new Date(ymd+'T00:00:00');
      const dw = d.getDay();
      if(weekdays.includes(dw)) return ymd;
      let best = ymd, minDiff=7;
      for(const w of weekdays){
        let diff = (w - dw + 7) % 7; if(diff===0) diff=7;
        if(diff<minDiff){ minDiff=diff; best = addDays(ymd, diff); }
      }
      return best;
    }
    function vocabNextByWeekdays(ymd, weekdays){
      const d = new Date(ymd+'T00:00:00');
      const dw = d.getDay();
      const sorted = weekdays.slice().sort((a,b)=>a-b);
      let idx = sorted.indexOf(dw);
      if(idx===-1){
        return vocabNearestOnOrAfter(addDays(ymd,1), weekdays);
      }
      const next = sorted[(idx+1)%sorted.length];
      const diff = (next - dw + 7) % 7 || 7;
      return addDays(ymd, diff);
    }
    function vocabNextDates(startISO, weekdays, count){
      const out=[];
      let ymd = vocabNearestOnOrAfter(startISO, weekdays);
      while(out.length<count){
        out.push(ymd);
        ymd = vocabNextByWeekdays(ymd, weekdays);
      }
      return out;
    }

    // ---- BOOKS
    function vocabPopulateBookSelect(){
      const sel = document.getElementById('vrBook');
      if(!sel) return;
      sel.innerHTML='';
      Object.entries(vocab.books).forEach(([id,b])=>{
        const opt = document.createElement('option');
        opt.value = id; opt.textContent = b.name;
        sel.appendChild(opt);
      });
    }
    function vocabRenderBooks(){
      const wrap = document.getElementById('vocabBooksList');
      if(!wrap) return;
      wrap.innerHTML='';
      const entries = Object.entries(vocab.books);
      if(entries.length===0){
        wrap.innerHTML = `<div class="text-slate-500">ë“±ë¡ëœ êµì¬ê°€ ì—†ìŠµë‹ˆë‹¤. ìœ„ì—ì„œ ì¶”ê°€í•˜ì„¸ìš”.</div>`;
        return;
      }
      entries.forEach(([id,b])=>{
        const unitPreview = (b.units||[]).slice(0,8).join(', ') + ((b.units||[]).length>8 ? 'â€¦':'');
        const el = document.createElement('div');
        el.className='p-3 border rounded bg-white flex items-center justify-between gap-2';
        el.innerHTML = `
          <div>
            <div class="font-medium">${escapeHTML(b.name)}</div>
            <div class="text-xs text-slate-500">ì´ ${(b.units||[]).length}ê³¼ Â· ì˜ˆì‹œ: ${escapeHTML(unitPreview)}</div>
          </div>
          <div class="flex gap-2">
            <button class="btn btn-secondary" onclick="vocabDeleteBook('${id}')">ì‚­ì œ</button>
          </div>
        `;
        wrap.appendChild(el);
      });
    }
    function vocabAddBook(){
      const name = document.getElementById('vbName').value.trim();
      const count = parseInt(document.getElementById('vbCount').value,10);
      const prefix = (document.getElementById('vbPrefix').value.trim() || 'Unit');
      if(!name || !count || count<1){ alert('êµì¬ëª…ê³¼ ì´ ê³¼ ìˆ˜ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•˜ì„¸ìš”.'); return; }
      const units = Array.from({length:count},(_,i)=>`${prefix} ${i+1}`);
      const ref = db.ref('vocab/books');
      const id = ref.push().key;
      ref.child(id).set({name, units}).then(()=>{
        document.getElementById('vbName').value='';
        document.getElementById('vbCount').value='';
        document.getElementById('vbPrefix').value='';
      });
    }
    function vocabDeleteBook(id){
      if(!confirm('ì´ êµì¬ë¥¼ ì‚­ì œí• ê¹Œìš”? (ê·œì¹™ì€ ë‚¨ìŠµë‹ˆë‹¤)')) return;
      db.ref(`vocab/books/${id}`).remove();
    }

    // ---- RULES & EVENTS
    function vocabRenderRules(){
      const box = document.getElementById('vocabRulesList');
      if(!box) return;
      box.innerHTML='';
      const entries = Object.entries(vocab.rules);
      if(entries.length===0){
        box.innerHTML = `<div class="text-slate-500">ê·œì¹™ì´ ì—†ìŠµë‹ˆë‹¤. ìœ„ì—ì„œ ì¶”ê°€í•˜ì„¸ìš”.</div>`;
        return;
      }
      entries.forEach(([rid,r])=>{
        const book = vocab.books[r.bookId];
        const dowText = (r.weekdays||[]).map(dw=>['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '][dw]).join(', ');
        const modeText = r.overlapMode==='front' ? 'ì•ì—ì„œ ê²¹ì¹˜ê¸°' : 'ë ê³¼ ê²¹ì¹˜ê¸°';
        const el = document.createElement('div');
        el.className='p-3 border rounded bg-white flex items-center justify-between gap-2';
        el.innerHTML = `
          <div>
            <div class="font-medium">${escapeHTML(r.student)} <span class="text-slate-400">(${escapeHTML(r.teacher)})</span></div>
            <div class="text-xs text-slate-500">
              êµì¬: ${book?escapeHTML(book.name):'?'} Â· ì‹œì‘: ${escapeHTML(r.startRange)} Â· ë‹¨ìœ„:${r.unitSize}
              Â· ê²¹ì¹¨:${r.overlap} (${modeText}) Â· ìš”ì¼:${escapeHTML(dowText)} Â· ì‹œì‘ì¼:${escapeHTML(r.startDate)}
              Â· ë§ˆì§€ë§‰ ê³¼:${r.maxUnit} Â· ìƒì„±:${r.occurrences}íšŒ
            </div>
          </div>
          <div class="flex gap-2">
            <button class="btn btn-secondary" onclick="vocabRegenForRule('${rid}', true)">ì¼ì • ì¬ìƒì„±</button>
            <button class="btn btn-secondary" onclick="vocabDeleteRule('${rid}')">ê·œì¹™ ì‚­ì œ</button>
          </div>
        `;
        box.appendChild(el);
      });
    }
    function vocabAddRule(){
      const name = document.getElementById('vrName').value.trim();
      const teacher = document.getElementById('vrTeacher').value.trim();
      const bookId = document.getElementById('vrBook').value;
      const startRangeTxt = document.getElementById('vrStartRange').value.trim();
      const unitSize = parseInt(document.getElementById('vrUnit').value,10);
      const overlap = Math.max(0, parseInt(document.getElementById('vrOverlap').value,10));
      const overlapMode = document.getElementById('vrOverlapMode').value; // 'end' | 'front'
      const dows = Array.from(document.querySelectorAll('.vr-dow:checked')).map(x=>parseInt(x.value,10)).sort((a,b)=>a-b);
      const startDate = document.getElementById('vrStartDate').value || todayYMD();
      const maxUnit = parseInt(document.getElementById('vrMaxUnit').value,10) || undefined;
      const occurrences = parseInt(document.getElementById('vrOcc').value,10) || 40;

      if(!name || !teacher || !bookId || !startRangeTxt || !unitSize || dows.length===0){
        alert('í•™ìƒ/ì„ ìƒë‹˜/êµì¬/ì‹œì‘ë²”ìœ„/ë‹¨ìœ„/ìš”ì¼ì„ í™•ì¸í•˜ì„¸ìš”.'); return;
      }
      const r0 = vocabParseRange(startRangeTxt);
      if(!r0){ alert('ì‹œì‘ ë²”ìœ„ëŠ” "1-3" í˜•íƒœë¡œ ì…ë ¥í•˜ì„¸ìš”.'); return; }

      const ref = db.ref('vocab/rules');
      const id = ref.push().key;
      const rule = { student:name, teacher, bookId, startRange:startRangeTxt, unitSize, overlap, overlapMode, weekdays:dows, startDate, maxUnit:(maxUnit || r0.end), occurrences };
      ref.child(id).set(rule).then(()=>{
        // ì¼ì • ìƒì„±
        vocabRegenForRule(id, true);
        document.getElementById('vrStartRange').value='';
      });
    }
    function vocabDeleteRule(id){
      if(!confirm('ì´ ê·œì¹™ì„ ì‚­ì œí• ê¹Œìš”? (ì´ë¯¸ ìƒì„±ëœ ì´ë²¤íŠ¸ëŠ” ìœ ì§€ë©ë‹ˆë‹¤)')) return;
      db.ref(`vocab/rules/${id}`).remove();
    }

    function vocabRegenForRule(ruleId, clearExisting){
      const r = (vocab.rules||{})[ruleId];
      if(!r) return;
      const book = vocab.books[r.bookId];
      const unitsCount = book ? (book.units||[]).length : (r.maxUnit||9999);
      const dates = vocabNextDates(r.startDate, r.weekdays||[], r.occurrences||40);

      let cur = vocabParseRange(r.startRange);
      if(!cur) return;
      cur.start = clamp(cur.start,1,unitsCount);
      cur.end   = clamp(cur.end,  1,unitsCount);

      const evRef = db.ref('vocab/events');
      // ê¸°ì¡´ ì´ë²¤íŠ¸ ì œê±°(í•´ë‹¹ ê·œì¹™ë§Œ)
      if(clearExisting){
        const all = Object.entries(vocab.events||{});
        const updates = {};
        all.forEach(([eid, ev])=>{
          if(ev.ruleId===ruleId) updates[eid] = null;
        });
        evRef.update(updates);
      }

      // ìƒˆ ì´ë²¤íŠ¸ ìƒì„±
      let batch = {};
      for(let i=0;i<dates.length;i++){
        if(cur.start > unitsCount) break;
        if(cur.end > unitsCount) cur.end = unitsCount;

        const eid = evRef.push().key;
        batch[eid] = {
          id: eid, ruleId: ruleId, student: r.student, teacher: r.teacher, bookId: r.bookId,
          date: dates[i], rangeStart: cur.start, rangeEnd: cur.end, done: false
        };

        // ë‹¤ìŒ ë²”ìœ„
        let nextStart;
        if(r.overlapMode==='front'){
          nextStart = cur.start + (r.overlap||0);
        }else{
          nextStart = cur.end - Math.max(0,(r.overlap||0)-1);
        }
        nextStart = clamp(nextStart,1,unitsCount);
        let nextEnd = nextStart + (r.unitSize-1);
        nextEnd = clamp(nextEnd,1,unitsCount);
        cur = {start: nextStart, end: nextEnd};

        if(cur.start > r.maxUnit) break;
        if(cur.end > r.maxUnit) cur.end = r.maxUnit;
      }
      if(Object.keys(batch).length){
        evRef.update(batch);
      }
    }

    // ---- TODAY / UPCOMING
    function vocabRenderToday(){
      const listEl = document.getElementById('vocabTodayList');
      const emptyEl = document.getElementById('vocabTodayEmpty');
      if(!listEl) return;

      const list = Object.values(vocab.events||{}).filter(e=>e.date===currentViewDate)
        .sort((a,b)=> a.student.localeCompare(b.student));
      listEl.innerHTML = '';
      if(list.length===0){ emptyEl.style.display='block'; return; }
      emptyEl.style.display='none';

      list.forEach(ev=>{
        const book = vocab.books[ev.bookId];
        const names = [];
        if(book && book.units){
          for(let i=ev.rangeStart;i<=ev.rangeEnd;i++){
            if(book.units[i-1]) names.push(book.units[i-1]);
          }
        }
        const row = document.createElement('div');
        row.className='p-3 border rounded bg-white flex items-center justify-between gap-3';
        row.innerHTML = `
          <div>
            <div class="font-medium">${escapeHTML(ev.student)} <span class="text-slate-400">(${escapeHTML(ev.teacher)})</span></div>
            <div class="text-sm text-slate-600">êµì¬: ${book?escapeHTML(book.name):'?'} Â· ë²”ìœ„: ${ev.rangeStart}â€“${ev.rangeEnd}</div>
            <div class="text-xs text-slate-500">${escapeHTML(names.join(' Â· '))}</div>
          </div>
          <div class="flex items-center gap-2">
            <label class="text-sm"><input type="checkbox" ${ev.done?'checked':''} onchange="vocabToggleDone('${ev.id}', this.checked)"/> ì™„ë£Œ</label>
            <button class="btn btn-secondary" onclick="vocabDeleteEvent('${ev.id}')">ì‚­ì œ</button>
          </div>
        `;
        listEl.appendChild(row);
      });
    }
    function vocabRenderUpcoming(){
      const box = document.getElementById('vocabUpcomingList');
      if(!box) return;
      box.innerHTML='';

      const today = todayYMD();
      const until = addDays(today, 14);
      const arr = Object.values(vocab.events||{}).filter(ev=> ev.date>=today && ev.date<=until)
        .sort((a,b)=> a.date.localeCompare(b.date) || a.student.localeCompare(b.student));

      if(arr.length===0){
        box.innerHTML = `<div class="text-slate-500">2ì£¼ ì´ë‚´ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
        return;
      }
      let cur=''; let group=null;
      arr.forEach(ev=>{
        if(ev.date!==cur){
          cur = ev.date;
          group = document.createElement('div');
          group.className='border rounded p-3 bg-slate-50';
          group.innerHTML = `<div class="font-semibold mb-2">${formatDateKorean(cur)} (${cur})</div>`;
          box.appendChild(group);
        }
        const book = vocab.books[ev.bookId];
        const names=[];
        if(book && book.units){
          for(let i=ev.rangeStart;i<=ev.rangeEnd;i++){
            if(book.units[i-1]) names.push(book.units[i-1]);
          }
        }
        const row = document.createElement('div');
        row.className='pl-2 py-2 border-b last:border-b-0 flex items-center justify-between';
        row.innerHTML = `
          <div>
            <div class="font-medium">${escapeHTML(ev.student)} <span class="text-slate-400">(${escapeHTML(ev.teacher)})</span></div>
            <div class="text-sm text-slate-600">êµì¬: ${book?escapeHTML(book.name):'?'} Â· ë²”ìœ„: ${ev.rangeStart}â€“${ev.rangeEnd}</div>
            <div class="text-xs text-slate-500">${escapeHTML(names.join(' Â· '))}</div>
          </div>
          <div class="flex items-center gap-2">
            <label class="text-sm"><input type="checkbox" ${ev.done?'checked':''} onchange="vocabToggleDone('${ev.id}', this.checked)"/> ì™„ë£Œ</label>
            <button class="btn btn-secondary" onclick="vocabDeleteEvent('${ev.id}')">ì‚­ì œ</button>
          </div>
        `;
        group.appendChild(row);
      });
    }
    function vocabToggleDone(id, val){
      db.ref(`vocab/events/${id}/done`).set(!!val);
    }
    function vocabDeleteEvent(id){
      if(!confirm('ì´ ë‹¨ì–´ì‹œí—˜ ì¼ì •ì„ ì‚­ì œí• ê¹Œìš”?')) return;
      db.ref(`vocab/events/${id}`).remove();
    }

    // ---- Import/Export
    function vocabExport(){
      const data = JSON.stringify({books:vocab.books||{}, rules:vocab.rules||{}, events:vocab.events||{}}, null, 2);
      const blob = new Blob([data], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download='vocab_scheduler_backup.json';
      a.click();
      URL.revokeObjectURL(url);
    }
    function vocabImport(ev){
      const file = ev.target.files?.[0];
      if(!file) return;
      const fr = new FileReader();
      fr.onload = () => {
        try{
          const obj = JSON.parse(fr.result);
          if(!obj || obj.books===undefined || obj.rules===undefined || obj.events===undefined) throw new Error('í˜•ì‹ ì˜¤ë¥˜');
          const updates = {};
          // ì „ë¶€ ë®ì–´ì“°ê¸°
          updates['vocab/books'] = obj.books || {};
          updates['vocab/rules'] = obj.rules || {};
          updates['vocab/events'] = obj.events || {};
          db.ref().update(updates).then(()=> alert('ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ!'));
        }catch(e){ alert('ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: '+e.message); }
      };
      fr.readAsText(file, 'utf-8');
    }

    // ---- Seed Demo
    function vocabSeedDemo(){
      if(!confirm('ì˜ˆì‹œ ê·œì¹™/êµì¬ë¥¼ ì¶”ê°€í• ê¹Œìš”? (ê¸°ì¡´ ë°ì´í„°ëŠ” ìœ ì§€)')) return;
      // êµì¬ 1ê°œ ì—†ìœ¼ë©´ ìƒì„±
      const books = Object.entries(vocab.books||{});
      let bookId;
      if(books.length===0){
        const ref = db.ref('vocab/books');
        bookId = ref.push().key;
        const units = Array.from({length:60},(_,i)=>`Lesson ${i+1}`);
        ref.child(bookId).set({name:'ê³ êµê¸°ë³¸', units});
      }else{
        bookId = books[0][0];
      }
      const rRef = db.ref('vocab/rules');
      const rid = rRef.push().key;
      const start = todayYMD();
      const rule = {
        student:'í™ê¸¸ë™', teacher:'ê°•ë¯¼ì±„', bookId,
        startRange:'1-3', unitSize:3, overlap:1, overlapMode:'end',
        weekdays:[1,5], startDate:start, maxUnit:30, occurrences:16
      };
      rRef.child(rid).set(rule).then(()=> vocabRegenForRule(rid,true));
      alert('ì˜ˆì‹œ ê·œì¹™ ìƒì„± ì™„ë£Œ (ì›”/ê¸ˆ: 1â€“3 â†’ 3â€“5 â†’ 5â€“7 â€¦)');
    }

    function vocabRenderAll(){
      vocabRenderToday(); vocabRenderUpcoming(); vocabRenderBooks(); vocabRenderRules();
      vocabPopulateBookSelect();
    }

    /* ===================== ì´ˆê¸°í™” ===================== */
    window.addEventListener('load', () => {
      updateDateDisplay();
      attachListenersForDate();
      attachGlobalListenersOnce();
      const nt = document.getElementById('newTaskInput');
      if (nt) nt.addEventListener('keydown', (e) => { if (e.key === 'Enter') addNewTask(); });
      vocabSwitchTab('today');
    });
  </script>
</body>
</html>
