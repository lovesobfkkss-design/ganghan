<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>학원 업무 체크리스트 + 단어시험 스케줄러</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    .notification-badge {
      position: fixed; top: 20px; right: 20px;
      background: #ef4444; color: white; width: 50px; height: 50px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-weight: bold; font-size: 18px; cursor: pointer;
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4); z-index: 999; animation: pulse 2s infinite;
    }
    @keyframes pulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.1)} }
    .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; z-index:1100; }
    .modal-card { position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:#fff; width:96%; max-width:720px; border-radius:16px; box-shadow:0 20px 60px rgba(0,0,0,.2); padding:20px; display:none; z-index:1110; }

    /* 단어 스케줄러 내부 버튼/입력 프리셋 */
    .btn{padding:.5rem .8rem;border-radius:.4rem;border:1px solid #e5e7eb;background:#0ea5e9;color:#fff}
    .btn-secondary{background:#f8fafc;color:#0f172a}
    .input{border:1px solid #e5e7eb;border-radius:.4rem;padding:.45rem .6rem}
    .pill{padding:.15rem .5rem;border-radius:9999px;background:#f1f5f9;font-size:.75rem}

    /* 터치 영역 개선 - 최소 44x44px 확보 */
    .delete-btn {
      min-width: 44px;
      min-height: 44px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    .main-tab-btn {
      padding: 0.5rem 0.9rem;
      border-radius: 0.5rem;
      font-size: 0.95rem;
      font-weight: 600;
    }
    .main-tab-btn-active {
      background: #4f46e5;
      color: #fff;
    }
    .main-tab-btn-inactive {
      background: #f3f4f6;
      color: #374151;
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
  <!-- 알림 배지 / 패널 -->
  <div id="notificationBadge" class="notification-badge" onclick="toggleNotification()" style="display:none;">
    <span id="notificationCount">0</span>
  </div>
  <div id="notificationPanel" style="display:none; position: fixed; top: 80px; right: 20px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); max-width: 420px; z-index: 1000;">
    <div style="display:flex; justify-content:space-between; margin-bottom: 15px;">
      <div style="font-weight:bold; font-size:1.25rem;">🔔 알림</div>
      <button onclick="toggleNotification()" style="font-size:1.5rem; color:#6b7280; cursor:pointer; border:none; background:none;">✕</button>
    </div>
    <div id="notificationContent" class="text-sm leading-6"></div>
  </div>

  <!-- 설정 모달 -->
  <div id="settingsBackdrop" class="modal-backdrop"></div>
  <div id="settingsModal" class="modal-card">
    <div class="flex items-center justify-between mb-3">
      <h3 class="text-xl font-bold">⚙️ 기본 체크리스트 설정</h3>
      <button onclick="closeSettings()" class="text-gray-500 text-2xl leading-none">✕</button>
    </div>
    <p class="text-sm text-gray-600 mb-2">아래 항목들은 <b>매일 최초 로드 시 자동 생성</b>됩니다. (줄바꿈 기준)</p>
    <textarea id="defaultTasksInput" class="w-full h-40 border rounded-lg p-3 mb-3" placeholder="예)\n청소 상태 확인\n단어 만들기\n오다비 보내기\n숙제 확인"></textarea>
    <div class="flex items-center justify-between mb-1">
      <div class="text-sm text-gray-500">변경 후 <b>저장</b>을 누르면 다음 날짜부터 새 목록이 시드됩니다.</div>
      <div class="flex gap-2">
        <button onclick="resetToRecommended()" class="px-3 py-2 rounded bg-gray-100">추천 기본값</button>
        <button onclick="saveDefaultTasks()" class="px-4 py-2 rounded bg-indigo-600 text-white hover:bg-indigo-700">저장</button>
      </div>
    </div>
  </div>

  <!-- 달력 모달 -->
  <div id="calendarBackdrop" class="modal-backdrop" onclick="closeCalendar()"></div>
  <div id="calendarModal" class="modal-card" style="max-width: 400px;">
    <div class="flex items-center justify-between mb-4">
      <button onclick="changeCalendarMonth(-1)" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded">◀</button>
      <h3 class="text-xl font-bold" id="calendarTitle">2025년 1월</h3>
      <button onclick="changeCalendarMonth(1)" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded">▶</button>
    </div>
    <div id="calendarGrid" class="grid grid-cols-7 gap-1 text-center"></div>
    <div class="mt-4 flex justify-end">
      <button onclick="closeCalendar()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">닫기</button>
    </div>
  </div>

  <div class="max-w-5xl mx-auto">
    <!-- 날짜 헤더 -->
    <div class="bg-white rounded-2xl shadow-xl p-4 mb-4">
      <div class="flex items-center justify-between gap-2">
        <button onclick="changeDate(-1)" class="px-3 md:px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 text-sm md:text-base">
          <span class="md:hidden">←</span>
          <span class="hidden md:inline">← 전날</span>
        </button>
        <div class="text-center flex-1 cursor-pointer" onclick="openCalendar()">
          <div class="text-lg md:text-xl font-bold" id="currentDate">로딩중...</div>
          <div id="dateInfo" class="text-xs md:text-sm font-bold text-green-600">오늘 📅</div>
        </div>
        <div class="flex gap-1 md:gap-2">
          <button onclick="openSettings()" class="px-2 md:px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-800 text-sm md:text-base">
            <span class="md:hidden">⚙️</span>
            <span class="hidden md:inline">⚙️ 설정</span>
          </button>
          <button onclick="goToToday()" class="px-2 md:px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm md:text-base whitespace-nowrap">
            <span class="md:hidden">📍</span>
            <span class="hidden md:inline">오늘</span>
          </button>
          <button onclick="changeDate(1)" class="px-3 md:px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 text-sm md:text-base">
            <span class="md:hidden">→</span>
            <span class="hidden md:inline">다음날 →</span>
          </button>
        </div>
      </div>
    </div>

    <!-- 메인 탭 -->
    <div class="bg-white rounded-2xl shadow-xl p-3 mb-6">
      <div class="flex flex-wrap gap-2">
        <button id="mainTabBtn-work" class="main-tab-btn main-tab-btn-active" onclick="switchMainTab('work')">업무</button>
        <button id="mainTabBtn-tutoring" class="main-tab-btn main-tab-btn-inactive" onclick="switchMainTab('tutoring')">보강</button>
        <button id="mainTabBtn-retest" class="main-tab-btn main-tab-btn-inactive" onclick="switchMainTab('retest')">재시험</button>
        <button id="mainTabBtn-vocab" class="main-tab-btn main-tab-btn-inactive" onclick="switchMainTab('vocab')">단어시험</button>
        <button id="mainTabBtn-homework" class="main-tab-btn main-tab-btn-inactive" onclick="switchMainTab('homework')">숙제</button>
        <button id="mainTabBtn-students" class="main-tab-btn main-tab-btn-inactive" onclick="switchMainTab('students')">학생</button>
        <button id="mainTabBtn-guide" class="main-tab-btn main-tab-btn-inactive" onclick="switchMainTab('guide')">가이드</button>
      </div>
    </div>

    <!-- 메인 카드 -->
    <div id="mainTab-work">
    <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
      <div class="flex items-center justify-between mb-4">
        <div>
          <h1 class="text-3xl font-bold text-gray-800">학원 업무 체크리스트</h1>
          <p class="text-xs text-green-600 mt-1">✅ 전체 조교 공유 모드 (실시간 동기화)</p>
        </div>
        <div class="text-right">
          <div class="text-4xl font-bold text-indigo-600" id="completedCount">0/0</div>
          <div class="text-sm text-gray-600">완료</div>
        </div>
      </div>

      <div class="w-full bg-gray-200 rounded-full h-3 mb-6">
        <div id="progressBar" class="bg-indigo-600 h-3 rounded-full transition-all duration-300" style="width:0%"></div>
      </div>

      <div class="mb-4 grid grid-cols-1 md:grid-cols-3 gap-2">
        <input type="text" id="newTaskInput" placeholder="새 체크리스트 항목 추가" class="border rounded-lg px-3 py-2">
        <input type="text" id="newTaskNoteInput" placeholder="(선택) 메모/내용" class="border rounded-lg px-3 py-2">
        <button onclick="addNewTask()" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">+ 추가</button>
      </div>

      <div id="dailyTasksList" class="space-y-3">
        <div class="text-center text-gray-500 py-4">로딩중...</div>
      </div>
    </div>

    <!-- 국어 코칭 -->
    <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">📚 국어 코칭 (<span id="koreanCount">0</span>명)</h2>
      <div class="grid grid-cols-1 md:grid-cols-4 gap-2 mb-4">
        <div class="relative">
          <input type="text" id="koreanName" placeholder="학생 이름 (목록에서 선택)" list="studentsList" class="border rounded-lg px-3 py-2 w-full"
                 onchange="showStudentInfo(this.value, 'koreanInfo')">
          <div id="koreanInfo" class="text-xs text-gray-600 mt-1"></div>
        </div>
        <input type="text" id="koreanScore" placeholder="점수" class="border rounded-lg px-3 py-2">
        <select id="koreanAttendance" class="border rounded-lg px-3 py-2">
          <option>출석</option><option>결석</option><option>지각</option>
        </select>
        <input type="text" id="koreanWrong" placeholder="틀린 문제" class="border rounded-lg px-3 py-2">
      </div>
      <button onclick="addKorean()" class="w-full bg-indigo-600 text-white rounded-lg py-2 mb-4 hover:bg-indigo-700">+ 학생 추가</button>
      <div id="koreanList" class="space-y-2"></div>
    </div>

    <!-- 역사/과학 관리반 -->
    <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">🧭 역사/과학 관리반 (<span id="hsMgmtCount">0</span>명)</h2>
      <div class="grid grid-cols-1 md:grid-cols-4 gap-2 mb-4">
        <select id="hsSubject" class="border rounded-lg px-3 py-2">
          <option value="역사">역사</option>
          <option value="과학">과학</option>
        </select>
        <div class="relative">
          <input type="text" id="hsName" placeholder="학생 이름 (목록에서 선택)" list="studentsList" class="border rounded-lg px-3 py-2 w-full"
                 onchange="showStudentInfo(this.value, 'hsInfo')">
          <div id="hsInfo" class="text-xs text-gray-600 mt-1"></div>
        </div>
        <input type="text" id="hsScore" placeholder="점수" class="border rounded-lg px-3 py-2">
        <input type="text" id="hsRange" placeholder="학습 범위/메모" class="border rounded-lg px-3 py-2">
      </div>
      <button onclick="addHsMgmt()" class="w-full bg-indigo-600 text-white rounded-lg py-2 mb-4 hover:bg-indigo-700">+ 학생 추가</button>
      <div id="hsMgmtList" class="space-y-2"></div>
    </div>

    <!-- 타이핑 -->
    <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">⌨️ 타이핑 업무 (<span id="typingCount">0</span>개)</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-4">
        <input type="text" id="typingTask" placeholder="업무 내용" class="border rounded-lg px-3 py-2">
        <input type="text" id="typingProgress" placeholder="완료 범위" class="border rounded-lg px-3 py-2">
      </div>
      <button onclick="addTyping()" class="w-full bg-indigo-600 text-white rounded-lg py-2 mb-4 hover:bg-indigo-700">+ 업무 추가</button>
      <div id="typingList" class="space-y-2"></div>
    </div>
    </div>

    <!-- 과목별 보강 (수학/영어) -->
    <div id="mainTab-tutoring" class="hidden">
    <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">
        📚 과목별 보강 (<span id="tutoringCount">0</span>명)
        <span id="todayTutoringBadge" class="bg-blue-500 text-white text-sm px-3 py-1 rounded-full ml-2" style="display:none;">오늘 0명</span>
      </h2>
      <div class="mb-3 flex gap-2">
        <button id="tutoringFilterAll" class="px-4 py-2 rounded-lg bg-indigo-600 text-white" onclick="setTutoringFilter('all')">전체</button>
        <button id="tutoringFilterMath" class="px-4 py-2 rounded-lg bg-gray-200 text-gray-700" onclick="setTutoringFilter('math')">수학</button>
        <button id="tutoringFilterEnglish" class="px-4 py-2 rounded-lg bg-gray-200 text-gray-700" onclick="setTutoringFilter('english')">영어</button>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-6 gap-2 mb-4">
        <select id="tutoringSubject" class="border rounded-lg px-3 py-2">
          <option value="math">수학</option>
          <option value="english">영어</option>
        </select>
        <div class="relative">
          <input type="text" id="tutoringName" placeholder="학생 이름 (목록에서 선택)" list="studentsList" class="border rounded-lg px-3 py-2 w-full"
                 onchange="showStudentInfo(this.value, 'tutoringInfo')">
          <div id="tutoringInfo" class="text-xs text-gray-600 mt-1"></div>
        </div>
        <input type="time" id="tutoringTime" class="border rounded-lg px-3 py-2">
        <input type="text" id="tutoringTopic" placeholder="주제" class="border rounded-lg px-3 py-2">
        <input type="text" id="tutoringRange" placeholder="범위/내용" class="border rounded-lg px-3 py-2">
        <input type="text" id="tutoringNote" placeholder="특이사항" class="border rounded-lg px-3 py-2">
      </div>
      <button onclick="addTutoring()" class="w-full bg-blue-600 text-white rounded-lg py-2 mb-4 hover:bg-blue-700">+ 보강 추가</button>
      <div id="tutoringList"></div>
    </div>

    <!-- 📊 학생 데이터 분석 -->
    <div class="bg-white rounded-2xl shadow-xl p-6 mb-10">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-2xl font-bold text-gray-800">📊 과목별 보강 학생 분석</h2>
        <div class="flex gap-2">
          <select id="analysisSubjectFilter" class="border rounded-lg px-3 py-2" onchange="renderAnalysis()">
            <option value="all">전체 과목</option>
            <option value="math">수학만</option>
            <option value="english">영어만</option>
          </select>
        </div>
      </div>
      <div class="mb-4 flex gap-2">
        <button id="analysisTabSummary" class="btn" onclick="analysisSwitchTab('summary')">요약</button>
        <button id="analysisTabStudents" class="btn btn-secondary" onclick="analysisSwitchTab('students')">학생별 통계</button>
        <button id="analysisTabTimeline" class="btn btn-secondary" onclick="analysisSwitchTab('timeline')">기간별 통계</button>
      </div>

      <!-- 요약 탭 -->
      <section id="analysisViewSummary" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
          <div class="p-4 bg-blue-50 rounded-lg border-2 border-blue-200">
            <div class="text-sm text-blue-600 font-semibold">총 수학 보강 학생</div>
            <div class="text-3xl font-bold text-blue-800" id="analysisTotalStudents">0</div>
            <div class="text-xs text-blue-500">명</div>
          </div>
          <div class="p-4 bg-green-50 rounded-lg border-2 border-green-200">
            <div class="text-sm text-green-600 font-semibold">총 보강 횟수</div>
            <div class="text-3xl font-bold text-green-800" id="analysisTotalSessions">0</div>
            <div class="text-xs text-green-500">회</div>
          </div>
          <div class="p-4 bg-purple-50 rounded-lg border-2 border-purple-200">
            <div class="text-sm text-purple-600 font-semibold">최근 7일 보강</div>
            <div class="text-3xl font-bold text-purple-800" id="analysisWeekSessions">0</div>
            <div class="text-xs text-purple-500">회</div>
          </div>
          <div class="p-4 bg-orange-50 rounded-lg border-2 border-orange-200">
            <div class="text-sm text-orange-600 font-semibold">오늘 보강</div>
            <div class="text-3xl font-bold text-orange-800" id="analysisTodaySessions">0</div>
            <div class="text-xs text-orange-500">회</div>
          </div>
        </div>
        <div class="p-4 bg-gray-50 rounded-lg">
          <h3 class="font-semibold mb-2">자주 보강받는 학생 TOP 5</h3>
          <div id="analysisTopStudents" class="space-y-1"></div>
        </div>
        <div class="p-4 bg-gray-50 rounded-lg">
          <h3 class="font-semibold mb-2">자주 다루는 주제 TOP 5</h3>
          <div id="analysisTopTopics" class="space-y-1"></div>
        </div>
      </section>

      <!-- 학생별 통계 탭 -->
      <section id="analysisViewStudents" class="space-y-3 hidden">
        <div class="text-sm text-slate-600 mb-2">학생별 보강 내역 및 통계</div>
        <div id="analysisStudentsList" class="space-y-2"></div>
      </section>

      <!-- 기간별 통계 탭 -->
      <section id="analysisViewTimeline" class="space-y-3 hidden">
        <div class="text-sm text-slate-600 mb-2">최근 30일간의 보강 추이</div>
        <div id="analysisTimelineChart" class="p-4 bg-gray-50 rounded-lg"></div>
      </section>
    </div>
    </div>

    <!-- 재시험 (단어장/범위 포함) -->
    <div id="mainTab-retest" class="hidden">
    <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">
        📝 재시험 관리 (<span id="retestCount">0</span>명)
        <span id="todayRetestBadge" class="bg-red-500 text-white text-sm px-3 py-1 rounded-full ml-2" style="display:none;">오늘 0명</span>
      </h2>
      <div class="grid grid-cols-1 md:grid-cols-6 gap-2 mb-4">
        <div class="relative">
          <input type="text" id="retestName" placeholder="학생 이름 (목록에서 선택)" list="studentsList" class="border rounded-lg px-3 py-2 w-full"
                 onchange="showStudentInfo(this.value, 'retestInfo')">
          <div id="retestInfo" class="text-xs text-gray-600 mt-1"></div>
        </div>
        <input type="text" id="retestSubject" placeholder="과목" class="border rounded-lg px-3 py-2">
        <input type="text" id="retestVocabBook" placeholder="단어장" class="border rounded-lg px-3 py-2">
        <input type="text" id="retestVocabRange" placeholder="단어 범위 (예: Day 11~15)" class="border rounded-lg px-3 py-2">
        <input type="date" id="retestDate" class="border rounded-lg px-3 py-2">
        <input type="time" id="retestTime" class="border rounded-lg px-3 py-2">
      </div>
      <button onclick="addRetest()" class="w-full bg-red-600 text-white rounded-lg py-2 mb-4 hover:bg-red-700">+ 재시험 학생 추가</button>
      <div id="retestList"></div>
    </div>

    </div>

    <div id="mainTab-vocab" class="hidden">
    <!-- 클래스카드 테스트 -->
    <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">🃏 클래스카드 테스트</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mb-2">
        <textarea id="ccRosterInput" placeholder="명단: 쉼표(,) 또는 줄바꿈으로 학생 여러 명 입력" class="border rounded-lg px-3 py-2 h-24"></textarea>
        <textarea id="ccDoneInput" placeholder="완료자: 쉼표(,) 또는 줄바꿈으로 입력" class="border rounded-lg px-3 py-2 h-24"></textarea>
        <div class="flex flex-col gap-2">
          <button onclick="ccApplyRoster()" class="w-full bg-indigo-600 text-white rounded-lg py-2 hover:bg-indigo-700">명단 적용/덮어쓰기</button>
          <button onclick="ccApplyDone()" class="w-full bg-green-600 text-white rounded-lg py-2 hover:bg-green-700">완료자 적용</button>
          <button onclick="ccClearAll()" class="w-full bg-gray-200 text-gray-700 rounded-lg py-2 hover:bg-gray-300">초기화</button>
        </div>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <h3 class="font-bold mb-2">전체 명단 (<span id="ccRosterCount">0</span>)</h3>
          <div id="ccRosterList" class="space-y-1"></div>
        </div>
        <div>
          <h3 class="font-bold mb-2 text-red-600">미응시자 목록 (<span id="ccPendingCount">0</span>)</h3>
          <div id="ccPendingList" class="space-y-1"></div>
        </div>
      </div>
    </div>

    <!-- 누적 단어 테스트 -->
    <div class="bg-white rounded-2xl shadow-xl p-6 mb-10">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-2xl font-bold text-gray-800">🧠 누적 단어 테스트</h2>
        <button onclick="generateWeeklyVocabStats()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 flex items-center gap-2">
          📊 한 주 통계 생성
        </button>
      </div>

      <!-- 한 주 통계 표시 영역 -->
      <div id="weeklyVocabStats" class="mb-4 p-4 bg-purple-50 rounded-lg border border-purple-200" style="display:none;">
        <h3 class="font-bold text-purple-800 mb-2">📈 이번 주 학습 통계 (<span id="weekStatsRange"></span>)</h3>
        <div id="weeklyStatsContent" class="space-y-2 text-sm"></div>
        <button onclick="applyWeeklyStats()" class="mt-3 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 text-sm">
          ✅ 이 통계로 명단 생성
        </button>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mb-2">
        <textarea id="vaRosterInput" placeholder="명단: 쉼표(,) 또는 줄바꿈으로 학생 여러 명 입력" class="border rounded-lg px-3 py-2 h-24"></textarea>
        <textarea id="vaDoneInput" placeholder="완료자: 쉼표(,) 또는 줄바꿈으로 입력" class="border rounded-lg px-3 py-2 h-24"></textarea>
        <div class="flex flex-col gap-2">
          <button onclick="vaApplyRoster()" class="w-full bg-indigo-600 text-white rounded-lg py-2 hover:bg-indigo-700">명단 적용/덮어쓰기</button>
          <button onclick="vaApplyDone()" class="w-full bg-green-600 text-white rounded-lg py-2 hover:bg-green-700">완료자 적용</button>
          <button onclick="vaClearAll()" class="w-full bg-gray-200 text-gray-700 rounded-lg py-2 hover:bg-gray-300">초기화</button>
        </div>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <h3 class="font-bold mb-2">전체 명단 (<span id="vaRosterCount">0</span>)</h3>
          <div id="vaRosterList" class="space-y-1"></div>
        </div>
        <div>
          <h3 class="font-bold mb-2 text-red-600">미응시자 목록 (<span id="vaPendingCount">0</span>)</h3>
          <div id="vaPendingList" class="space-y-1"></div>
        </div>
      </div>
    </div>

    <!-- 🌟 단어시험 스케줄러 (겹침 옵션 포함) -->
    <div class="bg-white rounded-2xl shadow-xl p-6 mb-10">
      <div class="flex items-center justify-between">
        <h2 class="text-2xl font-bold text-gray-800">📘 단어시험 스케줄러</h2>
        <div class="flex gap-2">
          <button id="vocabTabToday" class="btn" onclick="vocabSwitchTab('today')">오늘</button>
          <button id="vocabTabUpcoming" class="btn btn-secondary" onclick="vocabSwitchTab('upcoming')">다가오는</button>
          <button id="vocabTabRules" class="btn btn-secondary" onclick="vocabSwitchTab('rules')">학생&규칙</button>
          <button id="vocabTabBooks" class="btn btn-secondary" onclick="vocabSwitchTab('books')">교재</button>
          <button id="vocabTabHelp" class="btn btn-secondary" onclick="vocabSwitchTab('help')">사용법</button>
          <button class="btn btn-secondary ml-2" onclick="vocabExport()">내보내기</button>
          <label class="btn btn-secondary cursor-pointer">
            불러오기<input id="vocabImportFile" type="file" accept="application/json" class="hidden" onchange="vocabImport(event)"/>
          </label>
        </div>
      </div>

      <!-- TODAY -->
      <section id="vocabViewToday" class="mt-4 space-y-3">
        <div class="text-sm text-slate-600">보기 날짜: <b id="vocabViewDateLabel">-</b> (상단 날짜 이동과 연동)</div>
        <div id="vocabTodayList" class="grid gap-3"></div>
        <div id="vocabTodayEmpty" class="text-slate-500">해당 날짜의 단어시험이 없습니다.</div>
      </section>

      <!-- UPCOMING -->
      <section id="vocabViewUpcoming" class="mt-4 space-y-3 hidden">
        <div class="text-sm text-slate-600">오늘 포함 2주 일정</div>
        <div id="vocabUpcomingList" class="grid gap-3"></div>
      </section>

      <!-- RULES -->
      <section id="vocabViewRules" class="mt-4 space-y-4 hidden">
        <div class="p-4 border rounded-xl">
          <h3 class="font-semibold mb-2">새 규칙 추가</h3>
          <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-3">
            <div>
              <label class="text-sm">학생 이름</label>
              <input id="vrName" class="input w-full" placeholder="예: 정수빈"/>
            </div>
            <div>
              <label class="text-sm">담당 선생님</label>
              <input id="vrTeacher" class="input w-full" placeholder="예: 강민채"/>
            </div>
            <div>
              <label class="text-sm">교재</label>
              <select id="vrBook" class="input w-full"></select>
            </div>
            <div>
              <label class="text-sm">시작 범위</label>
              <input id="vrStartRange" class="input w-full" placeholder="예: 1-3"/>
            </div>
            <div>
              <label class="text-sm">단위(회차당 과 수)</label>
              <input id="vrUnit" type="number" class="input w-full" value="3"/>
            </div>
            <div>
              <label class="text-sm">겹치는 과 수</label>
              <input id="vrOverlap" type="number" class="input w-full" value="1"/>
            </div>
            <div>
              <label class="text-sm">겹치는 방식</label>
              <select id="vrOverlapMode" class="input w-full">
                <option value="end">끝 과 겹치기 (예: 1–3 → 3–5)</option>
                <option value="front">앞에서 겹치기 (예: 1–3 → 2–4)</option>
              </select>
            </div>
            <div>
              <label class="text-sm">시험 요일</label>
              <div class="flex flex-wrap gap-2 mt-1">
                <label class="pill"><input type="checkbox" class="vr-dow" value="1"/> 월</label>
                <label class="pill"><input type="checkbox" class="vr-dow" value="2"/> 화</label>
                <label class="pill"><input type="checkbox" class="vr-dow" value="3"/> 수</label>
                <label class="pill"><input type="checkbox" class="vr-dow" value="4"/> 목</label>
                <label class="pill"><input type="checkbox" class="vr-dow" value="5"/> 금</label>
                <label class="pill"><input type="checkbox" class="vr-dow" value="6"/> 토</label>
                <label class="pill"><input type="checkbox" class="vr-dow" value="0"/> 일</label>
              </div>
              <p class="text-xs text-slate-500 mt-1">예) 월/금 → 월(1), 금(5) 체크</p>
            </div>
            <div>
              <label class="text-sm">시작 날짜</label>
              <input id="vrStartDate" type="date" class="input w-full"/>
            </div>
            <div>
              <label class="text-sm">마지막 과</label>
              <input id="vrMaxUnit" type="number" class="input w-full" value="50"/>
            </div>
            <div>
              <label class="text-sm">생성 회차(최대)</label>
              <input id="vrOcc" type="number" class="input w-full" value="40"/>
            </div>
          </div>
          <div class="mt-3 flex gap-2">
            <button class="btn" onclick="vocabAddRule()">규칙 추가 & 일정 생성</button>
            <button class="btn btn-secondary" onclick="vocabSeedDemo()">예시 규칙</button>
          </div>
        </div>

        <div class="p-4 border rounded-xl">
          <h3 class="font-semibold">등록된 규칙</h3>
          <div id="vocabRulesList" class="mt-2 grid gap-2"></div>
        </div>
      </section>

      <!-- BOOKS -->
      <section id="vocabViewBooks" class="mt-4 space-y-4 hidden">
        <div class="p-4 border rounded-xl">
          <h3 class="font-semibold mb-2">교재 추가</h3>
          <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-3">
            <div>
              <label class="text-sm">교재명</label>
              <input id="vbName" class="input w-full" placeholder="예: 고교기본"/>
            </div>
            <div>
              <label class="text-sm">총 과 수</label>
              <input id="vbCount" type="number" class="input w-full" placeholder="예: 60"/>
            </div>
            <div>
              <label class="text-sm">라벨 접두어</label>
              <input id="vbPrefix" class="input w-full" placeholder="예: Lesson"/>
            </div>
          </div>
          <div class="mt-3">
            <button class="btn" onclick="vocabAddBook()">교재 추가</button>
          </div>
        </div>

        <div class="p-4 border rounded-xl">
          <h3 class="font-semibold">교재 목록</h3>
          <div id="vocabBooksList" class="mt-2 grid gap-2"></div>
        </div>
      </section>

      <!-- HELP -->
      <section id="vocabViewHelp" class="mt-4 hidden">
        <div class="p-4 border rounded-xl text-sm text-slate-700 space-y-2">
          <p><b>쓰는 법(아주 쉬움)</b></p>
          <ol class="list-decimal pl-5 space-y-1">
            <li>아래 <b>교재</b> 탭에서 교재명과 총 과 수를 등록합니다. (예: 고교기본, 60과)</li>
            <li><b>학생&규칙</b> 탭에서 학생/선생/교재, 시작범위(예: 1-3), 단위(3), 겹침(1), <b>겹치는 방식</b>(끝/앞)과 <b>요일</b>(월/금) 선택 → <b>규칙 추가</b>.</li>
            <li>상단 날짜 이동과 연동되어, 해당 날짜가 되면 <b>오늘</b> 탭에 자동으로 범위와 교재가 뜹니다.</li>
            <li><b>연기 기능</b>: 학생이 결석한 경우 <b>연기</b> 버튼을 클릭하면 다음 예정 날짜로 자동 이동합니다.</li>
            <li>알림(🔔)에는 <b>오늘 단어시험</b>도 잡히며, JSON <b>내보내기/불러오기</b> 지원.</li>
          </ol>
          <p class="text-xs text-slate-500">※ "끝 과 겹치기" = 1–3 → 3–5 → 5–7 … / "앞에서 겹치기" = 1–3 → 2–4 → 3–5 …</p>
          <p class="text-xs text-orange-600 mt-2">※ 연기된 시험은 <b>주황색 배지</b>로 표시되며, 원래 예정 날짜가 함께 표시됩니다.</p>
        </div>
      </section>
    </div>

    </div>

    <!-- 숙제 관리 탭 -->
    <div id="mainTab-homework" class="hidden">
    <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">
        📝 숙제 관리 (<span id="homeworkCount">0</span>개)
        <span id="todayHomeworkBadge" class="bg-orange-500 text-white text-sm px-3 py-1 rounded-full ml-2" style="display:none;">오늘 마감 0개</span>
      </h2>

      <!-- 필터 영역 -->
      <div class="mb-4 flex flex-wrap gap-2 items-center">
        <div class="flex gap-2">
          <select id="homeworkClassFilterSelect" class="border rounded-lg px-3 py-2" onchange="setHomeworkClassFilter(this.value)">
            <option value="all">전체 수업</option>
          </select>
          <select id="homeworkStatusFilterSelect" class="border rounded-lg px-3 py-2" onchange="setHomeworkStatusFilter(this.value)">
            <option value="all">전체 상태</option>
            <option value="incomplete">미완료</option>
            <option value="completed">완료</option>
            <option value="overdue">기한 초과</option>
          </select>
        </div>
        <button onclick="toggleHomeworkForm()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">+ 숙제 추가</button>
        <button onclick="toggleClassesModal()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">수업 관리</button>
      </div>

      <!-- 엑셀 업로드 -->
      <div class="bg-amber-50 border-l-4 border-amber-400 p-4 mb-4 text-sm">
        <div class="font-semibold mb-1">📥 엑셀로 숙제 일괄 등록</div>
        <div class="text-xs text-amber-700 mb-1">헤더: 수업명 | 학생이름 | 숙제내용 | 마감일 | 교재 | 범위</div>
        <div class="text-xs text-amber-700 mb-2">필수: 수업명, 학생이름, 숙제내용, 마감일 / 선택: 교재, 범위</div>
        <label class="btn btn-secondary cursor-pointer">
          엑셀 선택
          <input id="homeworkExcelFile" type="file" accept=".xlsx,.xls" class="hidden" onchange="importHomeworkFromExcel(event)"/>
        </label>
      </div>

      <!-- 숙제 추가 폼 (토글) -->
      <div id="homeworkFormSection" class="bg-indigo-50 rounded-lg p-4 mb-4" style="display:none;">
        <h3 class="font-bold mb-3">새 숙제 등록</h3>

        <!-- 등록 방식 선택 -->
        <div class="mb-3 flex gap-2">
          <button id="hwModeIndividual" class="px-4 py-2 rounded-lg bg-indigo-600 text-white" onclick="setHwMode('individual')">개별 학생</button>
          <button id="hwModeBulk" class="px-4 py-2 rounded-lg bg-gray-200 text-gray-700" onclick="setHwMode('bulk')">반 전체 일괄</button>
        </div>

        <!-- 개별 학생 모드 -->
        <div id="hwIndividualMode">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mb-2">
            <select id="hwClassSelect" class="border rounded-lg px-3 py-2" onchange="onHwClassChange()">
              <option value="">수업 선택</option>
            </select>
            <div class="relative">
              <input type="text" id="hwStudentName" placeholder="학생 이름 (목록에서 선택)" list="hwStudentsList" class="border rounded-lg px-3 py-2 w-full"
                     onchange="onHwStudentChange(this.value)">
              <div id="hwStudentInfo" class="text-xs text-gray-600 mt-1"></div>
            </div>
            <datalist id="hwStudentsList"></datalist>
            <input type="text" id="hwTitle" placeholder="숙제 내용 (예: 교재 p.50~55)" class="border rounded-lg px-3 py-2">
          </div>
        </div>

        <!-- 반 전체 일괄 모드 -->
        <div id="hwBulkMode" style="display:none;">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-2">
            <select id="hwBulkClassSelect" class="border rounded-lg px-3 py-2" onchange="onHwBulkClassChange()">
              <option value="">수업 선택 (필수)</option>
            </select>
            <input type="text" id="hwBulkTitle" placeholder="숙제 내용 (예: 교재 p.50~55)" class="border rounded-lg px-3 py-2">
          </div>
          <div id="hwBulkStudentPreview" class="mb-2 p-3 bg-white rounded-lg border text-sm">
            <span class="text-gray-500">수업을 선택하면 해당 학생 목록이 표시됩니다</span>
          </div>
        </div>

        <!-- 공통 입력 필드 -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-2 mb-2">
          <input type="text" id="hwTextbook" placeholder="교재명 (선택)" class="border rounded-lg px-3 py-2">
          <input type="text" id="hwPageRange" placeholder="범위 (선택)" class="border rounded-lg px-3 py-2">
          <input type="date" id="hwDueDate" class="border rounded-lg px-3 py-2">
          <input type="text" id="hwDescription" placeholder="상세 설명 (선택)" class="border rounded-lg px-3 py-2">
        </div>
        <div class="flex gap-2">
          <button id="hwAddBtn" onclick="addHomework()" class="flex-1 bg-indigo-600 text-white rounded-lg py-2 hover:bg-indigo-700">+ 숙제 추가</button>
          <button id="hwBulkAddBtn" onclick="addBulkHomework()" class="flex-1 bg-green-600 text-white rounded-lg py-2 hover:bg-green-700" style="display:none;">+ 일괄 숙제 추가</button>
          <button onclick="toggleHomeworkForm()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">취소</button>
        </div>
      </div>

      <!-- 숙제 목록 -->
      <div id="homeworkList" class="space-y-4">
        <div class="text-center text-gray-500 py-4">로딩중...</div>
      </div>
    </div>

    <!-- 수업 관리 모달 -->
    <div id="classesModalBackdrop" class="modal-backdrop" onclick="toggleClassesModal()"></div>
    <div id="classesModal" class="modal-card" style="display:none;">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-bold">📚 수업 관리</h3>
        <button onclick="toggleClassesModal()" class="text-gray-500 text-2xl leading-none">✕</button>
      </div>

      <!-- 수업 추가 폼 -->
      <div class="bg-blue-50 rounded-lg p-4 mb-4">
        <h4 class="font-semibold mb-2">새 수업 추가</h4>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-2">
          <input type="text" id="newClassName" placeholder="수업명 (예: 중등수학A반)" class="border rounded-lg px-3 py-2">
          <select id="newClassSubject" class="border rounded-lg px-3 py-2">
            <option value="수학">수학</option>
            <option value="영어">영어</option>
            <option value="국어">국어</option>
            <option value="과학">과학</option>
            <option value="사회">사회</option>
            <option value="기타">기타</option>
          </select>
          <input type="text" id="newClassTeacher" placeholder="담당 선생님" class="border rounded-lg px-3 py-2">
          <input type="text" id="newClassSchedule" placeholder="수업 일정 (예: 월/수 16:00)" class="border rounded-lg px-3 py-2">
        </div>
        <div class="flex gap-2">
          <button onclick="addClass()" class="flex-1 bg-blue-600 text-white rounded-lg py-2 hover:bg-blue-700">+ 수업 추가</button>
          <button onclick="extractClassesFromStudents()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">학생 데이터에서 추출</button>
        </div>
      </div>

      <!-- 수업 목록 -->
      <div class="mb-2 flex gap-2">
        <button id="classStatusAll" class="px-3 py-1 rounded bg-indigo-600 text-white text-sm" onclick="setClassStatusFilter('all')">전체</button>
        <button id="classStatusActive" class="px-3 py-1 rounded bg-gray-200 text-gray-700 text-sm" onclick="setClassStatusFilter('active')">진행중</button>
        <button id="classStatusEnded" class="px-3 py-1 rounded bg-gray-200 text-gray-700 text-sm" onclick="setClassStatusFilter('ended')">종강</button>
      </div>
      <div id="classesList" class="space-y-2 max-h-80 overflow-y-auto">
        <div class="text-center text-gray-500 py-4">수업이 없습니다</div>
      </div>
    </div>

    <!-- 알림 메시지 모달 -->
    <div id="kakaoMessageBackdrop" class="modal-backdrop" onclick="toggleKakaoMessageModal()"></div>
    <div id="kakaoMessageModal" class="modal-card" style="display:none;">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-bold">📱 알림톡 메시지</h3>
        <button onclick="toggleKakaoMessageModal()" class="text-gray-500 text-2xl leading-none">✕</button>
      </div>
      <div class="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-4 mb-4">
        <pre id="kakaoMessageContent" class="whitespace-pre-wrap text-sm font-sans"></pre>
      </div>
      <div class="flex gap-2">
        <button onclick="copyKakaoMessage()" class="flex-1 bg-yellow-500 text-white rounded-lg py-2 hover:bg-yellow-600">📋 클립보드에 복사</button>
        <button onclick="toggleKakaoMessageModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">닫기</button>
      </div>
    </div>
    </div>

    <div id="mainTab-students" class="hidden">
    <!-- 학생 명단 관리 -->
    <div class="bg-white rounded-2xl shadow-xl mb-6">
      <!-- 클릭 가능한 헤더 -->
      <div class="p-6 cursor-pointer hover:bg-gray-50 rounded-t-2xl transition" onclick="toggleStudentSection()">
        <div class="flex items-center justify-between">
          <h2 class="text-2xl font-bold text-gray-800">👥 학생 명단 관리 (<span id="studentCount">0</span>명)</h2>
          <span id="studentToggleIcon" class="text-2xl transform transition-transform">▼</span>
        </div>
      </div>

      <!-- 접었다 펼 수 있는 내용 (기본: 숨김) -->
      <div id="studentContent" style="display: none;" class="px-6 pb-6">
        <!-- 검색 -->
        <div class="mb-4">
          <input type="text" id="studentSearchInput" placeholder="🔍 이름, 학년, 학교, 상태, 수업, 강사, 연락처로 검색..."
                 class="w-full border rounded-lg px-4 py-2"
                 oninput="renderStudents()">
        </div>

        <!-- 수업 탭 -->
        <div id="studentClassTabs" class="flex flex-wrap gap-2 mb-4"></div>

        <!-- 엑셀 업로드 -->
        <div class="bg-amber-50 border-l-4 border-amber-400 p-4 mb-4 text-sm">
          <div class="font-semibold mb-1">📥 엑셀 업로드</div>
          <div class="text-xs text-amber-700 mb-1">헤더: 수업명 | 담임강사 | 상태 | 이름 | 학년 | 학교 | 연락처 | 보호자연락처</div>
          <div class="text-xs text-amber-700 mb-2">수업이 여러 개면 쉼표로 구분하세요. (예: 수학, 영어)</div>
          <div class="flex flex-col md:flex-row gap-2">
            <label class="btn btn-secondary cursor-pointer">
              엑셀 선택
              <input id="studentExcelFile" type="file" accept=".xlsx,.xls" class="hidden" onchange="importStudentsFromExcel(event)"/>
            </label>
          </div>
        </div>

        <!-- 학생 추가 폼 -->
        <div class="bg-blue-50 rounded-lg p-4 mb-4">
          <h3 class="font-bold mb-2">새 학생 등록</h3>
          <div class="grid grid-cols-1 md:grid-cols-4 gap-2 mb-2">
            <input type="text" id="studentName" placeholder="이름" class="border rounded-lg px-3 py-2">
            <input type="text" id="studentGrade" placeholder="학년 (예: 중1, 고3)" class="border rounded-lg px-3 py-2">
            <input type="text" id="studentSchool" placeholder="학교" class="border rounded-lg px-3 py-2">
            <input type="text" id="studentStatus" placeholder="상태" class="border rounded-lg px-3 py-2">
            <input type="text" id="studentClasses" placeholder="수업 (예: 수학, 영어)" class="border rounded-lg px-3 py-2">
            <input type="text" id="studentTeacher" placeholder="담임강사" class="border rounded-lg px-3 py-2">
            <input type="text" id="studentPhone" placeholder="연락처" class="border rounded-lg px-3 py-2">
            <input type="text" id="parentPhone" placeholder="보호자연락처" class="border rounded-lg px-3 py-2">
          </div>
          <div class="flex gap-2">
            <button onclick="addStudent()" class="flex-1 bg-indigo-600 text-white rounded-lg py-2 hover:bg-indigo-700">+ 학생 추가</button>
            <button onclick="importInitialStudentsWithConfirm()" class="bg-green-600 text-white rounded-lg px-4 py-2 hover:bg-green-700 whitespace-nowrap">📥 초기 데이터 불러오기</button>
          </div>
        </div>

        <!-- 학생 목록 -->
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead class="bg-gray-100 text-left">
              <tr>
                <th class="px-3 py-2 rounded-tl-lg">이름</th>
                <th class="px-3 py-2">학년</th>
                <th class="px-3 py-2">학교</th>
                <th class="px-3 py-2">상태</th>
                <th class="px-3 py-2">수업</th>
                <th class="px-3 py-2">담임강사</th>
                <th class="px-3 py-2">연락처</th>
                <th class="px-3 py-2">보호자연락처</th>
                <th class="px-3 py-2 rounded-tr-lg">관리</th>
              </tr>
            </thead>
            <tbody id="studentList">
              <tr><td colspan="9" class="text-center py-4 text-gray-500">로딩중...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    </div>

    <div id="mainTab-guide" class="hidden">
    <!-- 📖 상세 사용 방법 -->
    <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">📖 사용 방법 가이드</h2>

      <!-- 기본 사용법 -->
      <div class="mb-6">
        <h3 class="text-lg font-bold text-indigo-600 mb-3">🔹 기본 사용법</h3>
        <div class="bg-indigo-50 border-l-4 border-indigo-500 p-4 mb-3">
          <h4 class="font-semibold mb-2">1️⃣ 날짜 이동</h4>
          <ul class="text-sm space-y-1 ml-4">
            <li>• <b>← 전날</b> 버튼: 하루 전 기록 확인</li>
            <li>• <b>오늘</b> 버튼: 오늘 날짜로 돌아가기</li>
            <li>• <b>다음날 →</b> 버튼: 하루 뒤 일정 확인</li>
          </ul>
        </div>
        <div class="bg-indigo-50 border-l-4 border-indigo-500 p-4 mb-3">
          <h4 class="font-semibold mb-2">2️⃣ 체크리스트 관리</h4>
          <ul class="text-sm space-y-1 ml-4">
            <li>• 새 항목 입력 후 <b>+ 추가</b> 버튼 클릭</li>
            <li>• 완료한 항목은 동그라미 버튼 클릭 (✓ 표시됨)</li>
            <li>• <b>메모</b> 버튼으로 세부 내용 작성 가능</li>
            <li>• <b>✕</b> 버튼으로 항목 삭제</li>
          </ul>
        </div>
        <div class="bg-indigo-50 border-l-4 border-indigo-500 p-4">
          <h4 class="font-semibold mb-2">3️⃣ 알림 확인</h4>
          <ul class="text-sm space-y-1 ml-4">
            <li>• 오른쪽 위 <b>빨간 원</b>: 오늘 해야 할 일 개수</li>
            <li>• 빨간 원 클릭하면 상세 알림 패널 열림</li>
            <li>• 미완료 체크리스트 + 오늘 재시험 + 오늘 보강 + 오늘 단어시험</li>
          </ul>
        </div>
      </div>

      <!-- 과목별 보강 -->
      <div class="mb-6">
        <h3 class="text-lg font-bold text-blue-600 mb-3">🔹 과목별 보강 (수학/영어)</h3>
        <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-3">
          <h4 class="font-semibold mb-2">📝 보강 등록하기</h4>
          <ul class="text-sm space-y-1 ml-4">
            <li><b>1.</b> 과목 선택 (수학 또는 영어)</li>
            <li><b>2.</b> 학생 이름 입력 (필수)</li>
            <li><b>3.</b> 시간 선택 (선택사항)</li>
            <li><b>4.</b> 주제, 범위, 특이사항 입력 (선택사항)</li>
            <li><b>5.</b> <b>+ 보강 추가</b> 버튼 클릭</li>
          </ul>
        </div>
        <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-3">
          <h4 class="font-semibold mb-2">🔍 보강 확인하기</h4>
          <ul class="text-sm space-y-1 ml-4">
            <li>• <b>전체/수학/영어</b> 버튼으로 필터링</li>
            <li>• <b>보라색 배지</b>: 수학 보강</li>
            <li>• <b>초록색 배지</b>: 영어 보강</li>
            <li>• 오늘 보강은 <b>파란색 박스</b>로 강조 표시</li>
          </ul>
        </div>
        <div class="bg-blue-50 border-l-4 border-blue-500 p-4">
          <h4 class="font-semibold mb-2">📊 통계 분석하기</h4>
          <ul class="text-sm space-y-1 ml-4">
            <li>• <b>보강</b> 탭에서 <b>📊 과목별 보강 학생 분석</b> 확인</li>
            <li>• 드롭다운에서 <b>전체 과목/수학만/영어만</b> 선택</li>
            <li>• <b>요약</b>: 총 학생 수, 보강 횟수, TOP 5 확인</li>
            <li>• <b>학생별 통계</b>: 각 학생의 보강 내역 및 주요 주제 확인</li>
            <li>• <b>기간별 통계</b>: 최근 30일 보강 추이 그래프</li>
          </ul>
        </div>
      </div>

      <!-- 단어시험 관리 -->
      <div class="mb-6">
        <h3 class="text-lg font-bold text-purple-600 mb-3">🔹 단어시험 스케줄러</h3>
        <div class="bg-purple-50 border-l-4 border-purple-500 p-4 mb-3">
          <h4 class="font-semibold mb-2">⚙️ 초기 설정 (처음 한 번만)</h4>
          <ul class="text-sm space-y-1 ml-4">
            <li><b>1.</b> <b>교재</b> 탭 클릭</li>
            <li><b>2.</b> 교재명 입력 (예: 고교기본)</li>
            <li><b>3.</b> 총 과 수 입력 (예: 60)</li>
            <li><b>4.</b> 라벨 접두어 입력 (예: Lesson) → <b>교재 추가</b> 클릭</li>
            <li><b>5.</b> <b>학생&규칙</b> 탭 클릭</li>
            <li><b>6.</b> 학생 정보 입력: 이름, 선생님, 교재 선택</li>
            <li><b>7.</b> 시작 범위 (예: 1-3), 단위 (예: 3), 겹침 (예: 1) 입력</li>
            <li><b>8.</b> 시험 요일 선택 (예: 월, 금)</li>
            <li><b>9.</b> 시작 날짜 선택 → <b>규칙 추가 & 일정 생성</b> 클릭</li>
          </ul>
        </div>
        <div class="bg-purple-50 border-l-4 border-purple-500 p-4 mb-3">
          <h4 class="font-semibold mb-2">📅 오늘 시험 확인하기</h4>
          <ul class="text-sm space-y-1 ml-4">
            <li>• <b>단어시험</b> 탭에서 <b>📘 단어시험 스케줄러</b> 확인</li>
            <li>• <b>오늘</b> 탭에서 오늘 시험 보는 학생 확인</li>
            <li>• 학생 이름, 교재, 범위(예: Lesson 1 · Lesson 2 · Lesson 3) 확인</li>
            <li>• 시험 완료 시 <b>완료</b> 체크박스 선택</li>
          </ul>
        </div>
        <div class="bg-purple-50 border-l-4 border-purple-500 p-4 mb-3">
          <h4 class="font-semibold mb-2">🔄 학생 결석 시 (시험 연기)</h4>
          <ul class="text-sm space-y-1 ml-4">
            <li><b>1.</b> 결석한 학생의 시험 찾기 (오늘 또는 다가오는 탭)</li>
            <li><b>2.</b> <b>연기</b> 버튼 클릭</li>
            <li><b>3.</b> 확인 메시지에서 날짜 확인 (예: 10월 30일 → 11월 1일)</li>
            <li><b>4.</b> <b>확인</b> 클릭하면 자동으로 다음 예정 날짜로 이동</li>
            <li><b>5.</b> <b>주황색 "연기됨" 배지</b>와 원래 예정 날짜 표시됨</li>
            <li>💡 <b>자동 계산</b>: 학생의 시험 요일(월/금 등)에 맞춰 자동으로 다음 날짜 찾아줌</li>
          </ul>
        </div>
        <div class="bg-purple-50 border-l-4 border-purple-500 p-4">
          <h4 class="font-semibold mb-2">📋 다가오는 일정 보기</h4>
          <ul class="text-sm space-y-1 ml-4">
            <li>• <b>다가오는</b> 탭 클릭</li>
            <li>• 오늘 포함 2주간의 단어시험 일정 확인</li>
            <li>• 날짜별로 그룹화되어 표시됨</li>
          </ul>
        </div>
      </div>

      <!-- 재시험 관리 -->
      <div class="mb-6">
        <h3 class="text-lg font-bold text-red-600 mb-3">🔹 재시험 관리</h3>
        <div class="bg-red-50 border-l-4 border-red-500 p-4">
          <h4 class="font-semibold mb-2">📝 재시험 등록하기</h4>
          <ul class="text-sm space-y-1 ml-4">
            <li><b>1.</b> 학생 이름, 과목 입력</li>
            <li><b>2.</b> 단어장, 단어 범위 입력 (선택사항)</li>
            <li><b>3.</b> 재시험 날짜 및 시간 선택</li>
            <li><b>4.</b> <b>+ 재시험 학생 추가</b> 버튼 클릭</li>
            <li>💡 오늘 재시험은 <b>빨간색 박스</b>로 강조 표시</li>
          </ul>
        </div>
      </div>

      <!-- 숙제 관리 -->
      <div class="mb-6">
        <h3 class="text-lg font-bold text-orange-600 mb-3">🔹 숙제 관리 + 알림톡</h3>
        <div class="bg-orange-50 border-l-4 border-orange-500 p-4 mb-3">
          <h4 class="font-semibold mb-2">📝 숙제 등록하기</h4>
          <ul class="text-sm space-y-1 ml-4">
            <li><b>1.</b> <b>숙제</b> 탭에서 <b>+ 숙제 추가</b> 버튼 클릭</li>
            <li><b>2.</b> 수업 선택, 학생 이름, 숙제 내용 입력</li>
            <li><b>3.</b> 교재명, 범위, 마감일 설정</li>
            <li><b>4.</b> <b>+ 숙제 추가</b> 버튼 클릭</li>
            <li>💡 마감일 기준으로 자동 정렬되며, 기한 초과 항목은 <b>빨간색</b>으로 표시</li>
          </ul>
        </div>
        <div class="bg-orange-50 border-l-4 border-orange-500 p-4 mb-3">
          <h4 class="font-semibold mb-2">📥 엑셀로 일괄 등록</h4>
          <ul class="text-sm space-y-1 ml-4">
            <li>• 헤더: <b>수업명 | 학생이름 | 숙제내용 | 마감일 | 교재 | 범위</b></li>
            <li>• 필수 항목: 수업명, 학생이름, 숙제내용, 마감일</li>
            <li>• 마감일 형식: YYYY-MM-DD (예: 2025-01-25)</li>
          </ul>
        </div>
        <div class="bg-orange-50 border-l-4 border-orange-500 p-4 mb-3">
          <h4 class="font-semibold mb-2">📚 수업 관리</h4>
          <ul class="text-sm space-y-1 ml-4">
            <li>• <b>수업 관리</b> 버튼으로 수업 추가/종강 관리</li>
            <li>• <b>학생 데이터에서 추출</b>: 학생 명단의 수업 정보에서 자동 생성</li>
            <li>• 종강된 수업은 숙제 추가 시 목록에서 제외됨</li>
          </ul>
        </div>
        <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4">
          <h4 class="font-semibold mb-2">📱 카카오 알림톡 발송</h4>
          <ul class="text-sm space-y-1 ml-4">
            <li><b>1.</b> 숙제 항목의 <b>📱</b> 버튼 클릭</li>
            <li><b>2.</b> 자동 생성된 알림 메시지 확인</li>
            <li><b>3.</b> <b>📋 클립보드에 복사</b> 버튼 클릭</li>
            <li><b>4.</b> 카카오톡에서 학부모에게 메시지 전송</li>
            <li>💡 메시지에 학생 이름, 숙제 내용, 마감일이 자동으로 포함됩니다</li>
          </ul>
        </div>
      </div>

      <!-- 기타 기능 -->
      <div>
        <h3 class="text-lg font-bold text-gray-600 mb-3">🔹 기타 기능</h3>
        <div class="grid md:grid-cols-2 gap-4">
          <div class="bg-gray-50 border-l-4 border-gray-500 p-4">
            <h4 class="font-semibold mb-2">📚 국어 코칭</h4>
            <p class="text-sm">학생별 점수, 출석, 틀린 문제 기록</p>
          </div>
          <div class="bg-gray-50 border-l-4 border-gray-500 p-4">
            <h4 class="font-semibold mb-2">🧭 역사/과학 관리반</h4>
            <p class="text-sm">과목별 학생 점수 및 학습 범위 관리</p>
          </div>
          <div class="bg-gray-50 border-l-4 border-gray-500 p-4">
            <h4 class="font-semibold mb-2">⌨️ 타이핑 업무</h4>
            <p class="text-sm">업무 내용 및 완료 범위 기록, 완료/재개 토글</p>
          </div>
          <div class="bg-gray-50 border-l-4 border-gray-500 p-4">
            <h4 class="font-semibold mb-2">🃏 클래스카드 / 🧠 누적 단어</h4>
            <p class="text-sm">명단 입력 후 완료자 체크, 미응시자 자동 표시</p>
          </div>
        </div>
      </div>
    </div>

    <!-- 간단 안내 -->
    <div class="bg-amber-50 border-2 border-amber-200 rounded-xl p-4">
      <h3 class="font-bold text-amber-800 mb-2">💡 빠른 팁</h3>
      <ul class="text-sm text-amber-700 space-y-1">
        <li>• 매일 자동으로 <b>설정한 기본 체크리스트</b>가 생성됩니다</li>
        <li>• <b>⚙️ 설정</b> 버튼으로 기본 체크리스트 항목 변경 가능</li>
        <li>• 모든 데이터는 <b>실시간 동기화</b>되어 여러 조교가 함께 사용 가능</li>
        <li>• 날짜 이동 후 다시 <b>오늘</b> 버튼으로 현재 날짜로 돌아오세요</li>
      </ul>
    </div>
    </div>
  </div>

  <!-- 학생 목록 datalist -->
  <datalist id="studentsList"></datalist>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <script>
    /* ===================== 공통 유틸 ===================== */
    function todayYMD() {
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    }
    function ymdOf(dateObj) {
      const y = dateObj.getFullYear();
      const m = String(dateObj.getMonth()+1).padStart(2,'0');
      const d = String(dateObj.getDate()).padStart(2,'0');
      return `${y}-${m}-${d}`;
    }
    function escapeHTML(s='') {
      return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }
    function escapeJS(s='') {
      return s.replace(/\\/g, '\\\\').replace(/'/g, "\\'");
    }
    function formatDateKorean(dateStr) {
      const d = new Date(dateStr + 'T00:00:00');
      const days = ['일','월','화','수','목','금','토'];
      return `${d.getMonth()+1}월 ${d.getDate()}일 (${days[d.getDay()]})`;
    }
    function parseClassList(value) {
      if (Array.isArray(value)) {
        return value.map(v => String(v || '').trim()).filter(Boolean);
      }
      const text = String(value || '').trim();
      if (!text) return [];
      return text.split(/[,/|]/).map(s => s.trim()).filter(Boolean);
    }
    function formatClassList(value) {
      const list = parseClassList(value);
      return list.length ? list.join(', ') : '';
    }
    const parseList = (text) =>
      text.split(/[\n,]/).map(s=>s.trim()).filter(Boolean);
    const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));
    function addDays(dateStr, n){
      const d = new Date(dateStr + 'T00:00:00');
      d.setDate(d.getDate()+n);
      return ymdOf(d);
    }

    const mainTabs = ['work', 'tutoring', 'retest', 'vocab', 'homework', 'students', 'guide'];
    function switchMainTab(name) {
      const selected = mainTabs.includes(name) ? name : 'work';
      localStorage.setItem('mainTab', selected);

      mainTabs.forEach(tab => {
        const section = document.getElementById(`mainTab-${tab}`);
        const btn = document.getElementById(`mainTabBtn-${tab}`);
        if (section) section.classList.toggle('hidden', tab !== selected);
        if (btn) {
          btn.classList.toggle('main-tab-btn-active', tab === selected);
          btn.classList.toggle('main-tab-btn-inactive', tab !== selected);
        }
      });
    }

    /* ===================== 상태 ===================== */
    let currentViewDate = todayYMD();

    let defaultDaily = [];    // 설정 기본 체크리스트
    let dailyTasks = {};      // {id: {label, checked, note}}
    let pastIncompleteDailyTasks = {}; // 과거 미완료 할일 {date: {id: {label, checked, note}}}
    let koreanCoaching = {};
    let hsMgmt = {};
    let typingTasks = {};
    let pastIncompleteTypingTasks = {}; // 과거 미완료 타이핑 {date: {id: {task, progress, completed}}}
    let tutoringSessions = {}; // {id: {subject, name, time, topic, range, note, date}}
    let tutoringFilter = 'all'; // 'all', 'math', 'english'
    let retestStudents = {};  // {id, name, subject, vocabBook, vocabRange, date, time}
    let students = {}; // {id: {name, grade, school, status, classes:[], teacher, studentPhone, parentPhone}}
    let studentClassFilter = 'all';

    // 클래스카드/누적단어
    let ccState = { roster:{}, done:{} };
    let vaState = { roster:{}, done:{} };

    // 숙제 관리
    let homework = {};        // {id: {classId, className, subject, studentId, studentName, title, description, textbook, pageRange, assignedDate, dueDate, completed, completedAt, feedback, notificationSent, notificationSentAt}}
    let classes = {};         // {id: {name, subject, teacher, status, schedule, createdAt, endedAt, autoExtracted}}
    let homeworkClassFilter = 'all';
    let homeworkStatusFilter = 'all';
    let homeworkRef, classesRef;

    /* ========= 🌟 단어 스케줄러 상태(Firebase 저장) ========= */
    const vocab = {
      books: {},   // bookId -> {name, units:[...]}
      rules: {},   // ruleId -> {student, teacher, bookId, startRange, unitSize, overlap, overlapMode, weekdays[], startDate, maxUnit, occurrences}
      events: {}   // eventId -> {ruleId, student, teacher, bookId, date, rangeStart, rangeEnd, done}
    };

    /* ===================== Firebase ===================== */
    const firebaseConfig = {
      apiKey: "AIzaSyCEPzrduTPO9_07SV3-2prXgWI-zQRsUA8",
      authDomain: "ganghanlucy.firebaseapp.com",
      databaseURL: "https://ganghanlucy-default-rtdb.firebaseio.com",
      projectId: "ganghanlucy",
      storageBucket: "ganghanlucy.appspot.com",
      messagingSenderId: "977455723921",
      appId: "1:977455723921:web:244babb9aee6a4d1061630"
    };
    try { firebase.initializeApp(firebaseConfig); } catch (e) { console.error('Firebase 초기화 실패:', e); }
    const db = firebase.database();

    /* ===== 리스너 ref ===== */
    let dailyRef=null, koreanRef=null, hsRef=null, typingRef=null, ccRef=null, vaRef=null, retestRef=null, settingsRef=null;
    // 단어 스케줄러 ref
    let vbRef=null, vrRef=null, veRef=null;
    // 분석용 전역 리스너 (모든 날짜의 보강 데이터)
    let tutoringAllRef=null;
    // 학생 관리 ref
    let studentsRef=null;

    /* ===================== 날짜 표시 ===================== */
    function updateDateDisplay() {
      const date = new Date(currentViewDate + 'T00:00:00');
      document.getElementById('currentDate').textContent = date.toLocaleDateString('ko-KR');
      const today = todayYMD();
      const infoEl = document.getElementById('dateInfo');
      if (currentViewDate === today) {
        infoEl.textContent = '오늘';
        infoEl.className = 'text-sm font-bold text-green-600';
      } else if (currentViewDate < today) {
        infoEl.textContent = '과거 기록';
        infoEl.className = 'text-sm font-bold text-orange-600';
      } else {
        infoEl.textContent = '미래';
        infoEl.className = 'text-sm font-bold text-blue-600';
      }
      // 단어 스케줄러 날짜 라벨
      const lbl = document.getElementById('vocabViewDateLabel');
      if(lbl) lbl.textContent = `${formatDateKorean(currentViewDate)} (${currentViewDate})`;
    }

    /* ===================== 기본 시드 ===================== */
    async function seedDefaultDaily(date) {
      const ref = db.ref('daily/' + date);
      const payload = {};
      const baseLabels = defaultDaily.length ? defaultDaily : ['청소 상태 확인','단어 만들기','오다비 보내기','숙제 확인'];
      baseLabels.forEach(label => {
        const key = ref.push().key;
        payload[key] = { label, checked: false, note: '' };
      });
      try { await ref.update(payload); } catch (err) { console.error('시드 데이터 생성 실패:', err); }
    }

    /* ===================== 설정 모달 ===================== */
    function openSettings() {
      document.getElementById('settingsBackdrop').style.display='block';
      document.getElementById('settingsModal').style.display='block';
      document.getElementById('defaultTasksInput').value = defaultDaily.length
        ? defaultDaily.join('\n')
        : '청소 상태 확인\n단어 만들기\n오다비 보내기\n숙제 확인';
    }
    function closeSettings() {
      document.getElementById('settingsBackdrop').style.display='none';
      document.getElementById('settingsModal').style.display='none';
    }
    function resetToRecommended() {
      document.getElementById('defaultTasksInput').value = '청소 상태 확인\n단어 만들기\n오다비 보내기\n숙제 확인';
    }
    function saveDefaultTasks() {
      const arr = parseList(document.getElementById('defaultTasksInput').value);
      db.ref('settings/defaultDailyTasks').set(arr)
        .then(()=>{ alert('저장되었습니다. 내일부터 새 목록으로 자동 생성됩니다.'); })
        .catch(err=>{ console.error(err); alert('저장 중 오류가 발생했습니다.'); });
      closeSettings();
    }

    // 달력 관련 함수
    let calendarYear, calendarMonth;

    function openCalendar() {
      // 현재 보는 날짜를 기준으로 달력 열기
      const [y, m, d] = currentViewDate.split('-').map(Number);
      calendarYear = y;
      calendarMonth = m;
      renderCalendar();
      document.getElementById('calendarBackdrop').style.display='block';
      document.getElementById('calendarModal').style.display='block';
    }

    function closeCalendar() {
      document.getElementById('calendarBackdrop').style.display='none';
      document.getElementById('calendarModal').style.display='none';
    }

    function changeCalendarMonth(direction) {
      calendarMonth += direction;
      if (calendarMonth < 1) {
        calendarMonth = 12;
        calendarYear--;
      } else if (calendarMonth > 12) {
        calendarMonth = 1;
        calendarYear++;
      }
      renderCalendar();
    }

    function renderCalendar() {
      document.getElementById('calendarTitle').textContent = `${calendarYear}년 ${calendarMonth}월`;

      const firstDay = new Date(calendarYear, calendarMonth - 1, 1);
      const lastDay = new Date(calendarYear, calendarMonth, 0);
      const daysInMonth = lastDay.getDate();
      const startDayOfWeek = firstDay.getDay(); // 0=일요일

      const today = todayYMD();
      const selectedDate = currentViewDate;

      let html = '';
      // 요일 헤더
      const dayNames = ['일', '월', '화', '수', '목', '금', '토'];
      dayNames.forEach(day => {
        html += `<div class="font-bold text-gray-700 py-2">${day}</div>`;
      });

      // 빈 칸 채우기 (이전 달 날짜)
      for (let i = 0; i < startDayOfWeek; i++) {
        html += `<div class="py-2"></div>`;
      }

      // 날짜 버튼들
      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${calendarYear}-${String(calendarMonth).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const isToday = dateStr === today;
        const isSelected = dateStr === selectedDate;

        let classes = 'py-2 px-1 rounded cursor-pointer hover:bg-indigo-100';
        if (isToday) classes += ' bg-green-200 font-bold';
        if (isSelected) classes += ' bg-indigo-600 text-white font-bold';

        html += `<div class="${classes}" onclick="selectDate('${dateStr}')">${day}</div>`;
      }

      document.getElementById('calendarGrid').innerHTML = html;
    }

    function selectDate(dateStr) {
      currentViewDate = dateStr;
      updateDateDisplay();
      detachListeners();
      attachListenersForDate();
      closeCalendar();
    }

    /* ===================== 렌더러 (체크리스트 등) ===================== */
    function renderDailyTasks() {
      const listEl = document.getElementById('dailyTasksList');
      const entries = Object.entries(dailyTasks);
      const completed = entries.filter(([_, t]) => t.checked).length;

      // 과거 미완료 항목 수집
      const pastEntries = [];
      for (const [date, tasks] of Object.entries(pastIncompleteDailyTasks)) {
        for (const [id, task] of Object.entries(tasks)) {
          pastEntries.push([date, id, task]);
        }
      }

      const total = entries.length + pastEntries.length;

      document.getElementById('completedCount').textContent = `${completed}/${total || 0}`;
      document.getElementById('progressBar').style.width = total > 0 ? ((completed / total) * 100) + '%' : '0%';

      let html = '';

      // 과거 미완료 항목 표시 (날짜 역순으로 정렬)
      if (pastEntries.length > 0) {
        const sortedPastEntries = pastEntries.sort((a, b) => b[0].localeCompare(a[0]));

        html += `<div class="mb-4 p-3 bg-orange-50 border-2 border-orange-300 rounded-xl">
          <h4 class="text-sm font-bold text-orange-700 mb-2">⚠️ 과거 미완료 항목 (${pastEntries.length}개)</h4>
        `;

        sortedPastEntries.forEach(([date, id, task]) => {
          const note = task.note || '';
          const dateLabel = formatDateKorean(date);
          html += `
            <div class="w-full p-3 mb-2 rounded-lg transition-all bg-white border-2 border-orange-200">
              <div class="flex items-center gap-3">
                <button title="완료 토글" onclick="togglePastTask('${date}', '${id}')" class="w-7 h-7 rounded-full flex items-center justify-center bg-white border-2 border-orange-400"></button>
                <span class="flex-1 text-left text-base text-gray-800 font-medium">${escapeHTML(task.label)}</span>
                <span class="text-xs text-orange-600 font-semibold">${dateLabel}</span>
                <button onclick="deletePastTask('${date}', '${id}')" class="delete-btn text-red-500 hover:text-red-700 text-xl" aria-label="삭제">✕</button>
              </div>
              ${note ? `<div class="mt-2 text-sm text-gray-700 bg-gray-50 border rounded p-2">${escapeHTML(note)}</div>` : ``}
            </div>
          `;
        });

        html += `</div>`;
      }

      // 현재 날짜 항목 표시
      if (!entries.length && !pastEntries.length) {
        html += `<div class="text-center text-gray-500 py-4">항목이 없습니다.</div>`;
      } else if (entries.length > 0) {
        html += entries.map(([id, task]) => {
          const checkedCls = task.checked ? 'bg-green-50 border-2 border-green-500' : 'bg-gray-50 border-2 border-gray-200 hover:border-indigo-300';
          const labelCls = task.checked ? 'text-gray-500 line-through' : 'text-gray-800 font-medium';
          const note = task.note || '';
          return `
            <div class="w-full p-4 rounded-xl transition-all ${checkedCls}">
              <div class="flex items-center gap-3">
                <button title="완료 토글" onclick="toggleTask('${id}')" class="w-7 h-7 rounded-full flex items-center justify-center ${task.checked ? 'bg-green-500 text-white' : 'bg-white border-2 border-gray-300'}">${task.checked ? '✓' : ''}</button>
                <span class="flex-1 text-left text-lg ${labelCls}">${escapeHTML(task.label)}</span>
                <button onclick="openNoteEditor('${id}')" class="px-2 py-1 text-sm rounded bg-yellow-100 border border-yellow-300 hover:bg-yellow-200">메모</button>
                <button onclick="deleteTask('${id}')" class="delete-btn text-red-500 hover:text-red-700 text-xl" aria-label="삭제">✕</button>
              </div>
              ${note ? `<div class="mt-2 text-sm text-gray-700 bg-white border rounded p-2">${escapeHTML(note)}</div>` : ``}
            </div>
          `;
        }).join('');
      }

      listEl.innerHTML = html;
    }

    function renderKorean() {
      const entries = Object.entries(koreanCoaching);
      document.getElementById('koreanCount').textContent = entries.length;
      document.getElementById('koreanList').innerHTML = entries.map(([id, s]) => `
        <div class="bg-indigo-50 rounded-lg p-4 flex justify-between items-center">
          <div class="flex-1">
            <div class="font-bold text-lg">${escapeHTML(s.name)}</div>
            <div class="text-sm text-gray-600">점수: ${escapeHTML(s.score||'')} | ${escapeHTML(s.attendance||'')} | 틀린 문제: ${escapeHTML(s.wrong||'')}</div>
          </div>
          <button onclick="deleteKorean('${id}')" class="delete-btn text-red-500 hover:text-red-700 ml-4 text-xl">✕</button>
        </div>
      `).join('') || `<div class="text-gray-500">등록된 학생이 없습니다.</div>`;
    }

    function renderHsMgmt() {
      const entries = Object.entries(hsMgmt);
      document.getElementById('hsMgmtCount').textContent = entries.length;
      document.getElementById('hsMgmtList').innerHTML = entries.map(([id, s]) => `
        <div class="bg-purple-50 rounded-lg p-4 flex justify-between items-center">
          <div class="flex-1">
            <div class="font-bold text-lg">${escapeHTML(s.name)} <span class="text-sm text-purple-700">(${escapeHTML(s.subject)})</span></div>
            <div class="text-sm text-gray-600">점수: ${escapeHTML(s.score||'')} | 범위: ${escapeHTML(s.range||'')}</div>
          </div>
          <button onclick="deleteHsMgmt('${id}')" class="delete-btn text-red-500 hover:text-red-700 ml-4 text-xl">✕</button>
        </div>
      `).join('') || `<div class="text-gray-500">등록된 학생이 없습니다.</div>`;
    }

    function renderTyping() {
      const entries = Object.entries(typingTasks);

      // 과거 미완료 타이핑 항목 수집
      const pastEntries = [];
      for (const [date, tasks] of Object.entries(pastIncompleteTypingTasks)) {
        for (const [id, task] of Object.entries(tasks)) {
          pastEntries.push([date, id, task]);
        }
      }

      const totalCount = entries.length + pastEntries.length;
      document.getElementById('typingCount').textContent = totalCount;

      let html = '';

      // 과거 미완료 항목 표시 (날짜 역순으로 정렬)
      if (pastEntries.length > 0) {
        const sortedPastEntries = pastEntries.sort((a, b) => b[0].localeCompare(a[0]));

        html += `<div class="mb-4 p-3 bg-orange-50 border-2 border-orange-300 rounded-xl">
          <h4 class="text-sm font-bold text-orange-700 mb-2">⚠️ 과거 미완료 타이핑 업무 (${pastEntries.length}개)</h4>
        `;

        sortedPastEntries.forEach(([date, id, t]) => {
          const dateLabel = formatDateKorean(date);
          html += `
            <div class="bg-white border-2 border-orange-200 rounded-lg p-3 mb-2 flex justify-between items-center">
              <div class="flex-1">
                <div class="font-bold text-gray-800">${escapeHTML(t.task)}</div>
                <div class="text-sm text-gray-600">완료: ${escapeHTML(t.progress||'')} <span class="text-xs text-orange-600 font-semibold ml-2">${dateLabel}</span></div>
              </div>
              <div class="flex gap-2">
                <button onclick="togglePastTypingComplete('${date}', '${id}')"
                        class="px-3 py-1 rounded bg-green-500 text-white text-sm">
                  완료
                </button>
                <button onclick="deletePastTyping('${date}', '${id}')" class="delete-btn text-red-500 hover:text-red-700 text-xl">✕</button>
              </div>
            </div>
          `;
        });

        html += `</div>`;
      }

      // 현재 날짜 항목 표시
      if (!entries.length && !pastEntries.length) {
        html += `<div class="text-gray-500">등록된 업무가 없습니다.</div>`;
      } else if (entries.length > 0) {
        html += entries.map(([id, t]) => `
          <div class="bg-green-50 rounded-lg p-4 flex justify-between items-center">
            <div class="flex-1">
              <div class="font-bold ${t.completed ? 'line-through text-gray-500':''}">${escapeHTML(t.task)}</div>
              <div class="text-sm text-gray-600">완료: ${escapeHTML(t.progress||'')}</div>
            </div>
            <div class="flex gap-2">
              <button onclick="toggleTypingComplete('${id}')"
                      class="px-3 py-1 rounded ${t.completed ? 'bg-gray-300' : 'bg-green-500 text-white'} text-sm">
                ${t.completed ? '재개' : '완료'}
              </button>
              <button onclick="deleteTyping('${id}')" class="delete-btn text-red-500 hover:text-red-700 text-xl">✕</button>
            </div>
          </div>
        `).join('');
      }

      document.getElementById('typingList').innerHTML = html;
    }

    function setTutoringFilter(filter) {
      tutoringFilter = filter;
      // 버튼 스타일 업데이트
      document.getElementById('tutoringFilterAll').className = filter === 'all' ? 'px-4 py-2 rounded-lg bg-indigo-600 text-white' : 'px-4 py-2 rounded-lg bg-gray-200 text-gray-700';
      document.getElementById('tutoringFilterMath').className = filter === 'math' ? 'px-4 py-2 rounded-lg bg-indigo-600 text-white' : 'px-4 py-2 rounded-lg bg-gray-200 text-gray-700';
      document.getElementById('tutoringFilterEnglish').className = filter === 'english' ? 'px-4 py-2 rounded-lg bg-indigo-600 text-white' : 'px-4 py-2 rounded-lg bg-gray-200 text-gray-700';
      renderTutoring();
    }

    function renderTutoring() {
      const today = todayYMD();
      const all = Object.values(tutoringSessions || {});

      // 필터링
      const filtered = tutoringFilter === 'all' ? all : all.filter(s => s.subject === tutoringFilter);

      // 미완료와 완료 분리
      const todayAll = filtered.filter(s => s.date === today).sort((a,b)=>(a.time||'').localeCompare(b.time||''));
      const todayItems = todayAll.filter(s => !s.completed);
      const todayCompleted = todayAll.filter(s => s.completed);

      const upcomingAll = filtered.filter(s => s.date > today).sort((a,b)=>a.date.localeCompare(b.date) || (a.time||'').localeCompare(b.time||''));
      const upcomingItems = upcomingAll.filter(s => !s.completed);

      const pastAll = filtered.filter(s => s.date < today).sort((a,b)=>b.date.localeCompare(a.date) || (a.time||'').localeCompare(b.time||''));
      const pastItems = pastAll.filter(s => !s.completed);

      // 현재 보는 날짜(currentViewDate)의 완료된 보강만 표시
      const currentDateCompleted = filtered.filter(s => s.date === currentViewDate && s.completed).sort((a,b)=>(a.time||'').localeCompare(b.time||''));

      document.getElementById('tutoringCount').textContent = filtered.length;
      const badge = document.getElementById('todayTutoringBadge');
      badge.style.display = todayItems.length ? 'inline-block' : 'none';
      badge.textContent = `오늘 ${todayItems.length}명`;

      const subjectLabel = {'math': '수학', 'english': '영어'};
      const card = (s, tone='') => {
        const isCompleted = s.completed;
        const bgClass = isCompleted ? 'bg-gray-200' : (tone==='today'?'bg-blue-100 border-2 border-blue-400':'bg-blue-50');
        const textClass = isCompleted ? 'text-gray-600' : (tone==='today'?'text-blue-800':'');
        const checkMark = isCompleted ? '✓ ' : '';

        return `
        <div class="${bgClass} rounded-lg p-4">
          <div class="flex justify-between items-start">
            <div class="flex items-start gap-3 flex-1">
              <!-- 완료 체크박스 -->
              <input type="checkbox" ${isCompleted ? 'checked' : ''}
                     onclick="toggleTutoringCompleted('${s.id}')"
                     class="mt-1 w-5 h-5 cursor-pointer">

              <div class="flex-1">
                <div class="font-bold text-lg ${textClass}">
                  ${checkMark}<span class="inline-block px-2 py-0.5 rounded text-xs mr-2 ${s.subject==='math'?'bg-purple-100 text-purple-700':'bg-green-100 text-green-700'}">${subjectLabel[s.subject]||s.subject}</span>
                  ${escapeHTML(s.name)} ${s.time ? `<span class="text-sm">${escapeHTML(s.time)}</span>`:''}
                </div>
                <div class="text-sm ${isCompleted ? 'text-gray-600' : (tone==='today'?'text-blue-700':'text-gray-600')}">
                  ${s.topic ? `주제: ${escapeHTML(s.topic)}`:''} ${s.range ? `| 범위: ${escapeHTML(s.range)}`:''} ${s.date!==today ? `| ${formatDateKorean(s.date)}`:''}
                </div>
                ${s.note ? `<div class="text-xs text-gray-500 mt-1">메모: ${escapeHTML(s.note)}</div>` : ''}
                ${isCompleted && s.completedDetails ? `<div class="text-xs text-green-700 bg-green-50 rounded px-2 py-1 mt-1">📝 ${escapeHTML(s.completedDetails)}</div>` : ''}
              </div>
            </div>

            <div class="flex gap-2 ml-4">
              <button onclick="updateTutoringDetails('${s.id}')"
                      class="delete-btn bg-green-500 hover:bg-green-600 text-white text-xs px-3 py-1 rounded"
                      title="보강 내용 입력">
                📝
              </button>
              <button onclick="deleteTutoring('${s.id}')" class="delete-btn text-red-600 hover:text-red-800 text-xl">✕</button>
            </div>
          </div>
        </div>`;
      };

      // 완료된 보강 카드 (회색 배경, 체크마크 표시)
      const completedCard = (s) => `
        <div class="bg-gray-100 rounded-lg p-4 opacity-70">
          <div class="flex justify-between items-start">
            <div class="flex items-start gap-3 flex-1">
              <input type="checkbox" checked onclick="toggleTutoringCompleted('${s.id}')" class="mt-1 w-5 h-5 cursor-pointer">
              <div class="flex-1">
                <div class="font-bold text-gray-700">
                  ✓ <span class="inline-block px-2 py-0.5 rounded text-xs mr-2 ${s.subject==='math'?'bg-purple-100 text-purple-700':'bg-green-100 text-green-700'}">${subjectLabel[s.subject]||s.subject}</span>
                  ${escapeHTML(s.name)} ${s.time ? `<span class="text-sm">${escapeHTML(s.time)}</span>`:''}
                </div>
                <div class="text-sm text-gray-600">
                  ${s.topic ? `주제: ${escapeHTML(s.topic)}`:''} ${s.range ? `| 범위: ${escapeHTML(s.range)}`:''} ${s.date!==today ? `| ${formatDateKorean(s.date)}`:''}
                </div>
                ${s.note ? `<div class="text-xs text-gray-500 mt-1">메모: ${escapeHTML(s.note)}</div>` : ''}
                ${s.completedDetails ? `<div class="text-xs text-green-700 bg-green-50 rounded px-2 py-1 mt-1">📝 ${escapeHTML(s.completedDetails)}</div>` : ''}
              </div>
            </div>
            <div class="flex gap-2 ml-4">
              <button onclick="updateTutoringDetails('${s.id}')" class="delete-btn bg-green-500 hover:bg-green-600 text-white text-xs px-3 py-1 rounded" title="보강 내용 입력">📝</button>
              <button onclick="deleteTutoring('${s.id}')" class="delete-btn text-red-500 hover:text-red-700 text-xl">✕</button>
            </div>
          </div>
        </div>`;

      let html = '';

      // 오늘 보강 (미완료만)
      if (todayItems.length) {
        html += `<div class="mb-4"><h3 class="font-bold text-blue-600 mb-2">🔵 오늘 보강 (${todayItems.length}명)</h3>
          <div class="space-y-2">${todayItems.map(s => card(s,'today')).join('')}</div></div>`;
      }

      // 예정된 보강 (미완료만)
      if (upcomingItems.length) {
        html += `<div class="mb-4"><h3 class="font-bold text-blue-600 mb-2">📅 예정된 보강 (${upcomingItems.length}명)</h3>
          <div class="space-y-2">${upcomingItems.map(s => card(s)).join('')}</div></div>`;
      }

      // 미완료 과거 보강 (아직 해야 할 것만 표시)
      if (pastItems.length) {
        html += `<div class="mb-4"><h3 class="font-bold text-orange-600 mb-2">⚠️ 미완료 과거 보강 (${pastItems.length}명)</h3>
          <div class="space-y-2">${pastItems.slice(0,5).map(s => card(s)).join('')}</div></div>`;
      }

      // 현재 보는 날짜의 완료된 보강만 표시
      if (currentDateCompleted.length) {
        const dateLabel = currentViewDate === today ? '오늘' : formatDateKorean(currentViewDate);
        html += `<div class="mb-4"><h3 class="font-bold text-green-600 mb-2">✅ ${dateLabel} 완료된 보강 (${currentDateCompleted.length}명)</h3>
          <div class="space-y-2">${currentDateCompleted.map(s => completedCard(s)).join('')}</div></div>`;
      }

      document.getElementById('tutoringList').innerHTML = html || `<div class="text-gray-500">보강 일정이 없습니다.</div>`;
    }

    function renderRetest() {
      const today = todayYMD();
      const all = Object.values(retestStudents || {});
      const todayRetests = all.filter(s => s.date === today);
      const upcomingRetests = all.filter(s => s.date > today).sort((a,b)=>a.date.localeCompare(b.date));
      const pastRetests = all.filter(s => s.date < today).sort((a,b)=>b.date.localeCompare(a.date));

      document.getElementById('retestCount').textContent = all.length;
      const badge = document.getElementById('todayRetestBadge');
      badge.style.display = todayRetests.length ? 'inline-block' : 'none';
      badge.textContent = `오늘 ${todayRetests.length}명`;

      const card = (s, tone='') => `
        <div class="${tone==='today'?'bg-red-100 border-2 border-red-400':'bg-orange-50'} rounded-lg p-4 flex justify-between items-center">
          <div class="flex-1">
            <div class="font-bold text-lg ${tone==='today'?'text-red-800':''}">${escapeHTML(s.name)}</div>
            <div class="text-sm ${tone==='today'?'text-red-700':'text-gray-600'}">
              ${escapeHTML(s.subject||'')}
              ${s.vocabBook ? ` | 단어장: ${escapeHTML(s.vocabBook)}` : ``}
              ${s.vocabRange ? ` | 범위: ${escapeHTML(s.vocabRange)}` : ``}
              | ${formatDateKorean(s.date)} ${s.time? `| ${escapeHTML(s.time)}`:''}
            </div>
          </div>
          <button onclick="deleteRetest('${s.id}')" class="delete-btn text-red-600 hover:text-red-800 ml-4 text-xl">✕</button>
        </div>`;

      let html = '';
      if (todayRetests.length) {
        html += `<div class="mb-4"><h3 class="font-bold text-red-600 mb-2">🔴 오늘 재시험</h3>
          <div class="space-y-2">${todayRetests.map(s => card(s,'today')).join('')}</div></div>`;
      }
      if (upcomingRetests.length) {
        html += `<div class="mb-4"><h3 class="font-bold text-orange-600 mb-2">📅 예정된 재시험</h3>
          <div class="space-y-2">${upcomingRetests.map(s => card(s)).join('')}</div></div>`;
      }
      if (pastRetests.length) {
        html += `<div><h3 class="font-bold text-gray-500 mb-2">✅ 완료된 재시험</h3>
          <div class="space-y-2">
            ${pastRetests.map(s => `
              <div class="bg-gray-100 rounded-lg p-4 flex justify-between items-center opacity-70">
                <div class="flex-1">
                  <div class="font-bold">${escapeHTML(s.name)}</div>
                  <div class="text-sm text-gray-600">
                    ${escapeHTML(s.subject||'')}
                    ${s.vocabBook ? ` | 단어장: ${escapeHTML(s.vocabBook)}` : ``}
                    ${s.vocabRange ? ` | 범위: ${escapeHTML(s.vocabRange)}` : ``}
                    | ${formatDateKorean(s.date)} ${s.time? `| ${escapeHTML(s.time)}`:''}
                  </div>
                </div>
                <button onclick="deleteRetest('${s.id}')" class="delete-btn text-red-500 hover:text-red-700 ml-4 text-xl">✕</button>
              </div>`).join('')}
          </div></div>`;
      }
      document.getElementById('retestList').innerHTML = html || `<div class="text-gray-500">재시험 일정이 없습니다.</div>`;
    }

    /* ===================== 학생 명단 관리 ===================== */
    // 학생 명단 섹션 토글
    function toggleStudentSection() {
      const content = document.getElementById('studentContent');
      const icon = document.getElementById('studentToggleIcon');

      if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.style.transform = 'rotate(180deg)';
      } else {
        content.style.display = 'none';
        icon.style.transform = 'rotate(0deg)';
      }
    }

    function renderStudents() {
      const searchTerm = (document.getElementById('studentSearchInput')?.value || '').toLowerCase().trim();
      const allEntries = Object.entries(students || {}).map(([id, s]) => ({id, ...s}));

      const classSet = new Set();
      allEntries.forEach(s => {
        parseClassList(s.classes).forEach(c => classSet.add(c));
      });

      if (studentClassFilter !== 'all' && !classSet.has(studentClassFilter)) {
        studentClassFilter = 'all';
      }

      renderStudentClassTabs(Array.from(classSet).sort((a, b) => a.localeCompare(b, 'ko')));

      let all = allEntries;

      // 검색 필터링
      if (searchTerm) {
        all = all.filter(s => {
          const name = (s.name || '').toLowerCase();
          const grade = (s.grade || '').toLowerCase();
          const school = (s.school || '').toLowerCase();
          const status = (s.status || '').toLowerCase();
          const classes = formatClassList(s.classes).toLowerCase();
          const teacher = (s.teacher || '').toLowerCase();
          const studentPhone = (s.studentPhone || '').toLowerCase();
          const parentPhone = (s.parentPhone || '').toLowerCase();
          return name.includes(searchTerm) || grade.includes(searchTerm) ||
                 school.includes(searchTerm) || status.includes(searchTerm) ||
                 classes.includes(searchTerm) || teacher.includes(searchTerm) ||
                 studentPhone.includes(searchTerm) || parentPhone.includes(searchTerm);
        });
      }

      if (studentClassFilter !== 'all') {
        all = all.filter(s => parseClassList(s.classes).includes(studentClassFilter));
      }

      // 이름순 정렬
      all.sort((a, b) => (a.name || '').localeCompare(b.name || '', 'ko'));

      const totalCount = Object.keys(students || {}).length;
      document.getElementById('studentCount').textContent = totalCount;

      // 학생이 0명일 때 자동으로 섹션 펼치기
      if (totalCount === 0) {
        const content = document.getElementById('studentContent');
        const icon = document.getElementById('studentToggleIcon');
        if (content && content.style.display === 'none') {
          content.style.display = 'block';
          icon.style.transform = 'rotate(180deg)';
        }
      }

      const tbody = document.getElementById('studentList');
      if (!all.length) {
        const message = searchTerm
          ? '검색 결과가 없습니다.'
          : totalCount === 0
            ? '등록된 학생이 없습니다. 위의 "📥 초기 데이터 불러오기" 버튼을 클릭하거나 직접 학생을 추가해주세요.'
            : '등록된 학생이 없습니다.';
        tbody.innerHTML = `<tr><td colspan="9" class="text-center py-4 text-gray-500">${message}</td></tr>`;
        return;
      }

      tbody.innerHTML = all.map(s => `
        <tr class="border-b hover:bg-gray-50">
          <td class="px-3 py-2 font-medium">${escapeHTML(s.name || '')}</td>
          <td class="px-3 py-2">${escapeHTML(s.grade || '')}</td>
          <td class="px-3 py-2">${escapeHTML(s.school || '') || '-'}</td>
          <td class="px-3 py-2">${escapeHTML(s.status || '') || '-'}</td>
          <td class="px-3 py-2">${escapeHTML(formatClassList(s.classes)) || '-'}</td>
          <td class="px-3 py-2">${escapeHTML(s.teacher || '') || '-'}</td>
          <td class="px-3 py-2">
            ${s.studentPhone ? `<a href="tel:${escapeHTML(s.studentPhone)}" class="text-blue-600 hover:underline">${escapeHTML(s.studentPhone)}</a>` : '-'}
          </td>
          <td class="px-3 py-2">
            ${s.parentPhone ? `<a href="tel:${escapeHTML(s.parentPhone)}" class="text-blue-600 hover:underline">${escapeHTML(s.parentPhone)}</a>` : '-'}
          </td>
          <td class="px-3 py-2">
            <button onclick="editStudent('${s.id}')" class="delete-btn text-green-600 hover:text-green-800 mr-2 text-sm">✏️ 수정</button>
            <button onclick="deleteStudent('${s.id}')" class="delete-btn text-red-600 hover:text-red-800 text-sm">✕ 삭제</button>
          </td>
        </tr>
      `).join('');

      // datalist 업데이트 (자동완성용)
      updateStudentsList();
    }

    function renderStudentClassTabs(classList) {
      const container = document.getElementById('studentClassTabs');
      if (!container) return;

      const tabs = ['전체', ...classList];
      container.innerHTML = tabs.map(name => {
        const key = name === '전체' ? 'all' : name;
        const active = key === studentClassFilter;
        const btnClass = active ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-700';
        return `<button class="px-3 py-1 rounded-full text-sm ${btnClass}" onclick="setStudentClassFilter('${escapeJS(key)}')">${escapeHTML(name)}</button>`;
      }).join('');
    }

    function setStudentClassFilter(value) {
      studentClassFilter = value || 'all';
      renderStudents();
    }

    function updateStudentsList() {
      const datalist = document.getElementById('studentsList');
      if (!datalist) return;

      const allStudents = Object.values(students || {}).sort((a, b) =>
        (a.name || '').localeCompare(b.name || '', 'ko')
      );

      datalist.innerHTML = allStudents.map(s => {
        const classInfo = formatClassList(s.classes);
        const infoParts = [s.name || '', s.grade || '', s.school || '', classInfo].filter(Boolean);
        const info = infoParts.join(' / ');
        return `<option value="${escapeHTML(s.name || '')}">${escapeHTML(info)}</option>`;
      }).join('');
    }

    function showStudentInfo(name, infoElementId) {
      const infoEl = document.getElementById(infoElementId);
      if (!infoEl || !name) {
        if (infoEl) infoEl.textContent = '';
        return;
      }

      // 학생 찾기
      const student = Object.values(students || {}).find(s =>
        (s.name || '').trim().toLowerCase() === name.trim().toLowerCase()
      );

      if (student) {
        const info = [];
        if (student.grade) info.push(`${student.grade}`);
        if (student.school) info.push(`${student.school}`);
        if (student.status) info.push(`상태: ${student.status}`);
        const classInfo = formatClassList(student.classes);
        if (classInfo) info.push(`수업: ${classInfo}`);
        if (student.teacher) info.push(`담임강사: ${student.teacher}`);
        if (student.studentPhone) info.push(`연락처: ${student.studentPhone}`);
        if (student.parentPhone) info.push(`보호자연락처: ${student.parentPhone}`);
        infoEl.textContent = info.length ? info.join(' | ') : '';
      } else {
        infoEl.textContent = '';
      }
    }

    function addStudent() {
      const name = document.getElementById('studentName').value.trim();
      const grade = document.getElementById('studentGrade').value.trim();
      const school = document.getElementById('studentSchool').value.trim();
      const status = document.getElementById('studentStatus').value.trim();
      const classes = parseClassList(document.getElementById('studentClasses').value);
      const teacher = document.getElementById('studentTeacher').value.trim();
      const studentPhone = document.getElementById('studentPhone').value.trim();
      const parentPhone = document.getElementById('parentPhone').value.trim();

      if (!name) {
        alert('학생 이름을 입력해주세요.');
        return;
      }

      const ref = db.ref('students');
      const newId = ref.push().key;
      ref.child(newId).set({ name, grade, school, status, classes, teacher, studentPhone, parentPhone })
        .then(() => {
          document.getElementById('studentName').value = '';
          document.getElementById('studentGrade').value = '';
          document.getElementById('studentSchool').value = '';
          document.getElementById('studentStatus').value = '';
          document.getElementById('studentClasses').value = '';
          document.getElementById('studentTeacher').value = '';
          document.getElementById('studentPhone').value = '';
          document.getElementById('parentPhone').value = '';
        })
        .catch(err => { console.error(err); alert('학생 추가 실패'); });
    }

    function editStudent(id) {
      const s = students[id];
      if (!s) return;

      const name = prompt('이름:', s.name || '');
      if (name === null) return;

      const grade = prompt('학년:', s.grade || '');
      if (grade === null) return;

      const school = prompt('학교:', s.school || '');
      if (school === null) return;

      const status = prompt('상태:', s.status || '');
      if (status === null) return;

      const classes = prompt('수업(쉼표로 구분):', formatClassList(s.classes));
      if (classes === null) return;

      const teacher = prompt('담임강사:', s.teacher || '');
      if (teacher === null) return;

      const studentPhone = prompt('연락처:', s.studentPhone || '');
      if (studentPhone === null) return;

      const parentPhone = prompt('보호자연락처:', s.parentPhone || '');
      if (parentPhone === null) return;

      db.ref('students/' + id).update({
        name,
        grade,
        school,
        status,
        classes: parseClassList(classes),
        teacher,
        studentPhone,
        parentPhone
      })
        .catch(err => { console.error(err); alert('수정 실패'); });
    }

    function deleteStudent(id) {
      const s = students[id];
      if (!s || !confirm(`${s.name} 학생 정보를 삭제하시겠습니까?`)) return;
      db.ref('students/' + id).remove()
        .catch(err => { console.error(err); alert('삭제 실패'); });
    }

    function importStudentsFromExcel(event) {
      const input = event.target;
      const file = input.files && input.files[0];
      if (!file) return;
      if (!window.XLSX) {
        alert('엑셀 라이브러리를 불러오지 못했습니다.');
        input.value = '';
        return;
      }

      const reader = new FileReader();
      reader.onload = () => {
        try {
          const data = new Uint8Array(reader.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });

          if (!rows.length) {
            alert('엑셀에 데이터가 없습니다.');
            return;
          }

          const header = rows[0].map(h => String(h).trim());
          const required = ['수업명', '담임강사', '상태', '이름', '학년', '학교', '연락처', '보호자연락처'];
          const missing = required.filter(name => !header.includes(name));
          if (missing.length) {
            alert(`엑셀 헤더가 올바르지 않습니다.\n필수: ${required.join(', ')}`);
            return;
          }

          const idx = (name) => header.indexOf(name);
          const nameToId = {};
          const keyToId = {};
          Object.entries(students || {}).forEach(([id, s]) => {
            const key = (s.name || '').trim().toLowerCase();
            if (key) nameToId[key] = id;
            const phoneKey = (s.studentPhone || '').trim().toLowerCase();
            if (key && phoneKey) {
              keyToId[`${key}|${phoneKey}`] = id;
            }
          });

          const tempNameToId = { ...nameToId };
          const tempKeyToId = { ...keyToId };
          const createdNames = new Set();
          const incomingNames = new Set();
          const incomingNameOnly = new Set();
          const payload = {};
          let createdCount = 0;
          let updatedCount = 0;
          let skippedCount = 0;

          const incomingFullKeys = new Set();
          const recordMap = {};

          rows.slice(1).forEach(row => {
            const name = String(row[idx('이름')] || '').trim();
            if (!name) {
              skippedCount += 1;
              return;
            }

            const grade = String(row[idx('학년')] || '').trim();
            const school = String(row[idx('학교')] || '').trim();
            const status = String(row[idx('상태')] || '').trim();
            const classes = parseClassList(row[idx('수업명')]);
            const teacher = String(row[idx('담임강사')] || '').trim();
            const studentPhone = String(row[idx('연락처')] || '').trim();
            const parentPhone = String(row[idx('보호자연락처')] || '').trim();

            const key = name.toLowerCase();
            const phoneKey = studentPhone.toLowerCase();
            const fullKey = phoneKey ? `${key}|${phoneKey}` : key;

            if (!recordMap[fullKey]) {
              recordMap[fullKey] = {
                name,
                grade: grade || '',
                school: school || '',
                status: status || '',
                teacher: teacher || '',
                studentPhone: studentPhone || '',
                parentPhone: parentPhone || '',
                classes: new Set()
              };
            }

            const rec = recordMap[fullKey];
            if (!rec.grade && grade) rec.grade = grade;
            if (!rec.school && school) rec.school = school;
            if (!rec.status && status) rec.status = status;
            if (!rec.teacher && teacher) rec.teacher = teacher;
            if (!rec.studentPhone && studentPhone) rec.studentPhone = studentPhone;
            if (!rec.parentPhone && parentPhone) rec.parentPhone = parentPhone;
            classes.forEach(c => rec.classes.add(c));
          });

          Object.values(recordMap).forEach(rec => {
            const key = rec.name.toLowerCase();
            const phoneKey = rec.studentPhone.toLowerCase();
            const fullKey = phoneKey ? `${key}|${phoneKey}` : '';

            incomingNames.add(key);
            if (fullKey) incomingFullKeys.add(fullKey);
            if (!phoneKey) incomingNameOnly.add(key);

            let id = fullKey ? tempKeyToId[fullKey] : tempNameToId[key];
            if (!id && fullKey && tempNameToId[key]) {
              id = tempNameToId[key];
              tempKeyToId[fullKey] = id;
            }

            const classes = Array.from(rec.classes);
            if (!id) {
              id = db.ref('students').push().key;
              tempNameToId[key] = id;
              if (fullKey) tempKeyToId[fullKey] = id;
              createdNames.add(key);
              createdCount += 1;
              payload[id] = {
                name: rec.name,
                grade: rec.grade,
                school: rec.school,
                status: rec.status,
                classes,
                teacher: rec.teacher,
                studentPhone: rec.studentPhone,
                parentPhone: rec.parentPhone
              };
              return;
            }

            const update = { name: rec.name };
            if (rec.grade) update.grade = rec.grade;
            if (rec.school) update.school = rec.school;
            if (rec.status) update.status = rec.status;
            if (classes.length) update.classes = classes;
            if (rec.teacher) update.teacher = rec.teacher;
            if (rec.studentPhone) update.studentPhone = rec.studentPhone;
            if (rec.parentPhone) update.parentPhone = rec.parentPhone;

            if (Object.keys(update).length > 1 || !nameToId[key]) {
              payload[id] = { ...(payload[id] || {}), ...update };
              if (!createdNames.has(key)) updatedCount += 1;
            }
          });

          const deletions = {};
          Object.entries(students || {}).forEach(([id, s]) => {
            const key = (s.name || '').trim().toLowerCase();
            if (!key) return;
            const phoneKey = (s.studentPhone || '').trim().toLowerCase();
            const fullKey = phoneKey ? `${key}|${phoneKey}` : '';

            if (fullKey) {
              if (!incomingFullKeys.has(fullKey) && !incomingNameOnly.has(key)) {
                deletions[id] = null;
              }
              return;
            }

            if (!incomingNames.has(key)) {
              deletions[id] = null;
            }
          });
          const deletedCount = Object.keys(deletions).length;
          const combined = { ...payload, ...deletions };
          if (!Object.keys(combined).length) {
            alert('추가/변경할 학생 데이터가 없습니다.');
            return;
          }

          db.ref('students').update(combined)
            .then(() => {
              alert(`엑셀 업로드 완료: 신규 ${createdCount}명, 업데이트 ${updatedCount}명, 삭제 ${deletedCount}명, 건너뜀 ${skippedCount}건`);
            })
            .catch(err => {
              console.error(err);
              alert('엑셀 업로드 실패');
            });
        } catch (err) {
          console.error(err);
          alert('엑셀 읽기 실패');
        } finally {
          input.value = '';
        }
      };

      reader.readAsArrayBuffer(file);
    }

    // UI에서 호출하는 확인 함수
    function importInitialStudentsWithConfirm() {
      const currentCount = Object.keys(students || {}).length;
      const message = currentCount > 0
        ? `현재 ${currentCount}명의 학생이 등록되어 있습니다.\n\n67명의 초기 학생 데이터를 추가하시겠습니까?\n(기존 데이터는 유지되고, 새로운 학생들이 추가됩니다)`
        : '67명의 초기 학생 데이터를 불러오시겠습니까?';

      if (confirm(message)) {
        importInitialStudents();
      }
    }

    // 초기 학생 데이터 import 함수 (콘솔에서 한 번만 실행)
    window.importInitialStudents = function() {
      const initialData = [
        {name: "강민준", grade: "중1", studentPhone: "010-9217-6690", parentPhone: "010-9286-6690"},
        {name: "강지율", grade: "중3", studentPhone: "010-6736-2478", parentPhone: "010-2836-2478"},
        {name: "강희경", grade: "중2", studentPhone: "010-9101-5934", parentPhone: "010-6290-1832"},
        {name: "고은서", grade: "중3", studentPhone: "010-7340-0855", parentPhone: "010-2345-4554"},
        {name: "공예은", grade: "중3", studentPhone: "010-4303-7675", parentPhone: "010-6400-7675"},
        {name: "김도율", grade: "중1", studentPhone: "010-4175-0682", parentPhone: "010-4178-0682"},
        {name: "김민성", grade: "중2", studentPhone: "010-340-0269", parentPhone: "010-3488-1269"},
        {name: "김민주", grade: "고3", studentPhone: "010-4344-0701", parentPhone: "010-8760-8894"},
        {name: "김보현", grade: "고1", studentPhone: "010-2485-8893", parentPhone: "010-8403-8893"},
        {name: "김소망", grade: "고1", studentPhone: "010-9332-1991", parentPhone: "010-7152-3232"},
        {name: "김아린", grade: "초6", studentPhone: "010-3151-1882", parentPhone: "010-9069-7369"},
        {name: "김주원", grade: "중3", studentPhone: "010-7289-9778", parentPhone: "010-9338-9778"},
        {name: "김준우", grade: "중1", studentPhone: "010-8277-7932", parentPhone: "010-4028-7932"},
        {name: "김준한", grade: "중3", studentPhone: "010-7568-6454", parentPhone: "010-5303-6140"},
        {name: "김지우", grade: "고1", studentPhone: "010-8684-9098", parentPhone: "010-9461-9098"},
        {name: "김태헌", grade: "고3", studentPhone: "010-2772-1593", parentPhone: "010-6255-1666"},
        {name: "김현진", grade: "고3", studentPhone: "010-6247-2723", parentPhone: "010-6241-2723"},
        {name: "노윤아", grade: "중2", studentPhone: "", parentPhone: "010-7173-0070"},
        {name: "문소예", grade: "중3", studentPhone: "010-7742-9824", parentPhone: "010-7655-8571"},
        {name: "박범준", grade: "고3", studentPhone: "010-4029-9972", parentPhone: "010-5049-4432"},
        {name: "박세은", grade: "중3", studentPhone: "010-8358-5763", parentPhone: "010-6229-2412"},
        {name: "박창진", grade: "고2", studentPhone: "010-2894-4611", parentPhone: "010-6221-4611"},
        {name: "배수빈", grade: "중3", studentPhone: "010-5176-1921", parentPhone: "010-5179-1921"},
        {name: "백종원", grade: "고1", studentPhone: "010-9780-5855", parentPhone: "010-9473-8914"},
        {name: "백지안", grade: "고3", studentPhone: "010-3696-1970", parentPhone: "010-9060-1978"},
        {name: "변은후", grade: "중2", studentPhone: "010-4992-0764", parentPhone: "010-3112-0217"},
        {name: "서지우", grade: "고1", studentPhone: "010-4002-8568", parentPhone: "010-9167-8568"},
        {name: "성아란", grade: "중2", studentPhone: "010-9534-3653", parentPhone: "010-5534-3653"},
        {name: "손채아", grade: "중3", studentPhone: "010-4074-6292", parentPhone: "010-3108-1308"},
        {name: "송민준", grade: "고1", studentPhone: "010-2642-0046", parentPhone: "010-6734-0527"},
        {name: "송한울", grade: "중3", studentPhone: "010-2557-5917", parentPhone: "010-5142-9452"},
        {name: "안대일", grade: "중3", studentPhone: "010-9409-2732", parentPhone: "010-8909-0411"},
        {name: "양라현", grade: "중1", studentPhone: "010-6413-6441", parentPhone: "010-8869-1461"},
        {name: "양승우", grade: "중3", studentPhone: "010-8354-2971", parentPhone: "010-9098-2971"},
        {name: "우예성", grade: "중3", studentPhone: "010-9660-8576", parentPhone: "010-5554-7859"},
        {name: "우예준", grade: "중2", studentPhone: "010-9760-8576", parentPhone: "010-5554-7859"},
        {name: "우현서", grade: "고1", studentPhone: "010-2070-1419", parentPhone: "010-4794-1419"},
        {name: "은하윤", grade: "중3", studentPhone: "010-2665-1493", parentPhone: "010-5663-1493"},
        {name: "이건우", grade: "중2", studentPhone: "010-6244-9184", parentPhone: "010-6210-9184"},
        {name: "이서현", grade: "고1", studentPhone: "010-9049-3658", parentPhone: "010-6355-3658"},
        {name: "이솔민", grade: "중2", studentPhone: "010-3136-8596", parentPhone: "010-7125-2079"},
        {name: "이수인", grade: "중2", studentPhone: "010-6734-2815", parentPhone: "010-7377-2815"},
        {name: "이예담", grade: "중1", studentPhone: "010-6379-1099", parentPhone: "010-4211-1099"},
        {name: "이유찬", grade: "중2", studentPhone: "010-9568-1669", parentPhone: "010-9032-1669"},
        {name: "이윤채", grade: "고3", studentPhone: "010-8959-6277", parentPhone: "010-3780-6277"},
        {name: "이재준", grade: "고3", studentPhone: "010-9472-8985", parentPhone: "010-8778-3539"},
        {name: "이찬민", grade: "중3", studentPhone: "010-5281-7725", parentPhone: "010-6610-7725"},
        {name: "임재우", grade: "중3", studentPhone: "010-2636-9327", parentPhone: "010-8748-3484"},
        {name: "임지효", grade: "중3", studentPhone: "010-6307-3062", parentPhone: "010-7157-3167"},
        {name: "장해준", grade: "중2", studentPhone: "010-3151-2461", parentPhone: "010-7114-2461"},
        {name: "전서윤", grade: "고2", studentPhone: "010-3170-0668", parentPhone: "010-9116-0661"},
        {name: "전준영", grade: "고1", studentPhone: "010-7188-5269", parentPhone: "010-6312-6265"},
        {name: "전지아", grade: "초6", studentPhone: "010-8696-6948", parentPhone: "010-2228-6948"},
        {name: "정도현", grade: "초5", studentPhone: "010-5656-4826", parentPhone: "010-5655-4826"},
        {name: "정민주", grade: "초6", studentPhone: "010-2284-9738", parentPhone: "010-2024-5738"},
        {name: "조강민", grade: "초5", studentPhone: "010-4308-5055", parentPhone: "010-9491-5055"},
        {name: "조미성", grade: "중2", studentPhone: "010-3905-0203", parentPhone: "010-8903-0721"},
        {name: "조민찬", grade: "중2", studentPhone: "010-8433-2119", parentPhone: "010-9145-0480"},
        {name: "조희원", grade: "초5", studentPhone: "010-2483-0480", parentPhone: "010-9145-0480"},
        {name: "차승훈", grade: "중2", studentPhone: "010-2669-0080", parentPhone: "010-7116-9780"},
        {name: "최상원", grade: "중3", studentPhone: "010-4566-7516", parentPhone: "010-7118-6586"},
        {name: "최아영", grade: "고1", studentPhone: "010-7370-4128", parentPhone: "010-2976-0984"},
        {name: "최지유", grade: "중3", studentPhone: "010-4757-7842", parentPhone: "010-3626-3888"},
        {name: "최효준", grade: "중3", studentPhone: "010-4610-5298", parentPhone: "010-4749-3308"},
        {name: "한지우", grade: "중2", studentPhone: "010-9464-2614", parentPhone: "010-9447-2614"},
        {name: "한해린", grade: "초6", studentPhone: "010-4428-4832", parentPhone: "010-4426-4832"},
        {name: "황지유", grade: "중2", studentPhone: "010-8915-7748", parentPhone: "010-9144-5585"}
      ];

      const ref = db.ref('students');
      const updates = {};
      initialData.forEach(student => {
        const key = ref.push().key;
        updates[key] = student;
      });

      ref.update(updates)
        .then(() => {
          console.log(`✅ ${initialData.length}명의 학생 데이터를 성공적으로 추가했습니다!`);
          alert(`${initialData.length}명의 학생이 추가되었습니다.`);
        })
        .catch(err => {
          console.error('❌ 학생 데이터 추가 실패:', err);
          alert('데이터 추가 중 오류가 발생했습니다.');
        });
    };

    function renderNamePills(containerId, names) {
      const el = document.getElementById(containerId);
      el.innerHTML = names.length
        ? names.map(n => `<span class="inline-block px-2 py-1 rounded-full text-sm bg-gray-100 border">${escapeHTML(n)}</span>`).join(' ')
        : `<div class="text-gray-500">없음</div>`;
    }
    function diffPending(rosterMap, doneMap) {
      const all = Object.keys(rosterMap||{});
      return all.filter(n => !doneMap || !doneMap[n]);
    }
    function renderClasscard() {
      const roster = Object.keys(ccState.roster||{});
      const pending = diffPending(ccState.roster, ccState.done);
      document.getElementById('ccRosterCount').textContent = roster.length;
      document.getElementById('ccPendingCount').textContent = pending.length;
      renderNamePills('ccRosterList', roster);
      renderNamePills('ccPendingList', pending);
    }
    function renderVocabAccum() {
      const roster = Object.keys(vaState.roster||{});
      const pending = diffPending(vaState.roster, vaState.done);
      document.getElementById('vaRosterCount').textContent = roster.length;
      document.getElementById('vaPendingCount').textContent = pending.length;
      renderNamePills('vaRosterList', roster);
      renderNamePills('vaPendingList', pending);
    }

    /* ===================== 알림 (단어시험 포함 확장) ===================== */
    function updateNotificationPanel(data) {
      const subjectLabel = {'math': '수학', 'english': '영어'};
      const incompleteTasks = data.incompleteTasks.map(t => `• ${escapeHTML(t.label)}`);
      const todayRetests = data.todayRetests.map(s => `• ${escapeHTML(s.name)} (${escapeHTML(s.subject||'')}${s.time? ' '+escapeHTML(s.time):''})`);
      const todayTutoring = data.todayTutoring.map(s => `• [${subjectLabel[s.subject]||s.subject}] ${escapeHTML(s.name)} ${s.time? escapeHTML(s.time):''} ${s.topic? '('+escapeHTML(s.topic)+')':''}`);
      const incompleteTyping = data.incompleteTyping.map(t => `• ${escapeHTML(t.task)}`);
      const todayVocabEvents = data.todayVocabEvents.map(e => `• ${escapeHTML(e.student)} (${e.rangeStart}–${e.rangeEnd})`);
      const urgentHomework = (data.urgentHomework||[]).map(hw => {
        const isOverdue = hw.dueDate < todayYMD();
        return `• ${isOverdue ? '⚠️ ' : ''}${escapeHTML(hw.studentName)}: ${escapeHTML(hw.title)}`;
      });

      const sections = [];
      if (incompleteTasks.length) sections.push(`<h4 class="font-semibold mb-1">미완료 체크리스트</h4><div class="mb-2">${incompleteTasks.join('<br>')}</div>`);
      if (todayRetests.length) sections.push(`<h4 class="font-semibold mb-1">오늘 재시험</h4><div class="mb-2">${todayRetests.join('<br>')}</div>`);
      if (todayTutoring.length) sections.push(`<h4 class="font-semibold mb-1">오늘 미완료 보강</h4><div class="mb-2">${todayTutoring.join('<br>')}</div>`);
      if (todayVocabEvents.length) sections.push(`<h4 class="font-semibold mb-1">오늘 단어시험</h4><div class="mb-2">${todayVocabEvents.join('<br>')}</div>`);
      if (urgentHomework.length) sections.push(`<h4 class="font-semibold mb-1">📝 마감 숙제</h4><div class="mb-2">${urgentHomework.join('<br>')}</div>`);
      if (incompleteTyping.length) sections.push(`<h4 class="font-semibold mb-1">타이핑 업무</h4><div>${incompleteTyping.join('<br>')}</div>`);

      document.getElementById('notificationContent').innerHTML = sections.join('<hr class="my-3">') || '알림 없음';
    }
    function checkNotifications() {
      const today = todayYMD();
      if (currentViewDate !== today) {
        document.getElementById('notificationBadge').style.display = 'none';
        return;
      }

      // 한 번만 필터링하여 성능 최적화
      const incompleteTasks = Object.values(dailyTasks).filter(t => !t.checked);
      const todayRetests = Object.values(retestStudents||{}).filter(s => s.date === today);
      const todayTutoring = Object.values(tutoringSessions||{}).filter(s => s.date === today && !s.completed); // 미완료만
      const incompleteTyping = Object.values(typingTasks).filter(t => !t.completed);
      const todayVocabEvents = Object.values(vocab.events||{}).filter(e => e.date === today);
      // 오늘 마감 또는 기한 초과 숙제 (미완료만)
      const urgentHomework = Object.values(homework||{}).filter(hw => !hw.completed && hw.dueDate && hw.dueDate <= today);

      // 과거 미완료 항목도 포함
      let pastDailyCount = 0;
      let pastTypingCount = 0;
      for (const date in pastIncompleteDailyTasks) {
        pastDailyCount += Object.keys(pastIncompleteDailyTasks[date]).length;
      }
      for (const date in pastIncompleteTypingTasks) {
        pastTypingCount += Object.keys(pastIncompleteTypingTasks[date]).length;
      }

      const total = incompleteTasks.length + todayRetests.length + todayTutoring.length +
                    incompleteTyping.length + todayVocabEvents.length +
                    urgentHomework.length +
                    pastDailyCount + pastTypingCount;

      if (total > 0) {
        document.getElementById('notificationBadge').style.display = 'flex';
        document.getElementById('notificationCount').textContent = total;
      } else {
        document.getElementById('notificationBadge').style.display = 'none';
      }

      // 필터링된 데이터를 전달하여 중복 필터링 방지
      updateNotificationPanel({
        incompleteTasks,
        todayRetests,
        todayTutoring,
        incompleteTyping,
        todayVocabEvents,
        urgentHomework
      });
    }

    /* ===================== CRUD (체크리스트 등) ===================== */
    // daily
    function addNewTask() {
      const input = document.getElementById('newTaskInput');
      const noteInput = document.getElementById('newTaskNoteInput');
      const label = input.value.trim();
      const note = (noteInput.value||'').trim();
      if (!label) return;
      const ref = db.ref('daily/' + currentViewDate);
      const key = ref.push().key;
      ref.child(key).set({ label, checked: false, note }).catch(err => console.error('태스크 추가 실패:', err));
      input.value = '';
      noteInput.value = '';
    }
    function toggleTask(id) {
      const cur = dailyTasks[id]; if (!cur) return;
      db.ref(`daily/${currentViewDate}/${id}/checked`).set(!cur.checked).then(() => {
        // 과거 날짜에서 완료 처리한 경우 pastIncompleteDailyTasks에서도 제거
        if (!cur.checked && pastIncompleteDailyTasks[currentViewDate] && pastIncompleteDailyTasks[currentViewDate][id]) {
          delete pastIncompleteDailyTasks[currentViewDate][id];
          if (Object.keys(pastIncompleteDailyTasks[currentViewDate]).length === 0) {
            delete pastIncompleteDailyTasks[currentViewDate];
          }
          renderDailyTasks();
          checkNotifications();
        }
      }).catch(err => console.error('태스크 토글 실패:', err));
    }
    function deleteTask(id) {
      db.ref(`daily/${currentViewDate}/${id}`).remove().then(() => {
        // 과거 날짜에서 삭제한 경우 pastIncompleteDailyTasks에서도 제거
        if (pastIncompleteDailyTasks[currentViewDate] && pastIncompleteDailyTasks[currentViewDate][id]) {
          delete pastIncompleteDailyTasks[currentViewDate][id];
          if (Object.keys(pastIncompleteDailyTasks[currentViewDate]).length === 0) {
            delete pastIncompleteDailyTasks[currentViewDate];
          }
          renderDailyTasks();
          checkNotifications();
        }
      }).catch(err => console.error('태스크 삭제 실패:', err));
    }
    function openNoteEditor(id) {
      const cur = dailyTasks[id]; if (!cur) return;
      const newNote = prompt('메모/내용을 입력하세요:', cur.note || '');
      if (newNote === null) return;
      db.ref(`daily/${currentViewDate}/${id}/note`).set(newNote).catch(err => console.error('메모 저장 실패:', err));
    }
    // 과거 항목 조작 함수
    function togglePastTask(date, id) {
      db.ref(`daily/${date}/${id}/checked`).set(true).then(() => {
        // 완료로 표시되면 과거 미완료 항목에서 제거
        if (pastIncompleteDailyTasks[date] && pastIncompleteDailyTasks[date][id]) {
          delete pastIncompleteDailyTasks[date][id];
          if (Object.keys(pastIncompleteDailyTasks[date]).length === 0) {
            delete pastIncompleteDailyTasks[date];
          }
          renderDailyTasks();
          checkNotifications();
        }
      }).catch(err => console.error('과거 태스크 토글 실패:', err));
    }
    function deletePastTask(date, id) {
      db.ref(`daily/${date}/${id}`).remove().then(() => {
        if (pastIncompleteDailyTasks[date] && pastIncompleteDailyTasks[date][id]) {
          delete pastIncompleteDailyTasks[date][id];
          if (Object.keys(pastIncompleteDailyTasks[date]).length === 0) {
            delete pastIncompleteDailyTasks[date];
          }
          renderDailyTasks();
          checkNotifications();
        }
      }).catch(err => console.error('과거 태스크 삭제 실패:', err));
    }

    // korean
    function addKorean() {
      const name = document.getElementById('koreanName').value.trim();
      const score = document.getElementById('koreanScore').value.trim();
      const attendance = document.getElementById('koreanAttendance').value;
      const wrong = document.getElementById('koreanWrong').value.trim();
      if (!name) return;
      const ref = db.ref('korean/' + currentViewDate);
      const key = ref.push().key;
      ref.child(key).set({ name, score, attendance, wrong }).catch(err => console.error('국어 학생 추가 실패:', err));
      document.getElementById('koreanName').value = '';
      document.getElementById('koreanScore').value = '';
      document.getElementById('koreanWrong').value = '';
    }
    function deleteKorean(id) {
      db.ref(`korean/${currentViewDate}/${id}`).remove().catch(err => console.error('국어 학생 삭제 실패:', err));
    }

    // 역사/과학
    function addHsMgmt() {
      const subject = document.getElementById('hsSubject').value;
      const name = document.getElementById('hsName').value.trim();
      const score = document.getElementById('hsScore').value.trim();
      const range = document.getElementById('hsRange').value.trim();
      if (!name) return;
      const ref = db.ref('hsMgmt/' + currentViewDate);
      const key = ref.push().key;
      ref.child(key).set({ subject, name, score, range }).catch(err => console.error('역사/과학 추가 실패:', err));
      document.getElementById('hsName').value = '';
      document.getElementById('hsScore').value = '';
      document.getElementById('hsRange').value = '';
    }
    function deleteHsMgmt(id) {
      db.ref(`hsMgmt/${currentViewDate}/${id}`).remove().catch(err => console.error('역사/과학 삭제 실패:', err));
    }

    // typing
    function addTyping() {
      const task = document.getElementById('typingTask').value.trim();
      const progress = document.getElementById('typingProgress').value.trim();
      if (!task) return;
      const ref = db.ref('typing/' + currentViewDate);
      const key = ref.push().key;
      ref.child(key).set({ task, progress, completed: false }).catch(err => console.error('타이핑 업무 추가 실패:', err));
      document.getElementById('typingTask').value = '';
      document.getElementById('typingProgress').value = '';
    }
    function toggleTypingComplete(id) {
      const cur = typingTasks[id]; if (!cur) return;
      db.ref(`typing/${currentViewDate}/${id}/completed`).set(!cur.completed).then(() => {
        // 과거 날짜에서 완료 처리한 경우 pastIncompleteTypingTasks에서도 제거
        if (!cur.completed && pastIncompleteTypingTasks[currentViewDate] && pastIncompleteTypingTasks[currentViewDate][id]) {
          delete pastIncompleteTypingTasks[currentViewDate][id];
          if (Object.keys(pastIncompleteTypingTasks[currentViewDate]).length === 0) {
            delete pastIncompleteTypingTasks[currentViewDate];
          }
          renderTyping();
          checkNotifications();
        }
      }).catch(err => console.error('타이핑 완료 토글 실패:', err));
    }
    function deleteTyping(id) {
      db.ref(`typing/${currentViewDate}/${id}`).remove().then(() => {
        // 과거 날짜에서 삭제한 경우 pastIncompleteTypingTasks에서도 제거
        if (pastIncompleteTypingTasks[currentViewDate] && pastIncompleteTypingTasks[currentViewDate][id]) {
          delete pastIncompleteTypingTasks[currentViewDate][id];
          if (Object.keys(pastIncompleteTypingTasks[currentViewDate]).length === 0) {
            delete pastIncompleteTypingTasks[currentViewDate];
          }
          renderTyping();
          checkNotifications();
        }
      }).catch(err => console.error('타이핑 삭제 실패:', err));
    }
    // 과거 타이핑 항목 조작 함수
    function togglePastTypingComplete(date, id) {
      db.ref(`typing/${date}/${id}/completed`).set(true).then(() => {
        // 완료로 표시되면 과거 미완료 항목에서 제거
        if (pastIncompleteTypingTasks[date] && pastIncompleteTypingTasks[date][id]) {
          delete pastIncompleteTypingTasks[date][id];
          if (Object.keys(pastIncompleteTypingTasks[date]).length === 0) {
            delete pastIncompleteTypingTasks[date];
          }
          renderTyping();
          checkNotifications();
        }
      }).catch(err => console.error('과거 타이핑 완료 토글 실패:', err));
    }
    function deletePastTyping(date, id) {
      db.ref(`typing/${date}/${id}`).remove().then(() => {
        if (pastIncompleteTypingTasks[date] && pastIncompleteTypingTasks[date][id]) {
          delete pastIncompleteTypingTasks[date][id];
          if (Object.keys(pastIncompleteTypingTasks[date]).length === 0) {
            delete pastIncompleteTypingTasks[date];
          }
          renderTyping();
          checkNotifications();
        }
      }).catch(err => console.error('과거 타이핑 삭제 실패:', err));
    }

    // 과목별 보강 (전역)
    function addTutoring() {
      const subject = document.getElementById('tutoringSubject').value;
      const name = document.getElementById('tutoringName').value.trim();
      const time = document.getElementById('tutoringTime').value;
      const topic = document.getElementById('tutoringTopic').value.trim();
      const range = document.getElementById('tutoringRange').value.trim();
      const note = document.getElementById('tutoringNote').value.trim();
      if (!name) return;
      const ref = db.ref('tutoringSessions');
      const key = ref.push().key;
      const item = {
        id: key,
        subject,
        name,
        time,
        topic,
        range,
        note,
        date: currentViewDate,
        completed: false,
        completedDetails: ''
      };
      ref.child(key).set(item).catch(err => console.error('보강 추가 실패:', err));
      document.getElementById('tutoringName').value = '';
      document.getElementById('tutoringTime').value = '';
      document.getElementById('tutoringTopic').value = '';
      document.getElementById('tutoringRange').value = '';
      document.getElementById('tutoringNote').value = '';
    }
    function deleteTutoring(id) {
      db.ref(`tutoringSessions/${id}`).remove().catch(err => console.error('보강 삭제 실패:', err));
    }

    function toggleTutoringCompleted(id) {
      const session = tutoringSessions[id];
      if (!session) return;
      db.ref(`tutoringSessions/${id}/completed`).set(!session.completed)
        .catch(err => console.error('보강 완료 상태 변경 실패:', err));
    }

    function updateTutoringDetails(id) {
      const details = prompt('보강 내용을 입력하세요:', tutoringSessions[id]?.completedDetails || '');
      if (details === null) return; // 취소
      db.ref(`tutoringSessions/${id}/completedDetails`).set(details)
        .catch(err => console.error('보강 내용 저장 실패:', err));
    }

    // 재시험(전역)
    function addRetest() {
      const name = document.getElementById('retestName').value.trim();
      const subject = document.getElementById('retestSubject').value.trim();
      const vocabBook = document.getElementById('retestVocabBook').value.trim();
      const vocabRange = document.getElementById('retestVocabRange').value.trim();
      const date = document.getElementById('retestDate').value;
      const time = document.getElementById('retestTime').value;
      if (!name || !date) return;
      const ref = db.ref('retest');
      const key = ref.push().key;
      const item = { id: key, name, subject, vocabBook, vocabRange, date, time };
      ref.child(key).set(item).catch(err => console.error('재시험 추가 실패:', err));
      document.getElementById('retestName').value = '';
      document.getElementById('retestSubject').value = '';
      document.getElementById('retestVocabBook').value = '';
      document.getElementById('retestVocabRange').value = '';
      document.getElementById('retestDate').value = '';
      document.getElementById('retestTime').value = '';
    }
    function deleteRetest(id) {
      db.ref(`retest/${id}`).remove().catch(err => console.error('재시험 삭제 실패:', err));
    }

    // ===================== 숙제 관리 =====================
    let classStatusFilter = 'all';
    let currentKakaoMessage = '';

    function toggleHomeworkForm() {
      const form = document.getElementById('homeworkFormSection');
      form.style.display = form.style.display === 'none' ? 'block' : 'none';
      if (form.style.display === 'block') {
        document.getElementById('hwDueDate').value = addDays(todayYMD(), 2); // 기본 마감일: 2일 후
        populateHomeworkClassSelect();
      }
    }

    function toggleClassesModal() {
      const backdrop = document.getElementById('classesModalBackdrop');
      const modal = document.getElementById('classesModal');
      const isOpen = modal.style.display === 'block';
      backdrop.style.display = isOpen ? 'none' : 'block';
      modal.style.display = isOpen ? 'none' : 'block';
      if (!isOpen) renderClasses();
    }

    function toggleKakaoMessageModal() {
      const backdrop = document.getElementById('kakaoMessageBackdrop');
      const modal = document.getElementById('kakaoMessageModal');
      const isOpen = modal.style.display === 'block';
      backdrop.style.display = isOpen ? 'none' : 'block';
      modal.style.display = isOpen ? 'none' : 'block';
    }

    let hwMode = 'individual'; // 'individual' or 'bulk'

    function populateHomeworkClassSelect() {
      const select = document.getElementById('hwClassSelect');
      const bulkSelect = document.getElementById('hwBulkClassSelect');
      const filterSelect = document.getElementById('homeworkClassFilterSelect');
      const activeClasses = Object.entries(classes).filter(([id, c]) => c.status !== 'ended');

      // 숙제 추가 폼의 수업 선택 (개별)
      let html = '<option value="">수업 선택</option>';
      activeClasses.forEach(([id, c]) => {
        html += `<option value="${id}">${escapeHTML(c.name)}</option>`;
      });
      select.innerHTML = html;

      // 숙제 추가 폼의 수업 선택 (일괄)
      let bulkHtml = '<option value="">수업 선택 (필수)</option>';
      activeClasses.forEach(([id, c]) => {
        bulkHtml += `<option value="${id}">${escapeHTML(c.name)}</option>`;
      });
      bulkSelect.innerHTML = bulkHtml;

      // 필터 드롭다운의 수업 선택
      let filterHtml = '<option value="all">전체 수업</option>';
      Object.entries(classes).forEach(([id, c]) => {
        filterHtml += `<option value="${id}">${escapeHTML(c.name)}${c.status === 'ended' ? ' (종강)' : ''}</option>`;
      });
      filterSelect.innerHTML = filterHtml;
      filterSelect.value = homeworkClassFilter;

      // 학생 목록 초기화
      updateHwStudentsList();
    }

    // 숙제 등록 모드 전환 (개별/일괄)
    function setHwMode(mode) {
      hwMode = mode;
      const individualMode = document.getElementById('hwIndividualMode');
      const bulkMode = document.getElementById('hwBulkMode');
      const addBtn = document.getElementById('hwAddBtn');
      const bulkAddBtn = document.getElementById('hwBulkAddBtn');
      const modeIndividualBtn = document.getElementById('hwModeIndividual');
      const modeBulkBtn = document.getElementById('hwModeBulk');

      if (mode === 'individual') {
        individualMode.style.display = 'block';
        bulkMode.style.display = 'none';
        addBtn.style.display = 'block';
        bulkAddBtn.style.display = 'none';
        modeIndividualBtn.className = 'px-4 py-2 rounded-lg bg-indigo-600 text-white';
        modeBulkBtn.className = 'px-4 py-2 rounded-lg bg-gray-200 text-gray-700';
      } else {
        individualMode.style.display = 'none';
        bulkMode.style.display = 'block';
        addBtn.style.display = 'none';
        bulkAddBtn.style.display = 'block';
        modeIndividualBtn.className = 'px-4 py-2 rounded-lg bg-gray-200 text-gray-700';
        modeBulkBtn.className = 'px-4 py-2 rounded-lg bg-indigo-600 text-white';
      }
    }

    // 일괄 모드: 수업 선택 시 학생 목록 미리보기
    function onHwBulkClassChange() {
      const classId = document.getElementById('hwBulkClassSelect').value;
      const preview = document.getElementById('hwBulkStudentPreview');

      if (!classId) {
        preview.innerHTML = '<span class="text-gray-500">수업을 선택하면 해당 학생 목록이 표시됩니다</span>';
        return;
      }

      const className = classes[classId]?.name || '';
      const classStudents = getStudentsByClass(className);

      if (classStudents.length === 0) {
        preview.innerHTML = '<span class="text-orange-600">⚠️ 해당 수업에 등록된 학생이 없습니다</span>';
        return;
      }

      preview.innerHTML = `
        <div class="font-semibold text-green-700 mb-1">✅ ${classStudents.length}명에게 숙제가 등록됩니다:</div>
        <div class="flex flex-wrap gap-1">
          ${classStudents.map(s => `<span class="px-2 py-1 bg-green-100 text-green-800 rounded text-xs">${escapeHTML(s.name)}</span>`).join('')}
        </div>
      `;
    }

    // 수업명으로 학생 목록 가져오기
    function getStudentsByClass(className) {
      if (!className) return [];
      return Object.values(students).filter(s => {
        const studentClasses = parseClassList(s.classes);
        return studentClasses.some(c => c.includes(className) || className.includes(c));
      });
    }

    // 반 전체 일괄 숙제 추가
    function addBulkHomework() {
      const classId = document.getElementById('hwBulkClassSelect').value;
      const title = document.getElementById('hwBulkTitle').value.trim();
      const textbook = document.getElementById('hwTextbook').value.trim();
      const pageRange = document.getElementById('hwPageRange').value.trim();
      const dueDate = document.getElementById('hwDueDate').value;
      const description = document.getElementById('hwDescription').value.trim();

      if (!classId || !title || !dueDate) {
        alert('수업, 숙제 내용, 마감일은 필수입니다.');
        return;
      }

      const classInfo = classes[classId] || {};
      const className = classInfo.name || '';
      const subject = classInfo.subject || '';
      const classStudents = getStudentsByClass(className);

      if (classStudents.length === 0) {
        alert('해당 수업에 등록된 학생이 없습니다.');
        return;
      }

      if (!confirm(`${className} 수업의 ${classStudents.length}명 학생에게 숙제를 등록하시겠습니까?\n\n숙제: ${title}\n마감일: ${dueDate}`)) {
        return;
      }

      const ref = db.ref('homework');
      const batch = {};

      classStudents.forEach(student => {
        const key = ref.push().key;
        batch[key] = {
          id: key,
          classId,
          className,
          subject,
          studentId: Object.keys(students).find(id => students[id].name === student.name) || '',
          studentName: student.name,
          title,
          description,
          textbook,
          pageRange,
          assignedDate: todayYMD(),
          dueDate,
          completed: false,
          completedAt: null,
          feedback: '',
          notificationSent: false,
          notificationSentAt: null
        };
      });

      ref.update(batch)
        .then(() => {
          alert(`${classStudents.length}명에게 숙제가 등록되었습니다.`);
          document.getElementById('hwBulkTitle').value = '';
          document.getElementById('hwTextbook').value = '';
          document.getElementById('hwPageRange').value = '';
          document.getElementById('hwDescription').value = '';
          toggleHomeworkForm();
        })
        .catch(err => { console.error('일괄 숙제 추가 실패:', err); alert('일괄 숙제 추가 실패'); });
    }

    // 수업 선택 시 해당 수업 학생만 필터링
    function onHwClassChange() {
      updateHwStudentsList();
      // 수업 변경 시 학생 입력 초기화
      document.getElementById('hwStudentName').value = '';
      document.getElementById('hwStudentInfo').innerHTML = '';
    }

    // 학생 목록 업데이트 (선택된 수업에 따라 필터링)
    function updateHwStudentsList() {
      const datalist = document.getElementById('hwStudentsList');
      const selectedClassId = document.getElementById('hwClassSelect').value;
      const selectedClassName = selectedClassId ? (classes[selectedClassId]?.name || '') : '';

      let filteredStudents = Object.entries(students);

      // 수업이 선택된 경우 해당 수업 학생만 필터링
      if (selectedClassName) {
        filteredStudents = filteredStudents.filter(([id, s]) => {
          const studentClasses = parseClassList(s.classes);
          return studentClasses.some(c => c.includes(selectedClassName) || selectedClassName.includes(c));
        });
      }

      // datalist 업데이트
      let html = '';
      filteredStudents.forEach(([id, s]) => {
        const classInfo = formatClassList(s.classes);
        html += `<option value="${escapeHTML(s.name)}">${classInfo ? `(${escapeHTML(classInfo)})` : ''}</option>`;
      });
      datalist.innerHTML = html;
    }

    // 학생 선택 시 수업 자동 선택
    function onHwStudentChange(studentName) {
      showStudentInfo(studentName, 'hwStudentInfo');

      // 학생 찾기
      const student = Object.values(students).find(s => s.name === studentName);
      if (!student) return;

      // 학생의 수업 목록 가져오기
      const studentClasses = parseClassList(student.classes);
      if (studentClasses.length === 0) return;

      // 현재 선택된 수업이 없거나 학생의 수업과 맞지 않으면 자동 선택
      const classSelect = document.getElementById('hwClassSelect');
      const currentClassId = classSelect.value;
      const currentClassName = currentClassId ? (classes[currentClassId]?.name || '') : '';

      // 학생의 수업 중 하나라도 현재 선택과 일치하면 유지
      const matchesCurrent = studentClasses.some(c => c.includes(currentClassName) || currentClassName.includes(c));
      if (matchesCurrent && currentClassId) return;

      // 첫 번째 일치하는 수업 자동 선택
      for (const [classId, classInfo] of Object.entries(classes)) {
        if (classInfo.status === 'ended') continue;
        const match = studentClasses.some(sc => sc.includes(classInfo.name) || classInfo.name.includes(sc));
        if (match) {
          classSelect.value = classId;
          break;
        }
      }
    }

    function setHomeworkClassFilter(value) {
      homeworkClassFilter = value;
      renderHomework();
    }

    function setHomeworkStatusFilter(value) {
      homeworkStatusFilter = value;
      renderHomework();
    }

    function setClassStatusFilter(status) {
      classStatusFilter = status;
      document.getElementById('classStatusAll').className = status === 'all' ? 'px-3 py-1 rounded bg-indigo-600 text-white text-sm' : 'px-3 py-1 rounded bg-gray-200 text-gray-700 text-sm';
      document.getElementById('classStatusActive').className = status === 'active' ? 'px-3 py-1 rounded bg-indigo-600 text-white text-sm' : 'px-3 py-1 rounded bg-gray-200 text-gray-700 text-sm';
      document.getElementById('classStatusEnded').className = status === 'ended' ? 'px-3 py-1 rounded bg-indigo-600 text-white text-sm' : 'px-3 py-1 rounded bg-gray-200 text-gray-700 text-sm';
      renderClasses();
    }

    function addHomework() {
      const classId = document.getElementById('hwClassSelect').value;
      const studentName = document.getElementById('hwStudentName').value.trim();
      const title = document.getElementById('hwTitle').value.trim();
      const textbook = document.getElementById('hwTextbook').value.trim();
      const pageRange = document.getElementById('hwPageRange').value.trim();
      const dueDate = document.getElementById('hwDueDate').value;
      const description = document.getElementById('hwDescription').value.trim();

      if (!studentName || !title || !dueDate) {
        alert('학생 이름, 숙제 내용, 마감일은 필수입니다.');
        return;
      }

      // 학생 ID 찾기
      let studentId = '';
      for (const [id, s] of Object.entries(students)) {
        if (s.name === studentName) {
          studentId = id;
          break;
        }
      }

      // 수업 정보 가져오기
      const classInfo = classes[classId] || {};
      const className = classInfo.name || '';
      const subject = classInfo.subject || '';

      const ref = db.ref('homework');
      const key = ref.push().key;
      const item = {
        id: key,
        classId: classId || '',
        className,
        subject,
        studentId,
        studentName,
        title,
        description,
        textbook,
        pageRange,
        assignedDate: todayYMD(),
        dueDate,
        completed: false,
        completedAt: null,
        feedback: '',
        notificationSent: false,
        notificationSentAt: null
      };

      ref.child(key).set(item)
        .then(() => {
          document.getElementById('hwStudentName').value = '';
          document.getElementById('hwTitle').value = '';
          document.getElementById('hwTextbook').value = '';
          document.getElementById('hwPageRange').value = '';
          document.getElementById('hwDescription').value = '';
          toggleHomeworkForm();
        })
        .catch(err => { console.error('숙제 추가 실패:', err); alert('숙제 추가 실패'); });
    }

    function toggleHomeworkComplete(id) {
      const hw = homework[id];
      if (!hw) return;
      const updates = {
        completed: !hw.completed,
        completedAt: !hw.completed ? new Date().toISOString() : null
      };
      db.ref(`homework/${id}`).update(updates).catch(err => console.error('숙제 완료 토글 실패:', err));
    }

    function deleteHomework(id) {
      const hw = homework[id];
      if (!hw || !confirm(`${hw.studentName}의 숙제 "${hw.title}"을(를) 삭제하시겠습니까?`)) return;
      db.ref(`homework/${id}`).remove().catch(err => console.error('숙제 삭제 실패:', err));
    }

    function addHomeworkFeedback(id) {
      const hw = homework[id];
      if (!hw) return;
      const feedback = prompt('피드백을 입력하세요:', hw.feedback || '');
      if (feedback === null) return;
      db.ref(`homework/${id}/feedback`).set(feedback).catch(err => console.error('피드백 저장 실패:', err));
    }

    function renderHomework() {
      const container = document.getElementById('homeworkList');
      const today = todayYMD();

      // 필터링
      let filtered = Object.entries(homework);

      if (homeworkClassFilter !== 'all') {
        filtered = filtered.filter(([id, hw]) => hw.classId === homeworkClassFilter);
      }

      if (homeworkStatusFilter === 'incomplete') {
        filtered = filtered.filter(([id, hw]) => !hw.completed);
      } else if (homeworkStatusFilter === 'completed') {
        filtered = filtered.filter(([id, hw]) => hw.completed);
      } else if (homeworkStatusFilter === 'overdue') {
        filtered = filtered.filter(([id, hw]) => !hw.completed && hw.dueDate < today);
      }

      // 정렬: 미완료 먼저, 마감일 순
      filtered.sort((a, b) => {
        if (a[1].completed !== b[1].completed) return a[1].completed ? 1 : -1;
        return (a[1].dueDate || '').localeCompare(b[1].dueDate || '');
      });

      // 마감일 기준으로 그룹화
      const groups = {};
      filtered.forEach(([id, hw]) => {
        const key = hw.dueDate || '날짜 미지정';
        if (!groups[key]) groups[key] = [];
        groups[key].push({ id, ...hw });
      });

      document.getElementById('homeworkCount').textContent = filtered.length;

      // 오늘 마감 배지
      const todayDue = Object.values(homework).filter(hw => hw.dueDate === today && !hw.completed).length;
      const badge = document.getElementById('todayHomeworkBadge');
      if (todayDue > 0) {
        badge.style.display = 'inline';
        badge.textContent = `오늘 마감 ${todayDue}개`;
      } else {
        badge.style.display = 'none';
      }

      if (filtered.length === 0) {
        container.innerHTML = '<div class="text-center text-gray-500 py-8">등록된 숙제가 없습니다.</div>';
        return;
      }

      let html = '';
      const sortedDates = Object.keys(groups).sort();

      sortedDates.forEach(date => {
        const isToday = date === today;
        const isOverdue = date < today;
        const dateLabel = date === '날짜 미지정' ? date : formatDateKorean(date);
        const bgClass = isOverdue ? 'bg-red-50 border-red-300' : (isToday ? 'bg-orange-50 border-orange-300' : 'bg-gray-50 border-gray-200');
        const labelClass = isOverdue ? 'text-red-600' : (isToday ? 'text-orange-600' : 'text-gray-700');

        html += `<div class="border-2 ${bgClass} rounded-xl p-4 mb-3">
          <h3 class="font-bold ${labelClass} mb-3">${isOverdue ? '⚠️ 기한 초과: ' : (isToday ? '🔔 오늘 마감: ' : '')}${dateLabel}</h3>
          <div class="space-y-2">`;

        groups[date].forEach(hw => {
          const completedClass = hw.completed ? 'bg-gray-100 opacity-70' : 'bg-white';
          const textClass = hw.completed ? 'line-through text-gray-500' : '';
          const subjectBadge = hw.subject ? `<span class="text-xs px-2 py-0.5 rounded-full ${hw.subject === '수학' ? 'bg-purple-100 text-purple-700' : (hw.subject === '영어' ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-700')}">${escapeHTML(hw.subject)}</span>` : '';

          html += `<div class="flex items-center gap-3 p-3 ${completedClass} rounded-lg border">
            <button onclick="toggleHomeworkComplete('${hw.id}')" class="text-2xl ${hw.completed ? 'text-green-600' : 'text-gray-300 hover:text-green-500'}">${hw.completed ? '✅' : '⭕'}</button>
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2 flex-wrap">
                <span class="font-semibold ${textClass}">${escapeHTML(hw.studentName)}</span>
                ${subjectBadge}
                ${hw.className ? `<span class="text-xs text-gray-500">${escapeHTML(hw.className)}</span>` : ''}
              </div>
              <div class="text-sm ${textClass}">${escapeHTML(hw.title)}</div>
              ${hw.textbook || hw.pageRange ? `<div class="text-xs text-gray-500">${escapeHTML(hw.textbook || '')} ${escapeHTML(hw.pageRange || '')}</div>` : ''}
              ${hw.description ? `<div class="text-xs text-gray-400 mt-1">${escapeHTML(hw.description)}</div>` : ''}
              ${hw.feedback ? `<div class="text-xs text-blue-600 bg-blue-50 rounded px-2 py-1 mt-1">💬 ${escapeHTML(hw.feedback)}</div>` : ''}
              ${hw.notificationSent ? `<div class="text-xs text-green-600 mt-1">✉️ 알림 발송됨</div>` : ''}
            </div>
            <div class="flex gap-1 flex-shrink-0">
              <button onclick="openKakaoMessage('${hw.id}')" class="px-2 py-1 text-xs bg-yellow-100 text-yellow-700 rounded hover:bg-yellow-200" title="알림톡">📱</button>
              <button onclick="addHomeworkFeedback('${hw.id}')" class="px-2 py-1 text-xs bg-blue-100 text-blue-700 rounded hover:bg-blue-200" title="피드백">💬</button>
              <button onclick="deleteHomework('${hw.id}')" class="delete-btn text-gray-400 hover:text-red-500" title="삭제">✕</button>
            </div>
          </div>`;
        });

        html += '</div></div>';
      });

      container.innerHTML = html;
    }

    // ===================== 수업 관리 =====================
    function addClass() {
      const name = document.getElementById('newClassName').value.trim();
      const subject = document.getElementById('newClassSubject').value;
      const teacher = document.getElementById('newClassTeacher').value.trim();
      const schedule = document.getElementById('newClassSchedule').value.trim();

      if (!name) {
        alert('수업명을 입력해주세요.');
        return;
      }

      const ref = db.ref('classes');
      const key = ref.push().key;
      const item = {
        id: key,
        name,
        subject,
        teacher,
        status: 'active',
        schedule,
        createdAt: todayYMD(),
        endedAt: null,
        autoExtracted: false
      };

      ref.child(key).set(item)
        .then(() => {
          document.getElementById('newClassName').value = '';
          document.getElementById('newClassTeacher').value = '';
          document.getElementById('newClassSchedule').value = '';
        })
        .catch(err => { console.error('수업 추가 실패:', err); alert('수업 추가 실패'); });
    }

    function endClass(id) {
      const c = classes[id];
      if (!c) return;
      const newStatus = c.status === 'ended' ? 'active' : 'ended';
      const updates = {
        status: newStatus,
        endedAt: newStatus === 'ended' ? todayYMD() : null
      };
      db.ref(`classes/${id}`).update(updates).catch(err => console.error('수업 상태 변경 실패:', err));
    }

    function deleteClass(id) {
      const c = classes[id];
      if (!c || !confirm(`"${c.name}" 수업을 삭제하시겠습니까?\n관련 숙제는 삭제되지 않습니다.`)) return;
      db.ref(`classes/${id}`).remove().catch(err => console.error('수업 삭제 실패:', err));
    }

    function extractClassesFromStudents() {
      // 학생 데이터에서 수업명 추출
      const classNames = new Set();
      Object.values(students).forEach(s => {
        if (s.classes && Array.isArray(s.classes)) {
          s.classes.forEach(c => classNames.add(c));
        } else if (s.classes) {
          parseClassList(s.classes).forEach(c => classNames.add(c));
        }
      });

      if (classNames.size === 0) {
        alert('학생 데이터에서 수업을 찾을 수 없습니다.');
        return;
      }

      // 기존 수업명 목록
      const existingNames = new Set(Object.values(classes).map(c => c.name));

      // 새로운 수업만 추가
      const newClasses = [...classNames].filter(name => !existingNames.has(name));

      if (newClasses.length === 0) {
        alert('추가할 새 수업이 없습니다. (모두 이미 등록됨)');
        return;
      }

      if (!confirm(`${newClasses.length}개의 새 수업을 추가하시겠습니까?\n\n${newClasses.join('\n')}`)) return;

      const ref = db.ref('classes');
      const batch = {};
      newClasses.forEach(name => {
        const key = ref.push().key;
        batch[key] = {
          id: key,
          name,
          subject: guessSubjectFromName(name),
          teacher: '',
          status: 'active',
          schedule: '',
          createdAt: todayYMD(),
          endedAt: null,
          autoExtracted: true
        };
      });

      ref.update(batch)
        .then(() => alert(`${newClasses.length}개의 수업이 추가되었습니다.`))
        .catch(err => { console.error('수업 추출 실패:', err); alert('수업 추출 실패'); });
    }

    function guessSubjectFromName(name) {
      const lower = name.toLowerCase();
      if (lower.includes('수학') || lower.includes('math')) return '수학';
      if (lower.includes('영어') || lower.includes('english')) return '영어';
      if (lower.includes('국어') || lower.includes('korean')) return '국어';
      if (lower.includes('과학') || lower.includes('science')) return '과학';
      if (lower.includes('사회') || lower.includes('역사')) return '사회';
      return '기타';
    }

    function renderClasses() {
      const container = document.getElementById('classesList');

      let filtered = Object.entries(classes);
      if (classStatusFilter === 'active') {
        filtered = filtered.filter(([id, c]) => c.status !== 'ended');
      } else if (classStatusFilter === 'ended') {
        filtered = filtered.filter(([id, c]) => c.status === 'ended');
      }

      filtered.sort((a, b) => (a[1].name || '').localeCompare(b[1].name || ''));

      if (filtered.length === 0) {
        container.innerHTML = '<div class="text-center text-gray-500 py-4">수업이 없습니다</div>';
        return;
      }

      let html = '';
      filtered.forEach(([id, c]) => {
        const isEnded = c.status === 'ended';
        const bgClass = isEnded ? 'bg-gray-100' : 'bg-white';
        const textClass = isEnded ? 'text-gray-500' : '';
        const subjectBadge = `<span class="text-xs px-2 py-0.5 rounded-full ${c.subject === '수학' ? 'bg-purple-100 text-purple-700' : (c.subject === '영어' ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-700')}">${escapeHTML(c.subject || '기타')}</span>`;

        html += `<div class="flex items-center gap-3 p-3 ${bgClass} rounded-lg border">
          <div class="flex-1">
            <div class="flex items-center gap-2">
              <span class="font-semibold ${textClass}">${escapeHTML(c.name)}</span>
              ${subjectBadge}
              ${isEnded ? '<span class="text-xs px-2 py-0.5 rounded-full bg-red-100 text-red-600">종강</span>' : ''}
              ${c.autoExtracted ? '<span class="text-xs px-2 py-0.5 rounded-full bg-blue-100 text-blue-600">자동추출</span>' : ''}
            </div>
            ${c.teacher ? `<div class="text-sm text-gray-600">담당: ${escapeHTML(c.teacher)}</div>` : ''}
            ${c.schedule ? `<div class="text-xs text-gray-500">${escapeHTML(c.schedule)}</div>` : ''}
          </div>
          <div class="flex gap-1">
            <button onclick="endClass('${id}')" class="px-2 py-1 text-xs ${isEnded ? 'bg-green-100 text-green-700' : 'bg-orange-100 text-orange-700'} rounded hover:opacity-80">${isEnded ? '재개' : '종강'}</button>
            <button onclick="deleteClass('${id}')" class="delete-btn text-gray-400 hover:text-red-500">✕</button>
          </div>
        </div>`;
      });

      container.innerHTML = html;
    }

    // ===================== 카카오 알림톡 메시지 =====================
    function generateHomeworkMessage(homeworkId) {
      const hw = homework[homeworkId];
      if (!hw) return '';

      const student = students[hw.studentId] || {};
      const dueDateFormatted = hw.dueDate ? formatDateKorean(hw.dueDate) : '미정';

      let message = `[강한루시학원] 숙제 안내

안녕하세요, ${hw.studentName} 학생 보호자님.

📚 숙제: ${hw.title}`;

      if (hw.textbook || hw.pageRange) {
        message += `\n📖 교재/범위: ${hw.textbook || ''} ${hw.pageRange || ''}`.trim();
      }

      if (hw.description) {
        message += `\n📝 상세: ${hw.description}`;
      }

      message += `\n⏰ 마감일: ${dueDateFormatted}

감사합니다.`;

      return message;
    }

    function openKakaoMessage(homeworkId) {
      currentKakaoMessage = generateHomeworkMessage(homeworkId);
      document.getElementById('kakaoMessageContent').textContent = currentKakaoMessage;
      toggleKakaoMessageModal();
    }

    function copyKakaoMessage() {
      if (!currentKakaoMessage) return;

      navigator.clipboard.writeText(currentKakaoMessage)
        .then(() => {
          alert('메시지가 클립보드에 복사되었습니다.');
        })
        .catch(err => {
          console.error('복사 실패:', err);
          // Fallback
          const textarea = document.createElement('textarea');
          textarea.value = currentKakaoMessage;
          document.body.appendChild(textarea);
          textarea.select();
          document.execCommand('copy');
          document.body.removeChild(textarea);
          alert('메시지가 클립보드에 복사되었습니다.');
        });
    }

    // ===================== 엑셀 숙제 업로드 =====================
    function importHomeworkFromExcel(event) {
      const input = event.target;
      const file = input.files && input.files[0];
      if (!file) return;
      if (!window.XLSX) {
        alert('엑셀 라이브러리를 불러오지 못했습니다.');
        input.value = '';
        return;
      }

      const reader = new FileReader();
      reader.onload = () => {
        try {
          const data = new Uint8Array(reader.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });

          if (!rows.length) {
            alert('엑셀에 데이터가 없습니다.');
            return;
          }

          const header = rows[0].map(h => String(h).trim());
          const required = ['수업명', '학생이름', '숙제내용', '마감일'];
          const missing = required.filter(name => !header.includes(name));
          if (missing.length) {
            alert(`엑셀 헤더가 올바르지 않습니다.\n필수: ${required.join(', ')}`);
            return;
          }

          const colIdx = {};
          ['수업명', '학생이름', '숙제내용', '마감일', '교재', '범위'].forEach(name => {
            colIdx[name] = header.indexOf(name);
          });

          // 수업명 -> 수업ID 매핑
          const classNameToId = {};
          Object.entries(classes).forEach(([id, c]) => {
            classNameToId[c.name] = id;
          });

          // 학생명 -> 학생ID 매핑
          const studentNameToId = {};
          Object.entries(students).forEach(([id, s]) => {
            studentNameToId[s.name] = id;
          });

          const ref = db.ref('homework');
          const batch = {};
          let addedCount = 0;
          let skippedCount = 0;

          for (let i = 1; i < rows.length; i++) {
            const row = rows[i];
            const className = String(row[colIdx['수업명']] || '').trim();
            const studentName = String(row[colIdx['학생이름']] || '').trim();
            const title = String(row[colIdx['숙제내용']] || '').trim();
            let dueDate = String(row[colIdx['마감일']] || '').trim();
            const textbook = colIdx['교재'] >= 0 ? String(row[colIdx['교재']] || '').trim() : '';
            const pageRange = colIdx['범위'] >= 0 ? String(row[colIdx['범위']] || '').trim() : '';

            if (!studentName || !title || !dueDate) {
              skippedCount++;
              continue;
            }

            // 날짜 형식 변환 (YYYY-MM-DD 또는 YYYY/MM/DD 또는 숫자 형식)
            if (typeof row[colIdx['마감일']] === 'number') {
              // Excel 날짜 시리얼 넘버
              const excelDate = new Date((row[colIdx['마감일']] - 25569) * 86400 * 1000);
              dueDate = ymdOf(excelDate);
            } else {
              dueDate = dueDate.replace(/\//g, '-');
              // YYYY-MM-DD 형식 확인
              if (!/^\d{4}-\d{2}-\d{2}$/.test(dueDate)) {
                skippedCount++;
                continue;
              }
            }

            const classId = classNameToId[className] || '';
            const classInfo = classes[classId] || {};
            const studentId = studentNameToId[studentName] || '';

            const key = ref.push().key;
            batch[key] = {
              id: key,
              classId,
              className,
              subject: classInfo.subject || '',
              studentId,
              studentName,
              title,
              description: '',
              textbook,
              pageRange,
              assignedDate: todayYMD(),
              dueDate,
              completed: false,
              completedAt: null,
              feedback: '',
              notificationSent: false,
              notificationSentAt: null
            };
            addedCount++;
          }

          if (addedCount === 0) {
            alert(`추가할 숙제가 없습니다. (건너뜀: ${skippedCount}건)`);
            return;
          }

          ref.update(batch)
            .then(() => alert(`엑셀 업로드 완료: ${addedCount}건 추가, ${skippedCount}건 건너뜀`))
            .catch(err => { console.error('엑셀 업로드 실패:', err); alert('엑셀 업로드 실패'); });

        } catch (err) {
          console.error(err);
          alert('엑셀 읽기 실패');
        } finally {
          input.value = '';
        }
      };

      reader.readAsArrayBuffer(file);
    }

    // 클래스카드
    function ccApplyRoster() {
      const names = parseList(document.getElementById('ccRosterInput').value);
      const map = {}; names.forEach(n => map[n]=true);
      db.ref(`classcard/${currentViewDate}/roster`).set(map);
    }
    function ccApplyDone() {
      const names = parseList(document.getElementById('ccDoneInput').value);
      const map = {}; names.forEach(n => map[n]=true);
      db.ref(`classcard/${currentViewDate}/done`).set(map);
    }
    function ccClearAll() {
      db.ref(`classcard/${currentViewDate}`).set({ roster:{}, done:{} });
    }

    // 누적 단어
    function vaApplyRoster() {
      const names = parseList(document.getElementById('vaRosterInput').value);
      const map = {}; names.forEach(n => map[n]=true);
      db.ref(`vocabAccum/${currentViewDate}/roster`).set(map);
    }
    function vaApplyDone() {
      const names = parseList(document.getElementById('vaDoneInput').value);
      const map = {}; names.forEach(n => map[n]=true);
      db.ref(`vocabAccum/${currentViewDate}/done`).set(map);
    }
    function vaClearAll() {
      db.ref(`vocabAccum/${currentViewDate}`).set({ roster:{}, done:{} });
    }

    // 한 주간 단어 통계 생성
    let weeklyStatsData = {}; // 전역 변수로 저장

    function generateWeeklyVocabStats() {
      // 현재 날짜 기준 지난 7일간의 vocab events 분석
      const today = new Date(currentViewDate + 'T00:00:00');
      const weekAgo = new Date(today);
      weekAgo.setDate(weekAgo.getDate() - 6); // 오늘 포함 7일

      const startDate = ymdOf(weekAgo);
      const endDate = currentViewDate;

      // vocab.events에서 해당 기간의 완료된 시험만 필터링
      const events = Object.values(vocab.events || {}).filter(ev => {
        return ev.date >= startDate && ev.date <= endDate && ev.done === true;
      });

      if (events.length === 0) {
        alert('이번 주 완료된 단어 시험이 없습니다.');
        return;
      }

      // 학생별로 그룹화
      const studentStats = {};
      events.forEach(ev => {
        const student = ev.student || '이름없음';
        if (!studentStats[student]) {
          studentStats[student] = [];
        }

        const bookName = vocab.books[ev.bookId]?.name || ev.bookId || '단어장';
        const range = `${ev.rangeStart || '?'} ~ ${ev.rangeEnd || '?'}`;

        studentStats[student].push({
          bookName,
          range,
          rangeStart: ev.rangeStart,
          rangeEnd: ev.rangeEnd,
          date: ev.date
        });
      });

      // 학생별로 범위 합치기 (같은 단어장)
      const mergedStats = {};
      Object.keys(studentStats).forEach(student => {
        const tests = studentStats[student];

        // 단어장별로 그룹화
        const byBook = {};
        tests.forEach(t => {
          if (!byBook[t.bookName]) {
            byBook[t.bookName] = [];
          }
          byBook[t.bookName].push(t);
        });

        // 단어장별 범위 표시
        mergedStats[student] = Object.keys(byBook).map(bookName => {
          const ranges = byBook[bookName];
          if (ranges.length === 1) {
            return `${bookName}: ${ranges[0].range}`;
          } else {
            // 여러 시험이 있으면 시작~끝 범위 표시
            const starts = ranges.map(r => parseInt(r.rangeStart) || 0).filter(n => n > 0);
            const ends = ranges.map(r => parseInt(r.rangeEnd) || 0).filter(n => n > 0);
            if (starts.length > 0 && ends.length > 0) {
              const min = Math.min(...starts);
              const max = Math.max(...ends);
              return `${bookName}: ${min} ~ ${max} (${ranges.length}회)`;
            }
            return `${bookName}: 총 ${ranges.length}회`;
          }
        }).join(', ');
      });

      weeklyStatsData = mergedStats;

      // UI 업데이트
      const statsContainer = document.getElementById('weeklyVocabStats');
      const statsContent = document.getElementById('weeklyStatsContent');
      const statsRange = document.getElementById('weekStatsRange');

      statsRange.textContent = `${formatDateKorean(startDate)} ~ ${formatDateKorean(endDate)}`;

      const studentNames = Object.keys(mergedStats).sort((a, b) => a.localeCompare(b, 'ko'));

      statsContent.innerHTML = studentNames.map(student => `
        <div class="flex items-start gap-2 p-2 bg-white rounded border">
          <span class="font-bold text-purple-700 min-w-[80px]">${escapeHTML(student)}</span>
          <span class="text-gray-700 flex-1">${escapeHTML(mergedStats[student])}</span>
        </div>
      `).join('');

      statsContainer.style.display = 'block';
    }

    function applyWeeklyStats() {
      if (Object.keys(weeklyStatsData).length === 0) {
        alert('먼저 통계를 생성해주세요.');
        return;
      }

      // 학생 명단만 roster에 추가
      const names = Object.keys(weeklyStatsData);
      const map = {};
      names.forEach(n => map[n] = true);

      db.ref(`vocabAccum/${currentViewDate}/roster`).set(map)
        .then(() => {
          alert(`${names.length}명의 학생이 명단에 추가되었습니다.`);
          // 통계 정보를 textarea에도 표시
          const details = names.map(student => `${student}: ${weeklyStatsData[student]}`).join('\n');
          document.getElementById('vaRosterInput').value = details;
        })
        .catch(err => {
          console.error('명단 적용 실패:', err);
          alert('명단 적용 중 오류가 발생했습니다.');
        });
    }

    /* ===================== 리스너 관리 ===================== */
    function detachListeners() {
      try { if (dailyRef)  { dailyRef.off();  dailyRef=null; } } catch(e){}
      try { if (koreanRef) { koreanRef.off(); koreanRef=null; } } catch(e){}
      try { if (hsRef)     { hsRef.off();     hsRef=null; } } catch(e){}
      try { if (typingRef) { typingRef.off(); typingRef=null; } } catch(e){}
      try { if (ccRef)     { ccRef.off();     ccRef=null; } } catch(e){}
      try { if (vaRef)     { vaRef.off();     vaRef=null; } } catch(e){}
      // retestRef, settingsRef, vocab refs는 전역 유지
    }

    // 과거 미완료 항목 로드
    async function loadPastIncompleteTasks() {
      console.log('과거 미완료 항목 로드 시작...');
      const startTime = Date.now();

      pastIncompleteDailyTasks = {};
      pastIncompleteTypingTasks = {};

      const today = todayYMD();
      const promises = [];
      let errorCount = 0;

      try {
        // 과거 30일 체크
        for (let i = 1; i <= 30; i++) {
          const pastDate = addDays(today, -i);

          // Daily tasks 체크
          promises.push(
            db.ref('daily/' + pastDate).once('value').then(snap => {
              if (snap.exists()) {
                const tasks = snap.val();
                const incomplete = {};
                for (const [id, task] of Object.entries(tasks)) {
                  if (!task.checked) {
                    incomplete[id] = {...task, originalDate: pastDate};
                  }
                }
                if (Object.keys(incomplete).length > 0) {
                  pastIncompleteDailyTasks[pastDate] = incomplete;
                }
              }
            }).catch(err => {
              console.error('과거 daily 로드 실패:', pastDate, err);
              errorCount++;
            })
          );

          // Typing tasks 체크
          promises.push(
            db.ref('typing/' + pastDate).once('value').then(snap => {
              if (snap.exists()) {
                const tasks = snap.val();
                const incomplete = {};
                for (const [id, task] of Object.entries(tasks)) {
                  if (!task.completed) {
                    incomplete[id] = {...task, originalDate: pastDate};
                  }
                }
                if (Object.keys(incomplete).length > 0) {
                  pastIncompleteTypingTasks[pastDate] = incomplete;
                }
              }
            }).catch(err => {
              console.error('과거 typing 로드 실패:', pastDate, err);
              errorCount++;
            })
          );
        }

        await Promise.all(promises);

        const elapsed = Date.now() - startTime;
        const dailyCount = Object.keys(pastIncompleteDailyTasks).reduce((sum, date) =>
          sum + Object.keys(pastIncompleteDailyTasks[date]).length, 0);
        const typingCount = Object.keys(pastIncompleteTypingTasks).reduce((sum, date) =>
          sum + Object.keys(pastIncompleteTypingTasks[date]).length, 0);

        console.log(`과거 미완료 항목 로드 완료 (${elapsed}ms): 할일 ${dailyCount}개, 타이핑 ${typingCount}개`);

        // 에러가 많이 발생한 경우 사용자에게 알림
        if (errorCount > 10) {
          console.warn(`과거 미완료 항목 로드 중 ${errorCount}개의 오류가 발생했습니다.`);
        }
      } catch (err) {
        console.error('과거 미완료 항목 로드 중 치명적 오류:', err);
        // 치명적 오류가 발생해도 앱은 계속 작동하도록 함
      }
      // 렌더링은 리스너에서 자동으로 수행됨
    }

    async function attachListenersForDate() {
      // 과거 미완료 항목을 먼저 로드
      await loadPastIncompleteTasks();

      // daily
      dailyRef = db.ref('daily/' + currentViewDate);
      dailyRef.on('value', snap => {
        if (!snap.exists()) {
          seedDefaultDaily(currentViewDate).then(() => {
            dailyTasks = {};
            renderDailyTasks(); checkNotifications();
          });
        } else {
          dailyTasks = snap.val() || {};
          renderDailyTasks(); checkNotifications();
        }
      }, err => {
        console.error('일일 태스크 로드 실패:', err);
        dailyTasks = {};
        renderDailyTasks();
      });

      // korean
      koreanRef = db.ref('korean/' + currentViewDate);
      koreanRef.on('value', snap => {
        koreanCoaching = snap.val() || {};
        renderKorean(); checkNotifications();
      }, err => {
        console.error('국어 데이터 로드 실패:', err);
        koreanCoaching = {};
        renderKorean();
      });

      // 역사/과학 관리반
      hsRef = db.ref('hsMgmt/' + currentViewDate);
      hsRef.on('value', snap => {
        hsMgmt = snap.val() || {};
        renderHsMgmt(); checkNotifications();
      }, err => {
        console.error('역사/과학 로드 실패:', err);
        hsMgmt = {};
        renderHsMgmt();
      });

      // typing
      typingRef = db.ref('typing/' + currentViewDate);
      typingRef.on('value', snap => {
        typingTasks = snap.val() || {};
        renderTyping(); checkNotifications();
      }, err => {
        console.error('타이핑 데이터 로드 실패:', err);
        typingTasks = {};
        renderTyping();
      });

      // 클래스카드
      ccRef = db.ref('classcard/' + currentViewDate);
      ccRef.on('value', snap => {
        const val = snap.val();
        ccState = val ? { roster: val.roster || {}, done: val.done || {} } : { roster:{}, done:{} };
        renderClasscard(); checkNotifications();
      }, err => {
        console.error('클래스카드 로드 실패:', err);
        ccState = { roster:{}, done:{} };
        renderClasscard();
      });

      // 누적단어
      vaRef = db.ref('vocabAccum/' + currentViewDate);
      vaRef.on('value', snap => {
        const val = snap.val();
        vaState = val ? { roster: val.roster || {}, done: val.done || {} } : { roster:{}, done:{} };
        renderVocabAccum(); checkNotifications();
      }, err => {
        console.error('누적단어 로드 실패:', err);
        vaState = { roster:{}, done:{} };
        renderVocabAccum();
      });

      // 🌟 단어 스케줄러: 이벤트는 날짜 기반 렌더에 사용
      // (events는 전역 리스너에서 이미 가져오므로 여기서는 렌더만)
      vocabRenderAll();
    }

    function attachGlobalListenersOnce() {
      if (!retestRef) {
        retestRef = db.ref('retest');
        retestRef.on('value', snap => {
          retestStudents = snap.val() || {};
          renderRetest(); checkNotifications();
        }, err => {
          console.error('재시험 데이터 로드 실패:', err);
          retestStudents = {};
          renderRetest();
        });
      }
      if (!tutoringAllRef) {
        tutoringAllRef = db.ref('tutoringSessions');
        tutoringAllRef.on('value', snap => {
          tutoringSessions = snap.val() || {};
          renderTutoring(); checkNotifications(); renderAnalysis();
        }, err => {
          console.error('보강 데이터 로드 실패:', err);
          tutoringSessions = {};
          renderTutoring();
        });
      }
      if (!settingsRef) {
        settingsRef = db.ref('settings/defaultDailyTasks');
        settingsRef.on('value', snap => {
          defaultDaily = (snap.val() || []).filter(Boolean);
        }, err => {
          console.error('설정 로드 실패:', err);
          defaultDaily = [];
        });
      }
      // 🌟 단어 스케줄러 전역 리스너
      if(!vbRef){
        vbRef = db.ref('vocab/books');
        vbRef.on('value', snap=>{
          vocab.books = snap.val() || {};
          vocabRenderBooks(); vocabPopulateBookSelect(); vocabRenderToday(); vocabRenderUpcoming();
        });
      }
      if(!vrRef){
        vrRef = db.ref('vocab/rules');
        vrRef.on('value', snap=>{
          vocab.rules = snap.val() || {};
          vocabRenderRules();
        });
      }
      if(!veRef){
        veRef = db.ref('vocab/events');
        veRef.on('value', snap=>{
          vocab.events = snap.val() || {};
          vocabRenderToday(); vocabRenderUpcoming(); checkNotifications();
        });
      }
      // 학생 명단 관리
      if(!studentsRef){
        studentsRef = db.ref('students');
        studentsRef.on('value', snap=>{
          students = snap.val() || {};
          renderStudents();
          console.log(`✅ 학생 데이터 로드 완료: ${Object.keys(students).length}명`);
        }, err => {
          console.error('❌ 학생 데이터 로드 실패:', err);
          students = {};
          renderStudents();
          // Firebase 연결 오류 시 사용자에게 알림
          if (err.code === 'PERMISSION_DENIED') {
            alert('⚠️ Firebase 권한 오류: 데이터베이스 규칙을 확인해주세요.');
          } else if (err.code === 'NETWORK_ERROR') {
            alert('⚠️ 네트워크 오류: 인터넷 연결을 확인해주세요.');
          } else {
            alert(`⚠️ 학생 데이터 로드 실패: ${err.message || '알 수 없는 오류'}`);
          }
        });
      }

      // 숙제 관리
      if(!homeworkRef){
        homeworkRef = db.ref('homework');
        homeworkRef.on('value', snap=>{
          homework = snap.val() || {};
          renderHomework(); populateHomeworkClassSelect(); checkNotifications();
          console.log(`✅ 숙제 데이터 로드 완료: ${Object.keys(homework).length}개`);
        }, err => {
          console.error('❌ 숙제 데이터 로드 실패:', err);
          homework = {};
          renderHomework();
        });
      }

      // 수업 관리
      if(!classesRef){
        classesRef = db.ref('classes');
        classesRef.on('value', snap=>{
          classes = snap.val() || {};
          renderClasses(); populateHomeworkClassSelect();
          console.log(`✅ 수업 데이터 로드 완료: ${Object.keys(classes).length}개`);
        }, err => {
          console.error('❌ 수업 데이터 로드 실패:', err);
          classes = {};
          renderClasses();
        });
      }
    }

    /* ===================== 날짜 이동/초기화 ===================== */
    function changeDate(dir) {
      const d = new Date(currentViewDate + 'T00:00:00');
      d.setDate(d.getDate() + dir);
      currentViewDate = ymdOf(d);
      updateDateDisplay();
      detachListeners();
      attachListenersForDate();
    }
    function goToToday() {
      currentViewDate = todayYMD();
      updateDateDisplay();
      detachListeners();
      attachListenersForDate();
    }
    function toggleNotification() {
      const panel = document.getElementById('notificationPanel');
      panel.style.display = (panel.style.display === 'none' || !panel.style.display) ? 'block' : 'none';
    }

    /* ===========================================================
       🌟 단어시험 스케줄러 로직 (Firebase /vocab/*)
       =========================================================== */
    // ---- 탭 전환
    function vocabSwitchTab(name){
      const tabs = ['today','upcoming','rules','books','help'];
      tabs.forEach(t=>{
        document.getElementById('vocabView'+t.charAt(0).toUpperCase()+t.slice(1)).classList.toggle('hidden', t!==name);
        document.getElementById('vocabTab'+t.charAt(0).toUpperCase()+t.slice(1)).classList.toggle('btn', t===name);
        document.getElementById('vocabTab'+t.charAt(0).toUpperCase()+t.slice(1)).classList.toggle('btn-secondary', t!==name);
      });
      if(name==='today') vocabRenderToday();
      if(name==='upcoming') vocabRenderUpcoming();
      if(name==='rules') vocabRenderRules();
      if(name==='books') { vocabRenderBooks(); vocabPopulateBookSelect(); }
    }

    // ---- 공통 파서
    function vocabParseRange(txt){
      const m = (txt||'').match(/^\s*(\d+)\s*-\s*(\d+)\s*$/);
      if(!m) return null;
      return {start: parseInt(m[1],10), end: parseInt(m[2],10)};
    }
    function vocabNearestOnOrAfter(ymd, weekdays){
      // 요일 배열 유효성 검증
      if (!weekdays || !Array.isArray(weekdays) || weekdays.length === 0) {
        console.error('vocabNearestOnOrAfter: 유효하지 않은 요일 배열:', weekdays);
        return null;
      }
      const d = new Date(ymd+'T00:00:00');
      const dw = d.getDay();
      if(weekdays.includes(dw)) return ymd;
      let best = ymd, minDiff=7;
      for(const w of weekdays){
        let diff = (w - dw + 7) % 7; if(diff===0) diff=7;
        if(diff<minDiff){ minDiff=diff; best = addDays(ymd, diff); }
      }
      return best;
    }
    function vocabNextByWeekdays(ymd, weekdays){
      // 요일 배열 유효성 검증
      if (!weekdays || !Array.isArray(weekdays) || weekdays.length === 0) {
        console.error('vocabNextByWeekdays: 유효하지 않은 요일 배열:', weekdays);
        return null;
      }
      const d = new Date(ymd+'T00:00:00');
      const dw = d.getDay();
      const sorted = weekdays.slice().sort((a,b)=>a-b);
      let idx = sorted.indexOf(dw);
      if(idx===-1){
        return vocabNearestOnOrAfter(addDays(ymd,1), weekdays);
      }
      const next = sorted[(idx+1)%sorted.length];
      const diff = (next - dw + 7) % 7 || 7;
      return addDays(ymd, diff);
    }
    function vocabNextDates(startISO, weekdays, count){
      const out=[];
      let ymd = vocabNearestOnOrAfter(startISO, weekdays);
      if (!ymd) {
        console.error('vocabNextDates: vocabNearestOnOrAfter가 null을 반환했습니다');
        return [];
      }
      while(out.length<count){
        out.push(ymd);
        ymd = vocabNextByWeekdays(ymd, weekdays);
        if (!ymd) {
          console.error('vocabNextDates: vocabNextByWeekdays가 null을 반환했습니다');
          break;
        }
      }
      return out;
    }

    // ---- BOOKS
    function vocabPopulateBookSelect(){
      const sel = document.getElementById('vrBook');
      if(!sel) return;
      sel.innerHTML='';
      Object.entries(vocab.books).forEach(([id,b])=>{
        const opt = document.createElement('option');
        opt.value = id; opt.textContent = b.name;
        sel.appendChild(opt);
      });
    }
    function vocabRenderBooks(){
      const wrap = document.getElementById('vocabBooksList');
      if(!wrap) return;
      wrap.innerHTML='';
      const entries = Object.entries(vocab.books);
      if(entries.length===0){
        wrap.innerHTML = `<div class="text-slate-500">등록된 교재가 없습니다. 위에서 추가하세요.</div>`;
        return;
      }
      entries.forEach(([id,b])=>{
        const unitPreview = (b.units||[]).slice(0,8).join(', ') + ((b.units||[]).length>8 ? '…':'');
        const el = document.createElement('div');
        el.className='p-3 border rounded bg-white flex items-center justify-between gap-2';
        el.innerHTML = `
          <div>
            <div class="font-medium">${escapeHTML(b.name)}</div>
            <div class="text-xs text-slate-500">총 ${(b.units||[]).length}과 · 예시: ${escapeHTML(unitPreview)}</div>
          </div>
          <div class="flex gap-2">
            <button class="btn btn-secondary" onclick="vocabDeleteBook('${id}')">삭제</button>
          </div>
        `;
        wrap.appendChild(el);
      });
    }
    function vocabAddBook(){
      const name = document.getElementById('vbName').value.trim();
      const count = parseInt(document.getElementById('vbCount').value,10);
      const prefix = (document.getElementById('vbPrefix').value.trim() || 'Unit');
      if(!name || !count || count<1){ alert('교재명과 총 과 수를 올바르게 입력하세요.'); return; }
      const units = Array.from({length:count},(_,i)=>`${prefix} ${i+1}`);
      const ref = db.ref('vocab/books');
      const id = ref.push().key;
      ref.child(id).set({name, units}).then(()=>{
        document.getElementById('vbName').value='';
        document.getElementById('vbCount').value='';
        document.getElementById('vbPrefix').value='';
      });
    }
    function vocabDeleteBook(id){
      if(!confirm('이 교재를 삭제할까요? (규칙은 남습니다)')) return;
      db.ref(`vocab/books/${id}`).remove();
    }

    // ---- RULES & EVENTS
    function vocabRenderRules(){
      const box = document.getElementById('vocabRulesList');
      if(!box) return;
      box.innerHTML='';
      const entries = Object.entries(vocab.rules);
      if(entries.length===0){
        box.innerHTML = `<div class="text-slate-500">규칙이 없습니다. 위에서 추가하세요.</div>`;
        return;
      }
      entries.forEach(([rid,r])=>{
        const book = vocab.books[r.bookId];
        const dowText = (r.weekdays||[]).map(dw=>['일','월','화','수','목','금','토'][dw]).join(', ');
        const modeText = r.overlapMode==='front' ? '앞에서 겹치기' : '끝 과 겹치기';
        const el = document.createElement('div');
        el.className='p-3 border rounded bg-white flex items-center justify-between gap-2';
        el.innerHTML = `
          <div>
            <div class="font-medium">${escapeHTML(r.student)} <span class="text-slate-400">(${escapeHTML(r.teacher)})</span></div>
            <div class="text-xs text-slate-500">
              교재: ${book?escapeHTML(book.name):'?'} · 시작: ${escapeHTML(r.startRange)} · 단위:${r.unitSize}
              · 겹침:${r.overlap} (${modeText}) · 요일:${escapeHTML(dowText)} · 시작일:${escapeHTML(r.startDate)}
              · 마지막 과:${r.maxUnit} · 생성:${r.occurrences}회
            </div>
          </div>
          <div class="flex gap-2">
            <button class="btn btn-secondary" onclick="vocabRegenForRule('${rid}', true)">일정 재생성</button>
            <button class="btn btn-secondary" onclick="vocabDeleteRule('${rid}')">규칙 삭제</button>
          </div>
        `;
        box.appendChild(el);
      });
    }
    function vocabAddRule(){
      const name = document.getElementById('vrName').value.trim();
      const teacher = document.getElementById('vrTeacher').value.trim();
      const bookId = document.getElementById('vrBook').value;
      const startRangeTxt = document.getElementById('vrStartRange').value.trim();
      const unitSize = parseInt(document.getElementById('vrUnit').value,10);
      const overlap = Math.max(0, parseInt(document.getElementById('vrOverlap').value,10));
      const overlapMode = document.getElementById('vrOverlapMode').value; // 'end' | 'front'
      const dows = Array.from(document.querySelectorAll('.vr-dow:checked')).map(x=>parseInt(x.value,10)).sort((a,b)=>a-b);
      const startDate = document.getElementById('vrStartDate').value || todayYMD();
      const maxUnit = parseInt(document.getElementById('vrMaxUnit').value,10) || undefined;
      const occurrences = parseInt(document.getElementById('vrOcc').value,10) || 40;

      if(!name || !teacher || !bookId || !startRangeTxt || !unitSize || dows.length===0){
        alert('학생/선생님/교재/시작범위/단위/요일을 확인하세요.'); return;
      }
      const r0 = vocabParseRange(startRangeTxt);
      if(!r0){ alert('시작 범위는 "1-3" 형태로 입력하세요.'); return; }

      const ref = db.ref('vocab/rules');
      const id = ref.push().key;
      const rule = { student:name, teacher, bookId, startRange:startRangeTxt, unitSize, overlap, overlapMode, weekdays:dows, startDate, maxUnit:(maxUnit || r0.end), occurrences };
      ref.child(id).set(rule).then(()=>{
        // 일정 생성
        vocabRegenForRule(id, true);
        document.getElementById('vrStartRange').value='';
      });
    }
    function vocabDeleteRule(id){
      if(!confirm('이 규칙을 삭제할까요? (이미 생성된 이벤트는 유지됩니다)')) return;
      db.ref(`vocab/rules/${id}`).remove();
    }

    function vocabRegenForRule(ruleId, clearExisting){
      const r = (vocab.rules||{})[ruleId];
      if(!r) return;
      const book = vocab.books[r.bookId];
      const unitsCount = book ? (book.units||[]).length : (r.maxUnit||9999);
      const dates = vocabNextDates(r.startDate, r.weekdays||[], r.occurrences||40);

      let cur = vocabParseRange(r.startRange);
      if(!cur) return;
      cur.start = clamp(cur.start,1,unitsCount);
      cur.end   = clamp(cur.end,  1,unitsCount);

      const evRef = db.ref('vocab/events');
      // 기존 이벤트 제거(해당 규칙만)
      if(clearExisting){
        const all = Object.entries(vocab.events||{});
        const updates = {};
        all.forEach(([eid, ev])=>{
          if(ev.ruleId===ruleId) updates[eid] = null;
        });
        evRef.update(updates);
      }

      // 새 이벤트 생성
      let batch = {};
      for(let i=0;i<dates.length;i++){
        if(cur.start > unitsCount) break;
        if(cur.end > unitsCount) cur.end = unitsCount;

        const eid = evRef.push().key;
        batch[eid] = {
          id: eid, ruleId: ruleId, student: r.student, teacher: r.teacher, bookId: r.bookId,
          date: dates[i], rangeStart: cur.start, rangeEnd: cur.end, done: false
        };

        // 다음 범위
        let nextStart;
        if(r.overlapMode==='front'){
          nextStart = cur.start + (r.overlap||0);
        }else{
          nextStart = cur.end - Math.max(0,(r.overlap||0)-1);
        }
        nextStart = clamp(nextStart,1,unitsCount);
        let nextEnd = nextStart + (r.unitSize-1);
        nextEnd = clamp(nextEnd,1,unitsCount);
        cur = {start: nextStart, end: nextEnd};

        if(cur.start > r.maxUnit) break;
        if(cur.end > r.maxUnit) cur.end = r.maxUnit;
      }
      if(Object.keys(batch).length){
        evRef.update(batch);
      }
    }

    // ---- TODAY / UPCOMING
    function vocabRenderToday(){
      const listEl = document.getElementById('vocabTodayList');
      const emptyEl = document.getElementById('vocabTodayEmpty');
      if(!listEl) return;

      const list = Object.values(vocab.events||{}).filter(e=>e.date===currentViewDate)
        .sort((a,b)=> a.student.localeCompare(b.student));
      listEl.innerHTML = '';
      if(list.length===0){ emptyEl.style.display='block'; return; }
      emptyEl.style.display='none';

      list.forEach(ev=>{
        const book = vocab.books[ev.bookId];
        const names = [];
        if(book && book.units){
          for(let i=ev.rangeStart;i<=ev.rangeEnd;i++){
            if(book.units[i-1]) names.push(book.units[i-1]);
          }
        }
        const row = document.createElement('div');
        row.className='p-3 border rounded bg-white flex items-center justify-between gap-3';

        // 연기된 시험인지 표시
        const rescheduledBadge = ev.isRescheduled ? '<span class="text-xs bg-orange-100 text-orange-700 px-2 py-0.5 rounded ml-2">연기됨</span>' : '';

        row.innerHTML = `
          <div class="flex-1">
            <div class="font-medium">${escapeHTML(ev.student)} <span class="text-slate-400">(${escapeHTML(ev.teacher)})</span>${rescheduledBadge}</div>
            <div class="text-sm text-slate-600">교재: ${book?escapeHTML(book.name):'?'} · 범위: ${ev.rangeStart}–${ev.rangeEnd}</div>
            <div class="text-xs text-slate-500">${escapeHTML(names.join(' · '))}</div>
            ${ev.originalDate ? `<div class="text-xs text-orange-600 mt-1">원래 예정: ${formatDateKorean(ev.originalDate)}</div>` : ''}
          </div>
          <div class="flex items-center gap-2">
            <label class="text-sm"><input type="checkbox" ${ev.done?'checked':''} onchange="vocabToggleDone('${ev.id}', this.checked)"/> 완료</label>
            <button class="btn btn-secondary" onclick="vocabRescheduleEvent('${ev.id}')">연기</button>
            <button class="btn btn-secondary" onclick="vocabDeleteEvent('${ev.id}')">삭제</button>
          </div>
        `;
        listEl.appendChild(row);
      });
    }
    function vocabRenderUpcoming(){
      const box = document.getElementById('vocabUpcomingList');
      if(!box) return;
      box.innerHTML='';

      const today = todayYMD();
      const until = addDays(today, 14);
      const arr = Object.values(vocab.events||{}).filter(ev=> ev.date>=today && ev.date<=until)
        .sort((a,b)=> a.date.localeCompare(b.date) || a.student.localeCompare(b.student));

      if(arr.length===0){
        box.innerHTML = `<div class="text-slate-500">2주 이내 일정이 없습니다.</div>`;
        return;
      }
      let cur=''; let group=null;
      arr.forEach(ev=>{
        if(ev.date!==cur){
          cur = ev.date;
          group = document.createElement('div');
          group.className='border rounded p-3 bg-slate-50';
          group.innerHTML = `<div class="font-semibold mb-2">${formatDateKorean(cur)} (${cur})</div>`;
          box.appendChild(group);
        }
        const book = vocab.books[ev.bookId];
        const names=[];
        if(book && book.units){
          for(let i=ev.rangeStart;i<=ev.rangeEnd;i++){
            if(book.units[i-1]) names.push(book.units[i-1]);
          }
        }

        // 연기된 시험인지 표시
        const rescheduledBadge = ev.isRescheduled ? '<span class="text-xs bg-orange-100 text-orange-700 px-2 py-0.5 rounded ml-2">연기됨</span>' : '';

        const row = document.createElement('div');
        row.className='pl-2 py-2 border-b last:border-b-0 flex items-center justify-between';
        row.innerHTML = `
          <div class="flex-1">
            <div class="font-medium">${escapeHTML(ev.student)} <span class="text-slate-400">(${escapeHTML(ev.teacher)})</span>${rescheduledBadge}</div>
            <div class="text-sm text-slate-600">교재: ${book?escapeHTML(book.name):'?'} · 범위: ${ev.rangeStart}–${ev.rangeEnd}</div>
            <div class="text-xs text-slate-500">${escapeHTML(names.join(' · '))}</div>
            ${ev.originalDate ? `<div class="text-xs text-orange-600 mt-1">원래 예정: ${formatDateKorean(ev.originalDate)}</div>` : ''}
          </div>
          <div class="flex items-center gap-2">
            <label class="text-sm"><input type="checkbox" ${ev.done?'checked':''} onchange="vocabToggleDone('${ev.id}', this.checked)"/> 완료</label>
            <button class="btn btn-secondary" onclick="vocabRescheduleEvent('${ev.id}')">연기</button>
            <button class="btn btn-secondary" onclick="vocabDeleteEvent('${ev.id}')">삭제</button>
          </div>
        `;
        group.appendChild(row);
      });
    }
    function vocabToggleDone(id, val){
      db.ref(`vocab/events/${id}/done`).set(!!val);
    }
    function vocabDeleteEvent(id){
      if(!confirm('이 단어시험 일정을 삭제할까요?')) return;
      db.ref(`vocab/events/${id}`).remove();
    }
    function vocabRescheduleEvent(id){
      const event = vocab.events[id];
      if(!event) return;

      // 해당 규칙 찾기
      const rule = vocab.rules[event.ruleId];
      if(!rule || !rule.weekdays || rule.weekdays.length === 0) {
        alert('이 시험에 대한 규칙을 찾을 수 없거나 요일 설정이 없습니다.');
        return;
      }

      // 현재 날짜에서 다음 예정 날짜 계산
      const currentDate = event.date;
      const nextDate = vocabNextByWeekdays(currentDate, rule.weekdays);

      if(!nextDate || nextDate === currentDate) {
        alert('다음 예정 날짜를 계산할 수 없습니다.');
        return;
      }

      const confirmMsg = `${escapeHTML(event.student)}의 단어시험을\n${formatDateKorean(currentDate)}에서 ${formatDateKorean(nextDate)}로 연기하시겠습니까?`;
      if(!confirm(confirmMsg)) return;

      // 이벤트 업데이트
      const updates = {
        date: nextDate,
        isRescheduled: true,
        originalDate: event.originalDate || currentDate // 이미 연기된 경우 원래 날짜 유지
      };

      db.ref(`vocab/events/${id}`).update(updates)
        .then(() => {
          alert(`${formatDateKorean(nextDate)}로 연기되었습니다.`);
        })
        .catch(err => {
          console.error('연기 실패:', err);
          alert('연기 중 오류가 발생했습니다.');
        });
    }

    // ---- Import/Export
    function vocabExport(){
      const data = JSON.stringify({books:vocab.books||{}, rules:vocab.rules||{}, events:vocab.events||{}}, null, 2);
      const blob = new Blob([data], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download='vocab_scheduler_backup.json';
      a.click();
      URL.revokeObjectURL(url);
    }
    function vocabImport(ev){
      const file = ev.target.files?.[0];
      if(!file) return;
      const fr = new FileReader();
      fr.onload = () => {
        try{
          const obj = JSON.parse(fr.result);
          if(!obj || obj.books===undefined || obj.rules===undefined || obj.events===undefined) throw new Error('형식 오류');
          const updates = {};
          // 전부 덮어쓰기
          updates['vocab/books'] = obj.books || {};
          updates['vocab/rules'] = obj.rules || {};
          updates['vocab/events'] = obj.events || {};
          db.ref().update(updates).then(()=> alert('불러오기 완료!'));
        }catch(e){ alert('불러오기 실패: '+e.message); }
      };
      fr.readAsText(file, 'utf-8');
    }

    // ---- Seed Demo
    function vocabSeedDemo(){
      if(!confirm('예시 규칙/교재를 추가할까요? (기존 데이터는 유지)')) return;
      // 교재 1개 없으면 생성
      const books = Object.entries(vocab.books||{});
      let bookId;
      if(books.length===0){
        const ref = db.ref('vocab/books');
        bookId = ref.push().key;
        const units = Array.from({length:60},(_,i)=>`Lesson ${i+1}`);
        ref.child(bookId).set({name:'고교기본', units});
      }else{
        bookId = books[0][0];
      }
      const rRef = db.ref('vocab/rules');
      const rid = rRef.push().key;
      const start = todayYMD();
      const rule = {
        student:'홍길동', teacher:'강민채', bookId,
        startRange:'1-3', unitSize:3, overlap:1, overlapMode:'end',
        weekdays:[1,5], startDate:start, maxUnit:30, occurrences:16
      };
      rRef.child(rid).set(rule).then(()=> vocabRegenForRule(rid,true));
      alert('예시 규칙 생성 완료 (월/금: 1–3 → 3–5 → 5–7 …)');
    }

    function vocabRenderAll(){
      vocabRenderToday(); vocabRenderUpcoming(); vocabRenderBooks(); vocabRenderRules();
      vocabPopulateBookSelect();
    }

    /* ===================== 📊 수학 보강 분석 ===================== */
    function analysisSwitchTab(name){
      const tabs = ['summary','students','timeline'];
      tabs.forEach(t=>{
        document.getElementById('analysisView'+t.charAt(0).toUpperCase()+t.slice(1)).classList.toggle('hidden', t!==name);
        document.getElementById('analysisTab'+t.charAt(0).toUpperCase()+t.slice(1)).classList.toggle('btn', t===name);
        document.getElementById('analysisTab'+t.charAt(0).toUpperCase()+t.slice(1)).classList.toggle('btn-secondary', t!==name);
      });
      if(name==='summary') renderAnalysisSummary();
      if(name==='students') renderAnalysisStudents();
      if(name==='timeline') renderAnalysisTimeline();
    }

    function renderAnalysis(){
      const currentTab = ['summary','students','timeline'].find(t =>
        !document.getElementById('analysisView'+t.charAt(0).toUpperCase()+t.slice(1)).classList.contains('hidden')
      );
      if(currentTab==='summary') renderAnalysisSummary();
      if(currentTab==='students') renderAnalysisStudents();
      if(currentTab==='timeline') renderAnalysisTimeline();
    }

    function renderAnalysisSummary(){
      const today = todayYMD();
      const subjectFilter = document.getElementById('analysisSubjectFilter').value;
      const all = Object.values(tutoringSessions||{});
      const filtered = subjectFilter === 'all' ? all : all.filter(s => s.subject === subjectFilter);
      const week7ago = addDays(today, -7);

      // 통계 계산
      const uniqueStudents = new Set(filtered.map(s=>s.name)).size;
      const totalSessions = filtered.length;
      const weekSessions = filtered.filter(s => s.date >= week7ago && s.date <= today).length;
      const todaySessions = filtered.filter(s => s.date === today).length;

      document.getElementById('analysisTotalStudents').textContent = uniqueStudents;
      document.getElementById('analysisTotalSessions').textContent = totalSessions;
      document.getElementById('analysisWeekSessions').textContent = weekSessions;
      document.getElementById('analysisTodaySessions').textContent = todaySessions;

      // TOP 5 학생
      const studentCounts = {};
      filtered.forEach(s => {
        studentCounts[s.name] = (studentCounts[s.name]||0) + 1;
      });
      const topStudents = Object.entries(studentCounts).sort((a,b)=>b[1]-a[1]).slice(0,5);
      document.getElementById('analysisTopStudents').innerHTML = topStudents.length
        ? topStudents.map(([name, count]) => `
            <div class="flex justify-between items-center py-1">
              <span class="font-medium">${escapeHTML(name)}</span>
              <span class="text-sm bg-blue-100 px-2 py-1 rounded">${count}회</span>
            </div>
          `).join('')
        : '<div class="text-gray-500">데이터 없음</div>';

      // TOP 5 주제
      const topicCounts = {};
      filtered.forEach(s => {
        if(s.topic) topicCounts[s.topic] = (topicCounts[s.topic]||0) + 1;
      });
      const topTopics = Object.entries(topicCounts).sort((a,b)=>b[1]-a[1]).slice(0,5);
      document.getElementById('analysisTopTopics').innerHTML = topTopics.length
        ? topTopics.map(([topic, count]) => `
            <div class="flex justify-between items-center py-1">
              <span class="font-medium">${escapeHTML(topic)}</span>
              <span class="text-sm bg-purple-100 px-2 py-1 rounded">${count}회</span>
            </div>
          `).join('')
        : '<div class="text-gray-500">데이터 없음</div>';
    }

    function renderAnalysisStudents(){
      const subjectFilter = document.getElementById('analysisSubjectFilter').value;
      const subjectLabel = {'math': '수학', 'english': '영어'};
      const all = Object.values(tutoringSessions||{});
      const filtered = subjectFilter === 'all' ? all : all.filter(s => s.subject === subjectFilter);
      const studentData = {};

      filtered.forEach(s => {
        if(!studentData[s.name]){
          studentData[s.name] = { sessions:[], topics:new Set(), subjects:new Set() };
        }
        studentData[s.name].sessions.push(s);
        if(s.topic) studentData[s.name].topics.add(s.topic);
        if(s.subject) studentData[s.name].subjects.add(s.subject);
      });

      const entries = Object.entries(studentData).sort((a,b)=>b[1].sessions.length-a[1].sessions.length);
      const box = document.getElementById('analysisStudentsList');

      if(entries.length===0){
        box.innerHTML = '<div class="text-gray-500">데이터가 없습니다.</div>';
        return;
      }

      box.innerHTML = entries.map(([name, data]) => {
        const recentSessions = data.sessions.sort((a,b)=>b.date.localeCompare(a.date)).slice(0,3);
        return `
          <div class="p-4 border rounded-lg bg-white">
            <div class="flex justify-between items-center mb-2">
              <div class="font-bold text-lg">${escapeHTML(name)}</div>
              <div class="text-sm bg-blue-100 px-3 py-1 rounded-full">총 ${data.sessions.length}회</div>
            </div>
            <div class="text-sm text-gray-600 mb-2">
              과목: ${data.subjects.size ? Array.from(data.subjects).map(s=>subjectLabel[s]||s).join(', ') : '없음'} |
              주요 주제: ${data.topics.size ? Array.from(data.topics).slice(0,3).map(t=>escapeHTML(t)).join(', ') : '없음'}
            </div>
            <div class="text-xs text-gray-500">
              <div class="font-semibold mb-1">최근 보강 내역:</div>
              ${recentSessions.map(s => `• [${subjectLabel[s.subject]||s.subject}] ${formatDateKorean(s.date)} ${s.time||''} - ${escapeHTML(s.topic||'주제 없음')} ${s.range?'('+escapeHTML(s.range)+')':''}`).join('<br>')}
            </div>
          </div>
        `;
      }).join('');
    }

    function renderAnalysisTimeline(){
      const today = todayYMD();
      const subjectFilter = document.getElementById('analysisSubjectFilter').value;
      const day30ago = addDays(today, -30);
      const all = Object.values(tutoringSessions||{});
      const filtered = (subjectFilter === 'all' ? all : all.filter(s => s.subject === subjectFilter))
        .filter(s => s.date >= day30ago && s.date <= today);

      // 날짜별 집계
      const dateCounts = {};
      filtered.forEach(s => {
        dateCounts[s.date] = (dateCounts[s.date]||0) + 1;
      });

      // 30일 날짜 배열 생성
      const dates = [];
      for(let i=30; i>=0; i--){
        dates.push(addDays(today, -i));
      }

      const maxCount = Math.max(...dates.map(d=>dateCounts[d]||0), 1);
      const box = document.getElementById('analysisTimelineChart');

      box.innerHTML = `
        <div class="space-y-1">
          ${dates.map(d => {
            const count = dateCounts[d] || 0;
            const width = (count / maxCount * 100);
            const isToday = d === today;
            return `
              <div class="flex items-center gap-2">
                <div class="text-xs w-20 ${isToday?'font-bold text-blue-600':'text-gray-500'}">${d.slice(5)}</div>
                <div class="flex-1 bg-gray-200 rounded-full h-6 overflow-hidden">
                  ${count > 0 ? `<div class="bg-blue-500 h-full flex items-center justify-end px-2 text-white text-xs font-semibold" style="width:${width}%">${count}</div>` : ''}
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;
    }

    /* ===================== 초기화 ===================== */
    window.addEventListener('load', () => {
      updateDateDisplay();
      attachListenersForDate();
      attachGlobalListenersOnce();
      const nt = document.getElementById('newTaskInput');
      if (nt) nt.addEventListener('keydown', (e) => { if (e.key === 'Enter') addNewTask(); });
      vocabSwitchTab('today');
      analysisSwitchTab('summary');
      switchMainTab(localStorage.getItem('mainTab') || 'work');
    });
  </script>
</body>
</html>
